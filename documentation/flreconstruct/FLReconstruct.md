Using The FLReconstruct Application {#usingflreconstruct}
===================================

\tableofcontents

Introduction to FLReconstruct {#usingflreconstruct_intro}
=============================

FLReconstruct's task is to read data  from an output file generated by
the SuperNEMO  simulation or detector, perform  reconstruction on each
event in the data, and write the reconstructed data to an output file.
It uses a pipeline architecture  for event processing, the pipeline is
constructed as a sequence of  "modules", the sequence of modules being
selected  by  the user  (i.e.  you)  at  runtime. Falaise  provides  a
standard set  of pipelines  and modules,  and you  can write  your own
custom pipeline  scripts and modules  which FLReconstruct can  load at
runtime via a plugin mechanism.

Here we  present a  brief overview of  running FLReconstruct  from the
command line  using the standard  pipeline scripts. The  more advanced
topics  of  scripting the  pipeline  and  writing custom  modules  are
covered   in  the   [Writing   FLReconstruct  Pipeline   Scripts](@ref writingflreconstructpipelinescripts)
and [Writing   FLReconstruct  Modules](@ref   writingflreconstructmodules)
tutorials.

Using FLReconstruct on the Command Line {#usingflreconstruct_commandline}
=======================================

The flreconstruct program is a  command line application just like any
other Unix style program (e.g. `ls`).  In the following, we will write
commands assuming that `flreconstruct` is in  your path. If it is not,
simply use the relative or absolute path to `flreconstruct`.

You can get help on the  options that can be passed to `flreconstruct`
by running it with the `-h` or `--help` options, e.g.

~~~~~
$ flreconstruct --help
flreconstruct (3.0.0) : SuperNEMO reconstruction program
Usage:
  flreconstruct [options]
Options:
  -h [ --help ]                        print this help message
  --help-module-list                   list available modules and exit
  --help-module name                   print help for a single module and exit
  --help-pipeline-list                 list available pipeline configurations
                                       and exit
  --version                            print version number
  -V [ --verbosity ] level             set the verbosity level
  -P [ --modulo ] period (=0)          progress modulo on number of events
  -u [ --user-profile ] name (=normal) set the user profile ("expert",
                                       "normal", "production")
  -M [ --input-metadata-file ] file    file from which to load metadata
  -m [ --output-metadata-file ] file   file in which to store metadata
  -E [ --embedded-metadata ] flag (=0) flag to (de)activate recording of
                                       metadata in the reconstruction results
                                       output file
  -p [ --pipeline ] file               pipeline script
  -i [ --input-file ] file             file from which to read input data
                                       (simulation, real)
  -o [ --output-file ] file            file in which to store reconstruction
                                       results

~~~~~

The `--version`  option provides  detailed information of  the current
status of the application, including which libraries it uses:

~~~~~
$ flreconstruct --version
flreconstruct 3.0.0

Copyright (C) 2013-2017 SuperNEMO Collaboration

flreconstruct uses the following external libraries:
* Falaise : 3.0.0
* Bayeux  : 3.0.0
* Boost   : 106000

~~~~~

The exact  versions you see will  depend on the version  you are using
and the versions of external packages linked.

To examine  a data  file output by  the `flsimulate`  application, you
need  to supply,  at minimum,  an input  file. By  default, this  will
simply dump  information on each  event held  in the file  to standard
output (i.e.  the  current terminal). For example, say we  have a file
`example.brio`, then we can dump events in that file by doing:

~~~~~
$ flreconstruct -i example.brio
flreconstruct::default:
`-- Bank 'SD' : "mctools::simulated_data"
    |-- Properties : <empty>
    |   `-- <no property>
    |-- Collection type : 1
    |-- Collections of step hit handles :
    |   |-- Category 'calo' has 2 hit(s) [capacity=2]
    |   `-- Category 'gg' has 31 hit(s) [capacity=31]
    |-- Primary event :
    |   |-- Auxiliary properties: <none>
    |   |-- Label : 'Se82.0nubb'
    |   |-- Time  : 0 s
    |   |-- Particles: [2]
    |   |   |-- Particle #0 :
    |   |   |   |-- Generation Id  : <none>
    |   |   |   |-- Type           : 3 (label='e-')
    |   |   |   |-- PDG code       : <none>
    |   |   |   |-- Mass           : 0.510999 MeV
    |   |   |   |-- Charge         : -1 e
    |   |   |   |-- Time           : 0 ns
    |   |   |   |-- Kinetic energy : 2.4231 MeV
    |   |   |   |-- Momentum       : (-0.903124,0.824222,2.6178) MeV
    |   |   |   |-- Vertex         : <no vertex>
    |   |   |   |-- Auxiliary properties: <none>
    |   |   |   `-- Valid          : 1
    |   |   `-- Particle #1 :
    |   |       |-- Generation Id  : <none>
    |   |       |-- Type           : 3 (label='e-')
    |   |       |-- PDG code       : <none>
    |   |       |-- Mass           : 0.510999 MeV
    |   |       |-- Charge         : -1 e
    |   |       |-- Time           : 0 ns
    |   |       |-- Kinetic energy : 0.571898 MeV
    |   |       |-- Momentum       : (-0.700223,-0.622764,-0.182756) MeV
    |   |       |-- Vertex         : <no vertex>
    |   |       |-- Auxiliary properties: <none>
    |   |       `-- Valid          : 1
    |   |-- GENBB weight : 1
    |   |-- Classification : '2e0p0g0a0X'
    |   `-- Valid: 1
    `-- Vertex : (-0.0440134,1597.93,40.6704) mm
... further events ...
$
~~~~~

To do more than just dump data, we need to supply `flreconstruct` with
a script to define what to do with the data.


Using Standard Pipelines {#usingflreconstruct_usingstandardpipelines}
========================

FLReconstruct  implements a  "pipeline" architecture  in which  events
flow through an ordered sequence  of "modules". Each module performs a
specific task on the event (e.g. count hits), writing its results into
the event for  further processing by downstream  modules. The sequence
of modules and their configuration  (e.g. algorithm parameters) in the
pipeline are constructed via a `datatools::multi_properties` script. A
set  of pipeline  scripts are  supplied with  Falaise by  the Analysis
Board to provide easy to use, validated reconstruction chains. These
are located under `snemo/demonstrator/reconstruction` in the resources
tree, with two available:

- `snemo/demonstrator/reconstruction/official-1.0.0.conf`
  - The "old" pipeline
- `snemo/demonstrator/reconstruction/official-2.0.0.conf`
  - Current "production" pipeline
- `snemo/demonstrator/reconstruction/production.pipeline.conf`
  - Synonym for the current production pipeline

The output  file generated  by `flreconstruct` using these pipelines may  be opened  and the
results  visualized  using  the [`flvisualize`  GUI  application](@ref usingflvisualize).
To run one of the standard pipelines, it is passed using the `-p` flag of
`flreconstruct` as follows:

~~~~~
$ flreconstruct -i example.brio -p @falaise:snemo/demonstrator/reconstruction/production.pipeline.conf
~~~~~

Here  `@falaise:`  is a shorthand for "the root directory of Falaise resources"
and can be viewed as a  "mount point" for standard resource files. The  subsequent
path is simply the  path from that root to  the standard  reconstruction script.

If the script  itself is officially tagged, one can  also use directly
its tag from the command line:

~~~~~
$ flreconstruct -i example.brio -p "urn:snemo:demonstrator:reconstruction:1.0.0"
~~~~~

Please note that this tagging scheme is in flux as it is integrated with
Conditions and other databases, and is subject to change.

Writing Reconstruction Results to File {#usingflreconstruct_usingoutputpaths}
======================================

To write `flreconstruct`'s results to  file (e.g. for later analysis),
the  `-o` option  may be  used  to write  processed events  to a  file
supplied as the  argument, with the output format chosen  based on the
file extension.

To output  to the  BRIO format recognised  by `flreconstruct`  use the
`.brio` extension:

~~~~~
$ flreconstruct -i example.brio -p myrecscript.conf -o results.brio
~~~~~

The resultant file may be examined  directly to see what data has been
written by simply passing it back to `flreconstruct`, e.g.

~~~~~
$ flreconstruct -i results.brio
... output ...
~~~~~

The resultant file may also  be further processed by `flreconstruct`  using a pipeline
constructed from your own analysis modules. Please see the document on
[FLReconstruct Pipeline  Output](@ref flreconstructpipelineoutput) for
details  of  the data  structures  stored  for each  processed  event.
Further        documents         are        available        detailing
[how    to    write   your    reconstruction/analysis    modules](@ref writingflreconstructmodules),
and [how to access event data from modules](@ref workingwitheventrecords).

Output to  ROOT format is  also possible  by supplying an  output file
with the `.root` extension:

~~~~~
$ flreconstruct -i example.brio -p myrecscript.conf -o results.root
~~~~~

The resultant file  contains a single flat `TTree`  structure that may
be browsed interactively. Note that currently this format only outputs
simulated and calibrated data, with no further reconstruction results.
A separate [converter program  is available](@ref usingflptd2root) for
running  full  conversion,  and  will  be  gradually  integrated  into
flreconstruct for direct conversion.



Using Custom Pipelines {#usingflreconstruct_usingcustompipelines}
======================

The standard  pipelines provided  by Falaise are  intended to  cover a
wide range of  use cases for standard reconstruction  tasks leading to
analyses.   However,  if  you  need   to  study  improvements  to  the
reconstruction via  tuning existing  modules or  adding new  ones then
custom  pipeline   scripts  and modules can   be  used  in   `flreconstruct`.  The
[Writing FLReconstruct Pipeline Scripts](@ref writingflreconstructpipelinescripts)  tutorial covers  the syntax  and
structure of custom pipeline scripts.




