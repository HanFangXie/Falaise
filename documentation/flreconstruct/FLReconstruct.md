Using The FLReconstruct Application {#usingflreconstruct}
===================================

\tableofcontents

Introduction {#intro}
============
FLReconstruct's task is to read data from an output file generated by
the SuperNEMO simulation or detector, perform reconstruction on each event
in the data, and write the reconstructed data to and output file.
It uses a pipeline architecture for event processing, the pipeline
is constructed as a sequence of "modules", the sequence of modules being
selected by the user (i.e. you) at runtime. Falaise provides a standard
set of pipelines and modules, and you can write your own custom pipeline
scripts and modules which FLReconstruct can load at runtime via a plugin
mechanism.

Here we present a brief overview of running FLReconstruct from the
command line using the standard pipeline scripts. The more advanced topics
of scripting the pipeline and writing custom modules are covered in the
[Writing FLReconstruct Pipeline Scripts](@ref writingflreconstructpipelinescripts) and [Writing FLReconstruct Modules](@ref writingflreconstructmodules)
tutorials.

Example Usage {#examples}
=============
The flreconstruct program is a command line application just like any
other Unix style program (e.g. `ls`). In the following, we will
write commands assuming that `flreconstruct` is in your path. If is not,
simply use the relative or absolute path to `flreconstruct`.

You can get help on the options that can be passed to `flreconstruct`
by running it with the `-h` or `--help` options, e.g.

~~~~~
$ flreconstruct --help
flreconstruct 1.0.0
Usage:
  flreconstruct [options]
Options
  -h [ --help ]                 print this help message
  --help-module-list            list available modules and exit
  --help-module [mod]           print help for a single module and exit
  --version                     print version number
  -v [ --verbose ] [level] (=1) set verbosity level of logging
  -i [ --input-file ] [file]    file from which to read data
  -o [ --output-file ] [file]   file to which to write data
  -p [ --pipeline ] [file]      run pipeline script or resource

$
~~~~~

The `--version` option provides detailed information of the current
status of the application, including which libraries it uses:

~~~~~
$ flreconstruct --version
flreconstruct 1.0.0

Copyright (C) 2013-2014 SuperNEMO Collaboration

flreconstruct uses the following external libraries:
* Falaise : 1.0.0
* Bayeux  : 1.0.0
* Boost   : 105500

$
~~~~~

To examine a data file output by the `flsimulate` application, you
need to supply, at minimum, an input file. By default, this will simply
dump information on each event held in the file to standard output (i.e.
the current terminal). For example, say we have a file `example.brio`,
then we can dump events in that file by doing:

~~~~~
$ flreconstruct -i example.brio
[warning:void dpp::module_manager::initialize(const datatools::properties&):232] There is no 'service_manager.configuration' configuration property ! So we won't use an embedded service manager. For now, this is not a issue.
[warning:void dpp::module_manager::initialize(const datatools::properties&):249] No service manager is available ! This will forbid the use of some processing modules that need to access to some specific external services. This depends on your pipeline setup. For now, we continue without a service manager.
Reader configuration parameters:
|-- Name : "files.mode"
|   |-- Type  : string (scalar)
|   `-- Value : "single"
`-- Name : "files.single.filename"
    |-- Type  : string (scalar)
    `-- Value : "test.brio"
flreconstruct::default:
`-- Bank 'SD' : "mctools::simulated_data"
    |-- Properties : <empty>
    |   `-- <no property>
    |-- Collection type : 1
    |-- Collections of step hit handles :
    |   `-- Category '__visu.tracks' has 51 hit(s) [capacity=51]
    |-- Primary event :
    |   |-- Valid: 1
    |   |-- Label : ''
    |   |-- Time  : 0 s
    |   |-- Particles: [1]
    |   |   `-- Particle #0 :
    |   |       |-- Type           : 6 (mu-)
    |   |       |-- Particle label : 'mu-'
    |   |       |-- Time           : 0 ns
    |   |       |-- Kinetic energy : 4416.76 MeV
    |   |       |-- Momentum       : (-514.889,-36.7927,-4491.62) MeV
    |   |       `-- Vertex         : <no vertex>
    |   |-- GENBB weight : 1
    |   `-- Classification : '0e0p0g0a1X'
    `-- Vertex : (-979.688,2721.36,1000) mm

... further events ...
$
~~~~~


Using Standard Pipelines {#usingstandardpipelines}
========================
FLReconstruct implements a "pipeline" architecture in which events flow
through an ordered sequence of "modules". Each module performs a specific
task on the event (e.g. count hits), writing its results into the event
for further processing by downstream modules. The sequence of modules
and their configuration (e.g. algorithm parameters) in the pipeline
are constructed via a `datatools::multi_properties` script. A set of
pipeline scripts are supplied with Falaise by the Software Board
to provide easy to use, validated reconstruction chains.

The available pipelines can be viewed by passing the `--help-pipeline-list`
argument to `flreconstruct`. This will print a tree of the available pipelines:

~~~~~
$ flreconstruct --help-pipeline-list
@falaise:pipeline
 +-"snemo.demonstrator"
   +-"1.0.0"
   +-"1.0.0.visual"
$
~~~~~

This pipeline can be passed to `flreconstruct` via the `-p` argument using
the "resource path" notation:

~~~~~
$ flreconstruct -i example.brio -p @falaise:pipeline/snemo.demonstrator/1.0.0
~~~~~

Here `@falaise:` means "the root directory of Falaise resources" and can
be viewed as a "mount point" for the resources. The subsequent path is
simply the path from that root to the relevant file.

Using Custom Pipelines {#usingcustompipelines}
========================
The standard pipelines provided by Falaise are intended to cover a wide
range of use cases for standard reconstruction tasks leading to analyses.
However, if you need to study improvements to the reconstruction via tuning
existing modules or adding new ones then custom pipeline scripts can be
used in `flreconstruct`. The
[Writing FLReconstruct Pipeline Scripts](@ref writingflreconstructpipelinescripts) tutorial covers the syntax and structure of custom pipeline scripts.

