Using The FLReconstruct Application {#usingflreconstruct}
===================================

\tableofcontents

Introduction {#intro}
============
FLReconstruct's task is to read data from an output file generated by
the SuperNEMO simulation or detector, perform reconstruction on each event
in the data, and write the reconstructed data to and output file.
It uses a pipeline architecture for event processing, the pipeline
is constructed as a sequence of "modules", the sequence of modules being
selected by the user (i.e. you) at runtime. Falaise provides a standard
set of pipelines and modules, and you can write your own custom pipeline
scripts and modules which FLReconstruct can load at runtime via a plugin
mechanism.

Here we present a brief overview of running FLReconstruct from the
command line using the standard pipeline scripts. The more advanced topics
of scripting the pipeline and writing custom modules are covered in the
[Writing FLReconstruct Pipeline Scripts](@ref writingflreconstructpipelinescripts) and [Writing FLReconstruct Modules](@ref writingflreconstructmodules)
tutorials.

Example Usage {#examples}
=============
The flreconstruct program is a command line application just like any
other Unix style program (e.g. `ls`). In the following, we will
write commands assuming that `flreconstruct` is in your path. If is not,
simply use the relative or absolute path to `flreconstruct`.

You can get help on the options that can be passed to `flreconstruct`
by running it with the `-h` or `--help` options, e.g.

~~~~~
$ flreconstruct --help
flreconstruct 1.0.0
Usage:
  flreconstruct [options]
Options
  -h [ --help ]                 print this help message
  --help-module-list            list available modules and exit
  --help-module [mod]           print help for a single module and exit
  --help-pipeline-list          list available pipeline configurations and exit
  --version                     print version number
  -v [ --verbose ] [level] (=1) set verbosity level of logging
  -i [ --input-file ] [file]    file from which to read data
  -o [ --output-file ] [file]   file to which to write data
  -p [ --pipeline ] [file]      run pipeline script or resource

$
~~~~~

The `--version` option provides detailed information of the current
status of the application, including which libraries it uses:

~~~~~
$ flreconstruct --version
flreconstruct 1.0.0

Copyright (C) 2013-2014 SuperNEMO Collaboration

flreconstruct uses the following external libraries:
* Falaise : 1.0.0
* Bayeux  : 1.0.0
* Boost   : 105500

$
~~~~~

To examine a data file output by the `flsimulate` application, you
need to supply, at minimum, an input file. By default, this will simply
dump information on each event held in the file to standard output (i.e.
the current terminal). For example, say we have a file `example.brio`,
then we can dump events in that file by doing:

~~~~~
$ flreconstruct -i example.brio
[warning:void dpp::module_manager::initialize(const datatools::properties&):232] There is no 'service_manager.configuration' configuration property ! So we won't use an embedded service manager. For now, this is not a issue.
[warning:void dpp::module_manager::initialize(const datatools::properties&):249] No service manager is available ! This will forbid the use of some processing modules that need to access to some specific external services. This depends on your pipeline setup. For now, we continue without a service manager.
Reader configuration parameters:
|-- Name : "files.mode"
|   |-- Type  : string (scalar)
|   `-- Value : "single"
`-- Name : "files.single.filename"
    |-- Type  : string (scalar)
    `-- Value : "test.brio"
flreconstruct::default:
`-- Bank 'SD' : "mctools::simulated_data"
    |-- Properties : <empty>
    |   `-- <no property>
    |-- Collection type : 1
    |-- Collections of step hit handles :
    |   `-- Category '__visu.tracks' has 51 hit(s) [capacity=51]
    |-- Primary event :
    |   |-- Valid: 1
    |   |-- Label : ''
    |   |-- Time  : 0 s
    |   |-- Particles: [1]
    |   |   `-- Particle #0 :
    |   |       |-- Type           : 6 (mu-)
    |   |       |-- Particle label : 'mu-'
    |   |       |-- Time           : 0 ns
    |   |       |-- Kinetic energy : 4416.76 MeV
    |   |       |-- Momentum       : (-514.889,-36.7927,-4491.62) MeV
    |   |       `-- Vertex         : <no vertex>
    |   |-- GENBB weight : 1
    |   `-- Classification : '0e0p0g0a1X'
    `-- Vertex : (-979.688,2721.36,1000) mm

... further events ...
$
~~~~~


Using Standard Pipelines {#usingstandardpipelines}
========================
FLReconstruct implements a "pipeline" architecture in which events flow
through an ordered sequence of "modules". Each module performs a specific
task on the event (e.g. count hits), writing its results into the event
for further processing by downstream modules. The sequence of modules
and their configuration (e.g. algorithm parameters) in the pipeline
are constructed via a `datatools::multi_properties` script. A set of
pipeline scripts are supplied with Falaise by the Software Board
to provide easy to use, validated reconstruction chains.

The available pipelines can be viewed by passing the `--help-pipeline-list`
argument to `flreconstruct`. This will print a tree of the available
pipelines

~~~~~
$ flreconstruct --help-pipeline-list
@falaise:pipeline
 +-"snemo.demonstrator"
   +-"1.0.0"
   +-"1.0.0.visual"
$
~~~~~

Standard pipeline scripts are organised into directories based on the
experiment they apply to, and should only be used for reconstructing
data from these experiments. Note that `flreconstruct` does not validate
that a pipeline script can be applied to the input data. Scripts for
each experiments are tagged with a version and optional visualization tag.
You should always regard the highest version tag as the current approved
script to use for production.
The visualization tag adds a final GNUPlot based visualization of each
event after pipeline processing, so can be used to view events and
the results of reconstruction. Visualization enabled scripts should not
be used for production purposes due to their interactive nature.

Built in pipelines can be run in `flreconstruct` by passing with the `-p`
argument using the "resource path" notation:

~~~~~
$ flreconstruct -i example.brio -p @falaise:pipeline/snemo.demonstrator/1.0.0
~~~~~

Here `@falaise:` is simply shorthand for "the root directory of standard
Falaise resources" and can be viewed as a "mount point" for standard
resources. The subsequent path is simply the path from that root to a
standard pipeline script. This path can be derived from the information
output by the `--help-pipeline-list` argument described above.


Writing Reconstruction Results to File {#usingoutputpaths}
======================================
Running `flreconstruct` as presented above will process data but not
persist any reconstruction results to file (e.g. for later analysis).
To write results to file, the `-o` option may be used to write processed
events to a file supplied as the argument, with the output format chosen
based on the file extension.

To output to the BRIO format recognised by `flreconstruct` use the `.brio`
extension:

~~~~~
$ flreconstruct -i example.brio -p @falaise:pipeline/snemo.demonstrator/1.0.0 -o results.brio
~~~~~

The resultant file may be subsequently passed through
`flreconstruct` with a pipeline constructed from your own analysis
modules. Please see the document on [FLReconstruct Pipeline Output](@ref flreconstructpipelineoutput)
for details of the data structures stored for each processed event.
Further documents are available detailing [how to write your reconstruction/analysis modules](@ref writingflreconstructmodules), and
[how to access event data from modules](@ref workingwitheventrecords).

Output to ROOT format is also possible by supplying an output file with
the `.root` extension:

~~~~~
$ flreconstruct -i example.brio -p @falaise:pipeline/snemo.demonstrator/1.0.0 -o results.root
~~~~~

The resultant file contains a single flat `TTree` structure that may be
browsed interactively. Note that currently this format only outputs
simulated and calibrated data, with no further reconstruction results.
Work is in progress to extend this format to supply all data structures.


Using Custom Pipelines {#usingcustompipelines}
========================
The standard pipelines provided by Falaise are intended to cover a wide
range of use cases for standard reconstruction tasks leading to analyses.
However, if you need to study improvements to the reconstruction via tuning
existing modules or adding new ones then custom pipeline scripts can be
used in `flreconstruct`. The
[Writing FLReconstruct Pipeline Scripts](@ref writingflreconstructpipelinescripts) tutorial covers the syntax and structure of custom pipeline scripts.

