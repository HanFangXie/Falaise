<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Falaise: Using The FLReconstruct Application</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Falaise
   &#160;<span id="projectnumber">3.0.0</span>
   </div>
   <div id="projectbrief">SuperNEMO Software Toolkit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Using The FLReconstruct Application </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#usingflreconstruct_intro">Introduction to FLReconstruct </a></li>
<li class="level1"><a href="#usingflreconstruct_commandline">Using FLReconstruct on the Command Line </a></li>
<li class="level1"><a href="#usingflreconstruct_quickstart">Quick start </a></li>
<li class="level1"><a href="#usingflreconstruct_scriptingflsimulate">Scripting FLReconstruct </a><ul><li class="level2"><a href="#usingflreconstruct_scriptingflsimulate_format">Script&#39;s format </a></li>
<li class="level2"><a href="#usingflreconstruct_mockcalibalgo">How to run a mock calibration on simulated events </a></li>
<li class="level2"><a href="#usingflreconstruct_trackfitalgo">How to run a tracking algorithm on simulated events </a></li>
<li class="level2"><a href="#usingflreconstruct_todo">To do </a></li>
<li class="level2"><a href="#usingflreconstruct_scriptingflsimulate_sectionsandparameters">Script&#39;s supported sections and parameters </a></li>
<li class="level2"><a href="#usingflreconstruct_scriptingflsimulate_inlinemodules">Inline modules </a></li>
</ul>
</li>
<li class="level1"><a href="#usingflreconstruct_usingstandardpipelines">Using Standard Pipelines </a></li>
<li class="level1"><a href="#usingflreconstruct_usingoutputpaths">Writing Reconstruction Results to File </a></li>
<li class="level1"><a href="#usingflreconstruct_usingcustompipelines">Using Custom Pipelines </a></li>
<li class="level1"><a href="#usingflreconstruct_example">Example </a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="usingflreconstruct_intro"></a>
Introduction to FLReconstruct </h1>
<p>FLReconstruct's task is to read data from an output file generated by the SuperNEMO simulation or detector, perform reconstruction on each event in the data, and write the reconstructed data to an output file. It uses a pipeline architecture for event processing, the pipeline is constructed as a sequence of "modules", the sequence of modules being selected by the user (i.e. you) at runtime. Falaise provides a standard set of pipelines and modules, and you can write your own custom pipeline scripts and modules which FLReconstruct can load at runtime via a plugin mechanism.</p>
<p>Here we present a brief overview of running FLReconstruct from the command line using the standard pipeline scripts. The more advanced topics of scripting the pipeline and writing custom modules are covered in the [Writing FLReconstruct Pipeline Scripts](<a class="el" href="writingflreconstructpipelinescripts.html">Writing FLReconstruct Pipeline Scripts</a>) and <a class="el" href="writingflreconstructmodules.html">Writing FLReconstruct Modules</a> tutorials.</p>
<h1><a class="anchor" id="usingflreconstruct_commandline"></a>
Using FLReconstruct on the Command Line </h1>
<p>The flreconstruct program is a command line application just like any other Unix style program (e.g. <code>ls</code>). In the following, we will write commands assuming that <code>flreconstruct</code> is in your path. If it is not, simply use the relative or absolute path to <code>flreconstruct</code>.</p>
<p>You can get help on the options that can be passed to <code>flreconstruct</code> by running it with the <code>-h</code> or <code>--help</code> options, e.g.</p>
<div class="fragment"><div class="line">$ flreconstruct --help</div><div class="line">flreconstruct (3.0.0) : SuperNEMO reconstruction program</div><div class="line">Usage:</div><div class="line">  flreconstruct [options]</div><div class="line">Options:</div><div class="line">  -h [ --help ]                        print this help message</div><div class="line">  --help-module-list                   list available modules and exit</div><div class="line">  --help-module name                   print help for a single module and exit</div><div class="line">  --help-pipeline-list                 list available pipeline configurations</div><div class="line">                                       and exit</div><div class="line">  --version                            print version number</div><div class="line">  -V [ --verbosity ] level             set the verbosity level</div><div class="line">  -P [ --modulo ] period (=0)          progress modulo on number of events</div><div class="line">  -u [ --user-profile ] name (=normal) set the user profile (&quot;expert&quot;,</div><div class="line">                                       &quot;normal&quot;, &quot;production&quot;)</div><div class="line">  -M [ --input-metadata-file ] file    file from which to load metadata</div><div class="line">  -m [ --output-metadata-file ] file   file in which to store metadata</div><div class="line">  -E [ --embedded-metadata ] flag (=0) flag to (de)activate recording of</div><div class="line">                                       metadata in the reconstruction results</div><div class="line">                                       output file</div><div class="line">  -p [ --pipeline ] file               pipeline script</div><div class="line">  -i [ --input-file ] file             file from which to read input data</div><div class="line">                                       (simulation, real)</div><div class="line">  -o [ --output-file ] file            file in which to store reconstruction</div><div class="line">                                       results</div></div><!-- fragment --><p>The <code>--version</code> option provides detailed information of the current status of the application, including which libraries it uses:</p>
<div class="fragment"><div class="line">$ flreconstruct --version</div><div class="line">flreconstruct 3.0.0</div><div class="line"></div><div class="line">Copyright (C) 2013-2017 SuperNEMO Collaboration</div><div class="line"></div><div class="line">flreconstruct uses the following external libraries:</div><div class="line">* Falaise : 3.0.0</div><div class="line">* Bayeux  : 3.0.0</div><div class="line">* Boost   : 106000</div></div><!-- fragment --><p>The exact versions you see will depend on the version you are using and the versions of external packages linked.</p>
<p>To examine a data file output by the <code>flsimulate</code> application, you need to supply, at minimum, an input file. By default, this will simply dump information on each event held in the file to standard output (i.e. the current terminal). For example, say we have a file <code>example.brio</code>, then we can dump events in that file by doing:</p>
<div class="fragment"><div class="line">$ flreconstruct -i example.brio</div><div class="line">flreconstruct::default:</div><div class="line">`-- Bank &#39;SD&#39; : &quot;mctools::simulated_data&quot;</div><div class="line">    |-- Properties : &lt;empty&gt;</div><div class="line">    |   `-- &lt;no property&gt;</div><div class="line">    |-- Collection type : 1</div><div class="line">    |-- Collections of step hit handles :</div><div class="line">    |   |-- Category &#39;calo&#39; has 2 hit(s) [capacity=2]</div><div class="line">    |   `-- Category &#39;gg&#39; has 31 hit(s) [capacity=31]</div><div class="line">    |-- Primary event :</div><div class="line">    |   |-- Auxiliary properties: &lt;none&gt;</div><div class="line">    |   |-- Label : &#39;Se82.0nubb&#39;</div><div class="line">    |   |-- Time  : 0 s</div><div class="line">    |   |-- Particles: [2]</div><div class="line">    |   |   |-- Particle #0 :</div><div class="line">    |   |   |   |-- Generation Id  : &lt;none&gt;</div><div class="line">    |   |   |   |-- Type           : 3 (label=&#39;e-&#39;)</div><div class="line">    |   |   |   |-- PDG code       : &lt;none&gt;</div><div class="line">    |   |   |   |-- Mass           : 0.510999 MeV</div><div class="line">    |   |   |   |-- Charge         : -1 e</div><div class="line">    |   |   |   |-- Time           : 0 ns</div><div class="line">    |   |   |   |-- Kinetic energy : 2.4231 MeV</div><div class="line">    |   |   |   |-- Momentum       : (-0.903124,0.824222,2.6178) MeV</div><div class="line">    |   |   |   |-- Vertex         : &lt;no vertex&gt;</div><div class="line">    |   |   |   |-- Auxiliary properties: &lt;none&gt;</div><div class="line">    |   |   |   `-- Valid          : 1</div><div class="line">    |   |   `-- Particle #1 :</div><div class="line">    |   |       |-- Generation Id  : &lt;none&gt;</div><div class="line">    |   |       |-- Type           : 3 (label=&#39;e-&#39;)</div><div class="line">    |   |       |-- PDG code       : &lt;none&gt;</div><div class="line">    |   |       |-- Mass           : 0.510999 MeV</div><div class="line">    |   |       |-- Charge         : -1 e</div><div class="line">    |   |       |-- Time           : 0 ns</div><div class="line">    |   |       |-- Kinetic energy : 0.571898 MeV</div><div class="line">    |   |       |-- Momentum       : (-0.700223,-0.622764,-0.182756) MeV</div><div class="line">    |   |       |-- Vertex         : &lt;no vertex&gt;</div><div class="line">    |   |       |-- Auxiliary properties: &lt;none&gt;</div><div class="line">    |   |       `-- Valid          : 1</div><div class="line">    |   |-- GENBB weight : 1</div><div class="line">    |   |-- Classification : &#39;2e0p0g0a0X&#39;</div><div class="line">    |   `-- Valid: 1</div><div class="line">    `-- Vertex : (-0.0440134,1597.93,40.6704) mm</div><div class="line">... further events ...</div><div class="line">$</div></div><!-- fragment --><h1><a class="anchor" id="usingflreconstruct_quickstart"></a>
Quick start </h1>
<p>Here we propose to run FLReconstruct with the default setup. Only an input simulation file is set from the command line.</p>
<p>We first generate a single simulated event, using the default simulation setup, and store it in an output file:</p>
<div class="fragment"><div class="line">$ flsimulate -o example.xml</div><div class="line">...</div></div><!-- fragment --><p>Then we process this file with a default pipeline:</p>
<div class="fragment"><div class="line">$ flreconstruct -i example.xml</div></div><!-- fragment --><p>The output on the terminal is: </p><div class="fragment"><div class="line">flreconstruct::default:</div><div class="line">`-- Bank &#39;SD&#39; : &quot;mctools::simulated_data&quot;</div><div class="line">    |-- Properties : &lt;empty&gt;</div><div class="line">    |   `-- &lt;no property&gt;</div><div class="line">    |-- Collection type : 1</div><div class="line">    |-- Collections of step hit handles :</div><div class="line">    |   |-- Category &#39;calo&#39; has 2 hit(s) [capacity=2]</div><div class="line">    |   `-- Category &#39;gg&#39; has 27 hit(s) [capacity=27]</div><div class="line">    |-- Primary event :</div><div class="line">    |   |-- Auxiliary properties: &lt;none&gt;</div><div class="line">    |   |-- Label : &#39;Se82.0nubb&#39;</div><div class="line">    |   |-- Time  : 0 ns</div><div class="line">    |   |-- Vertex  : &lt;none&gt;</div><div class="line">    |   |-- Particles: [2]</div><div class="line">    |   |   |-- Particle #0 :</div><div class="line">    |   |   |   |-- Generation Id  : &lt;none&gt;</div><div class="line">    |   |   |   |-- Type           : 3 (label=&#39;e-&#39;)</div><div class="line">    |   |   |   |-- PDG code       : &lt;none&gt;</div><div class="line">    |   |   |   |-- Mass           : 0.510999 MeV</div><div class="line">    |   |   |   |-- Charge         : -1 e</div><div class="line">    |   |   |   |-- Time           : 0 ns</div><div class="line">    |   |   |   |-- Kinetic energy : 2.03412 MeV</div><div class="line">    |   |   |   |-- Momentum       : (0.780969,2.36733,0.0484636) MeV</div><div class="line">    |   |   |   |-- Vertex         : &lt;no vertex&gt;</div><div class="line">    |   |   |   |-- Auxiliary properties: &lt;none&gt;</div><div class="line">    |   |   |   `-- Valid          : 1</div><div class="line">    |   |   `-- Particle #1 :</div><div class="line">    |   |       |-- Generation Id  : &lt;none&gt;</div><div class="line">    |   |       |-- Type           : 3 (label=&#39;e-&#39;)</div><div class="line">    |   |       |-- PDG code       : &lt;none&gt;</div><div class="line">    |   |       |-- Mass           : 0.510999 MeV</div><div class="line">    |   |       |-- Charge         : -1 e</div><div class="line">    |   |       |-- Time           : 0 ns</div><div class="line">    |   |       |-- Kinetic energy : 0.960875 MeV</div><div class="line">    |   |       |-- Momentum       : (1.3576,0.0410453,-0.246035) MeV</div><div class="line">    |   |       |-- Vertex         : &lt;no vertex&gt;</div><div class="line">    |   |       |-- Auxiliary properties: &lt;none&gt;</div><div class="line">    |   |       `-- Valid          : 1</div><div class="line">    |   |-- GENBB weight : 1</div><div class="line">    |   |-- Classification : &#39;2e0p0g0a0X&#39;</div><div class="line">    |   `-- Valid: 1</div><div class="line">    |-- Time : &lt;none&gt;</div><div class="line">    `-- Vertex : (-0.0683336,-966.449,-773.204) mm</div></div><!-- fragment --><p>As we can see, the default behaviour of FLReconstruct is to print the contents of the event record(s) in the standard output. We can thus identify the simulated event record with its <code>SD</code> bank (<em>simulated data</em>) which contains the informations about the generated primary event, the original vertex and some collections of truth hits (here in the <code>calo</code> and <code>gg</code> hit categories).</p>
<h1><a class="anchor" id="usingflreconstruct_scriptingflsimulate"></a>
Scripting FLReconstruct </h1>
<p>FLReconstruct basically runs the simulation in batch mode. Practically, a <em>configuration script</em> must be provided by the user.</p>
<h2><a class="anchor" id="usingflreconstruct_scriptingflsimulate_format"></a>
Script's format </h2>
<p>The script uses the Bayeux's <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1multi__properties.html">datatools::multi_properties</a></code> format. The script contains a mandatory header:</p>
<div class="fragment"><div class="line">#@description a short description of the reconstruction run</div><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div></div><!-- fragment --><p>The '<code>#@description</code>' line is optional but highly recommended.</p>
<p>You may add comments at any place in the script. Just prepend a sharp ('<code>#</code>') symbol to any comment line: You may also prepend a comment at the end of a line. Examples:</p>
<div class="fragment"><div class="line"># This is a single commented line</div><div class="line"></div><div class="line">{...some script command...} # Comment starts at the end of the line</div><div class="line"></div><div class="line"># This is</div><div class="line"># a commented</div><div class="line"># block</div></div><!-- fragment --><p>Note that lines starting with `'#@`' are generally special meta-comments with embedded commands. They should not be considered as comments. As a matter of rule, the use of lines starting with '<code>#@</code>' is reserved for system use.</p>
<p>After the header, the script contains <em>sections</em>. A section starts with a section definition line with two identifiers:</p>
<ul>
<li>the <em>name</em> of the section,</li>
<li>the <em>type</em> of the section (here it must be <code>"flreconstruct::section"</code>).</li>
</ul>
<p>The syntax is: </p><div class="fragment"><div class="line">[name=&quot;SectionName&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line"></div><div class="line">... section&#39;s body ...</div></div><!-- fragment --><p>The section's body uses the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1properties.html">datatools::properties</a></code> format. After the definition line, a short description may be optionally provided thanks to the '<code>#@config</code>' meta-comment:</p>
<div class="fragment"><div class="line">#@config a short description of the purpose of the section</div></div><!-- fragment --><p>Then comes the section's body which consists in a list of parameter setting directives. The format is:</p>
<div class="fragment"><div class="line">#@description a short description of the parameter</div><div class="line">NAME : TYPE [DECORATOR] = VALUE</div></div><!-- fragment --><p>where <code>NAME</code> is the parameter's name, <code>TYPE</code> its type and <code>VALUE</code> the selected value for this parameter. Some parameters may use an optional <code>DECORATOR</code> which gives additional informations about the parameter's type or processing. Again, the <code>#@description</code> line is optional, but recommended. Example: </p><div class="fragment"><div class="line">#@description The number of events to be processed</div><div class="line">numberOfEvents : integer = 10000</div></div><!-- fragment --><h2><a class="anchor" id="usingflreconstruct_mockcalibalgo"></a>
How to run a mock calibration on simulated events </h2>
<p>When we generate simulated events with FLSimulate, the so-called <code>SD</code> bank contains only raw informations about truth calorimeter and tracker hits. In order to be able to reconstruct and analyze the events, we must apply a calibration procedure. This calibration procedure consist in determining physics/geometrical observables associated to hits : deposited energy, particle's times of flight, hit positions in the geometry model...</p>
<p>The so-called <em>mock calibration</em> consists in using dedicated algorithms which are able to compute the <em>calibrated data</em> associated to raw <em>simulated data</em>.</p>
<div class="image">
<img src="flr_mock_calib.png" alt="flr_mock_calib.png"/>
<div class="caption">
Mock calibration algorithms applied to simulated events</div></div>
<p> Practically the mock calibration consists in:</p><ul>
<li>for tracker hits: compute the drift radius and longitudinal position along the anode wire of the Geiger avalanche (and associated uncertainties).</li>
<li>for calorimeter hits: compute the total energy deposit in the scintillator block and the reference time when the particles first interacted with the block (and associated uncertainties). A new <code>CD</code> bank is added in the event record, besides the original <code>SD</code> bank.</li>
</ul>
<p>Let's now play with these tools ! First we prepare a set of 10 simulated events (using the default simulation setup), through the following <code>simu.conf</code> script for FLSimulate: </p><div class="fragment"><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;flsimulate&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">numberOfEvents : integer = 10</div></div><!-- fragment --><p>and run: </p><div class="fragment"><div class="line">$ flsimulate -c simu.conf -o example.brio</div><div class="line">...</div></div><!-- fragment --><p>Running the visualization, we can display the first event where we can see plenty of raw truth Geiger hits and one single calorimeter hit, as well as the position of the decay vertex (purple cross on the source foil):</p>
<div class="image">
<img src="flr_qs_sd_event.png" alt="flr_qs_sd_event.png"/>
<div class="caption">
A simulated event</div></div>
<p>Then we create the <code>rec.conf</code> script with a custom <code>pipeline</code> inline module made of three consecutive modules. The first one is responsible of the calibration of the tracker hits. The second one is responsible of the calibration of the calorimeter hits. The last one simply prints the content of the events in the standard output (not to be used in production of course):</p>
<div class="fragment"><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;pipeline&quot; type=&quot;dpp::chain_module&quot;]</div><div class="line">modules : string[3] = &quot;CalibrateTracker&quot; &quot;CalibrateCalorimeters&quot; &quot;Dump&quot;</div><div class="line"></div><div class="line">[name=&quot;CalibrateTracker&quot; type=&quot;snemo::processing::mock_tracker_s2c_module&quot;]</div><div class="line"></div><div class="line">[name=&quot;CalibrateCalorimeters&quot; type=&quot;snemo::processing::mock_calorimeter_s2c_module&quot;]</div><div class="line"></div><div class="line">[name=&quot;Dump&quot; type=&quot;dpp::dump_module&quot;]</div></div><!-- fragment --><p>We use default settings for each of the <code>CalibrateTracker</code>, <code>CalibrateCalorimeters</code> and <code>Dump</code> modules so the corresponding sections are empty.</p>
<p>We then run: </p><div class="fragment"><div class="line">$ flreconstruct -i example.brio -p rec.conf -o example-cd.xml</div><div class="line">...</div></div><!-- fragment --><p>The use of the <code>Dump</code> module prints the events in the terminal. Here is the first event: </p><div class="fragment"><div class="line">|-- Bank &#39;CD&#39; : &quot;snemo::datamodel::calibrated_data&quot;</div><div class="line">|   |-- Properties : &lt;empty&gt;</div><div class="line">|   |   `-- &lt;no property&gt;</div><div class="line">|   |-- Calibrated calorimeter hits: 1</div><div class="line">|   |   `-- Hit #0 : Id=0 GID=[1302:0.1.16.6.*] E=1027.5 keV t=2.10165 ns</div><div class="line">|   `-- Calibrated tracker hits: 23</div><div class="line">|       |-- Hit #0 : Id=0 GID=[1204:0.1.0.95] [prompt]</div><div class="line">|       |-- Hit #1 : Id=1 GID=[1204:0.1.1.96] [prompt]</div><div class="line">|       |-- Hit #2 : Id=2 GID=[1204:0.1.2.96] [prompt]</div><div class="line">|       |-- Hit #3 : Id=3 GID=[1204:0.1.2.97] [delayed]</div><div class="line">|       |-- Hit #4 : Id=4 GID=[1204:0.1.3.97] [prompt]</div><div class="line">|       |-- Hit #5 : Id=5 GID=[1204:0.1.4.98] [prompt]</div><div class="line">|       |-- Hit #6 : Id=6 GID=[1204:0.1.5.98] [prompt]</div><div class="line">|       |-- Hit #7 : Id=7 GID=[1204:0.1.5.99] [prompt]</div><div class="line">|       |-- Hit #8 : Id=8 GID=[1204:0.1.6.99] [prompt]</div><div class="line">|       |-- Hit #9 : Id=9 GID=[1204:0.1.6.100] [prompt]</div><div class="line">|       |-- Hit #10 : Id=10 GID=[1204:0.1.7.100] [prompt]</div><div class="line">|       |-- Hit #11 : Id=11 GID=[1204:0.1.7.101] [prompt]</div><div class="line">|       |-- Hit #12 : Id=12 GID=[1204:0.1.8.101] [prompt]</div><div class="line">|       |-- Hit #13 : Id=13 GID=[1204:0.1.8.102] [prompt]</div><div class="line">|       |-- Hit #14 : Id=14 GID=[1204:0.1.0.94] [prompt]</div><div class="line">|       |-- Hit #15 : Id=15 GID=[1204:0.1.1.94] [prompt]</div><div class="line">|       |-- Hit #16 : Id=16 GID=[1204:0.1.2.94] [prompt]</div><div class="line">|       |-- Hit #17 : Id=17 GID=[1204:0.1.3.94] [prompt]</div><div class="line">|       |-- Hit #18 : Id=18 GID=[1204:0.1.4.93] [prompt]</div><div class="line">|       |-- Hit #19 : Id=19 GID=[1204:0.1.5.93] [prompt]</div><div class="line">|       |-- Hit #20 : Id=20 GID=[1204:0.1.6.93] [prompt]</div><div class="line">|       |-- Hit #21 : Id=21 GID=[1204:0.1.7.93] [prompt]</div><div class="line">|       `-- Hit #22 : Id=22 GID=[1204:0.1.8.93] [prompt]</div><div class="line">`-- Bank &#39;SD&#39; : &quot;mctools::simulated_data&quot;</div><div class="line">    |-- Properties : &lt;empty&gt;</div><div class="line">    |   `-- &lt;no property&gt;</div><div class="line">    |-- Collection type : 1</div><div class="line">    |-- Collections of step hit handles :</div><div class="line">    |   |-- Category &#39;calo&#39; has 1 hit(s) [capacity=1]</div><div class="line">    |   `-- Category &#39;gg&#39; has 25 hit(s) [capacity=25]</div><div class="line">    |-- Primary event :</div><div class="line">    |   |-- Auxiliary properties: &lt;none&gt;</div><div class="line">    |   |-- Label : &#39;Se82.0nubb&#39;</div><div class="line">    |   |-- Time  : 0 ns</div><div class="line">    |   |-- Vertex  : &lt;none&gt;</div><div class="line">    |   |-- Particles: [2]</div><div class="line">    |   |   |-- Particle #0 :</div><div class="line">    |   |   |   |-- Generation Id  : &lt;none&gt;</div><div class="line">    |   |   |   |-- Type           : 3 (label=&#39;e-&#39;)</div><div class="line">    |   |   |   |-- PDG code       : &lt;none&gt;</div><div class="line">    |   |   |   |-- Mass           : 0.510999 MeV</div><div class="line">    |   |   |   |-- Charge         : -1 e</div><div class="line">    |   |   |   |-- Time           : 0 ns</div><div class="line">    |   |   |   |-- Kinetic energy : 1.1133 MeV</div><div class="line">    |   |   |   |-- Momentum       : (0.706726,-0.130119,-1.36412) MeV</div><div class="line">    |   |   |   |-- Vertex         : &lt;no vertex&gt;</div><div class="line">    |   |   |   |-- Auxiliary properties: &lt;none&gt;</div><div class="line">    |   |   |   `-- Valid          : 1</div><div class="line">    |   |   `-- Particle #1 :</div><div class="line">    |   |       |-- Generation Id  : &lt;none&gt;</div><div class="line">    |   |       |-- Type           : 3 (label=&#39;e-&#39;)</div><div class="line">    |   |       |-- PDG code       : &lt;none&gt;</div><div class="line">    |   |       |-- Mass           : 0.510999 MeV</div><div class="line">    |   |       |-- Charge         : -1 e</div><div class="line">    |   |       |-- Time           : 0 ns</div><div class="line">    |   |       |-- Kinetic energy : 1.8817 MeV</div><div class="line">    |   |       |-- Momentum       : (0.0921589,0.473499,2.28718) MeV</div><div class="line">    |   |       |-- Vertex         : &lt;no vertex&gt;</div><div class="line">    |   |       |-- Auxiliary properties: &lt;none&gt;</div><div class="line">    |   |       `-- Valid          : 1</div><div class="line">    |   |-- GENBB weight : 1</div><div class="line">    |   |-- Classification : &#39;2e0p0g0a0X&#39;</div><div class="line">    |   `-- Valid: 1</div><div class="line">    |-- Time : &lt;none&gt;</div><div class="line">    `-- Vertex : (-0.0225505,1697.97,182.097) mm</div><div class="line">...</div></div><!-- fragment --><p>We clearly see that a new <code>CD</code> bank (<em>calibrated data</em>) has been added to the event record. It contains two collections of hits, respectively <em>calorimeter</em> and <em>tracker</em> hits. Running the visualization, we browse again this event where we can see additional graphics rendering and informations associated to the newly calibrated hits:</p>
<div class="image">
<img src="flr_qs_cd_event.png" alt="flr_qs_cd_event.png"/>
<div class="caption">
A calibrated simulated event</div></div>
<p> The superimposed white circles on top of the colored ones represent the calibrated tracker hits for which the drift radius and longitudinal position along the anode wire have been computed from the truth hits' timestamps. Here, there is only one calorimeter hit, the total deposited energy in the block and time of entering the scintillator block are also computed (with respect to the arbitrary decay time set by the simulation engine).</p>
<h2><a class="anchor" id="usingflreconstruct_trackfitalgo"></a>
How to run a tracking algorithm on simulated events </h2>
<p>Now we know how to perform the calibration step, we are interested in the reconstruction of electron tracks in the tracking chamber. For that we need additional processing on top of the <code>CD</code> bank which is now available in the event record.</p>
<p>The reconstruction of tracks associated to charged particles traversing the tracking chamber is a two step procedure:</p><ul>
<li>first the calibrated Geiger hits are clusterized in <em>tracker clusters</em>, using some special vicinity criteria,</li>
<li>then a fit is performed on each cluster to compute helix or line segments compatible with the Geiger hits.</li>
</ul>
<div class="image">
<img src="flr_track_fit.png" alt="flr_track_fit.png"/>
<div class="caption">
Track fitting procedure applied to calibrated events</div></div>
<p> We create a new <code>rec.conf</code> script with a custom <code>pipeline</code> inline module made of five consecutive modules. The first two ones do the (mock) calibration as shown in the previous section. Then we use an algorithm dedicated to the cluterization of tracker hits, followed by an algorithm for track fitting (helices and/or straight lines). The last module prints the event. As we now use modules implemented by dedicated Falaise plugins, we must explicitely provide a <code>flreconstruct.plugins</code> section with the list of plugins that must be dynamically loaded to allow the pipeline to work:</p>
<div class="fragment"><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;flreconstruct.plugins&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line">plugins : string[3] = &quot;Falaise_CAT&quot; \</div><div class="line">                      &quot;TrackFit&quot; \</div><div class="line">                      &quot;Falaise_TrackFit&quot;</div><div class="line"></div><div class="line">[name=&quot;pipeline&quot; type=&quot;dpp::chain_module&quot;]</div><div class="line">modules : string[5] = \</div><div class="line">  &quot;CalibrateTracker&quot; \</div><div class="line">  &quot;CalibrateCalorimeters&quot; \</div><div class="line">  &quot;CATTrackerClusterizer&quot; \</div><div class="line">  &quot;TrackFitting&quot; \</div><div class="line">  &quot;Dump&quot;</div><div class="line"></div><div class="line">[name=&quot;CalibrateTracker&quot; type=&quot;snemo::processing::mock_tracker_s2c_module&quot;]</div><div class="line"></div><div class="line">[name=&quot;CalibrateCalorimeters&quot; type=&quot;snemo::processing::mock_calorimeter_s2c_module&quot;]</div><div class="line"></div><div class="line">[name=&quot;CATTrackerClusterizer&quot; type=&quot;snemo::reconstruction::cat_tracker_clustering_module&quot;]</div><div class="line">TPC.processing_prompt_hits  : boolean = true</div><div class="line">TPC.processing_delayed_hits : boolean = false</div><div class="line"></div><div class="line">[name=&quot;TrackFitting&quot; type=&quot;snemo::reconstruction::trackfit_tracker_fitting_module&quot;]</div><div class="line">fitting_models   : string[2] = &quot;helix&quot; &quot;line&quot;</div><div class="line">line.only_guess  : string[4] = &quot;BB&quot; &quot;BT&quot; &quot;TB&quot; &quot;TT&quot;</div><div class="line">helix.only_guess : string[8] = &quot;BBB&quot; &quot;BBT&quot; &quot;BTB&quot; &quot;BTT&quot; &quot;TBB&quot; &quot;TBT&quot; &quot;TTB&quot; &quot;TTT&quot;</div><div class="line"></div><div class="line">[name=&quot;Dump&quot; type=&quot;dpp::dump_module&quot;]</div></div><!-- fragment --><p>We run: </p><div class="fragment"><div class="line">$ flreconstruct -i example.brio -p rec.conf -o example-rec.xml</div><div class="line">[notice:void datatools::library_loader::init():449] Automatic loading of library &#39;Falaise_CAT&#39;...</div><div class="line">[notice:void datatools::library_loader::init():449] Automatic loading of library &#39;TrackFit&#39;...</div><div class="line">[notice:void datatools::library_loader::init():449] Automatic loading of library &#39;Falaise_TrackFit&#39;...</div><div class="line">...</div><div class="line">|-- Bank &#39;CD&#39; : &quot;snemo::datamodel::calibrated_data&quot;</div><div class="line">:   ...</div><div class="line">|-- Bank &#39;SD&#39; : &quot;mctools::simulated_data&quot;</div><div class="line">:   ...</div><div class="line">|-- Bank &#39;TCD&#39; : &quot;snemo::datamodel::tracker_clustering_data&quot;</div><div class="line">:   ...</div><div class="line">`-- Bank &#39;TTD&#39; : &quot;snemo::datamodel::tracker_trajectory_data&quot;</div><div class="line">    ...</div></div><!-- fragment --><p>Now two banks have been added in the event records:</p><ul>
<li><code>TCD</code> : the <em>tracker clustering data</em> contains the result of the tracker hit clusterization with one or several solutions, each containing a collection of candidate clusters of hit cells. These clusters are used as the input of the track fitting algorithm</li>
<li><code>TTD</code> : the <em>tracker trajectory data</em> contains the result of the tracker fitting with one or several solutions, each containing a collection of candidate fitted tracks (helix or line).</li>
</ul>
<p>The display shows the best found clusterization/fitting solutions with two clusters of tracker hits (red and blue) and the best associated tracks that have been computed from these clusters. We clearly recognize a two electrons event pattern, but here only one is associated to a calorimeter block.</p>
<div class="image">
<img src="flr_qs_trackfit_event.png" alt="flr_qs_trackfit_event.png"/>
<div class="caption">
A simulated event with reconstructed tracker clusters and fitted tracks</div></div>
<h2><a class="anchor" id="usingflreconstruct_todo"></a>
To do </h2>
<p>Document more reconstruction steps:</p>
<ul>
<li>charged particle tracking module with extrapolation of vertex, impact points, curvature, track/calorimeter association...</li>
<li>gamma tracking</li>
<li>particle identification</li>
</ul>
<h2><a class="anchor" id="usingflreconstruct_scriptingflsimulate_sectionsandparameters"></a>
Script's supported sections and parameters </h2>
<p>The FLReconstruct script contains up to five sections of type <code>flreconstruct::section</code> with the following names:</p>
<ul>
<li><code>flreconstruct</code> : this is the system/base section where to set general parameters such as:<ul>
<li><code>numberOfEvents</code> : the number of events to be processed from the input (integer, optional, default is: <code>0</code> which means <em>all</em> events will be processed),</li>
<li><code>experimentalSetupUrn</code> : the experimental setup tag (default is: <code>urn:snemo:demonstrator:setup:1.0</code>),</li>
</ul>
</li>
<li><p class="startli"><code>flreconstruct.variantService</code> : this is the <em>variants</em> section where the Bayeux/datatools <em>variant service</em> dedicated to the management of variant parameters and configurations is configured. In principle, this section inherits the configuration of the variant service used to generate simulated data.</p>
<p class="startli">Parameters of interest are:</p><ul>
<li><code>configUrn</code> : the configuration tag for the variant service associated to the simulation setup (string, optional). If not set, it is automatically resolved from the experiment setup tag.</li>
<li><code>config</code> : the path to the main configuration file for the variant service associated to the simulation setup (string/path, optional). If not set, it is automatically resolved from the <code>configUrn</code> tag.</li>
<li><code>profileUrn</code> : the configuration tag for the variant profile chosen by the user to perform the simulation (string, optional). If not set, it may be automatically resolved from the <code>configUrn</code> tag if the variant configuration has a registered default profile.</li>
<li><code>profile</code> : the path to the variant profile chosen by the user to perform the simulation (string/path,optional). If not set, it is automatically resolved from the <code>profileUrn</code> tag or from input metadata.</li>
<li><code>settings</code> : a list of explicit setting for variant parameters chosen by the user to perform the simulation (array of strings, optional). If not set, it is automatically resolved from the <code>profileUrn</code> tag or from input metadata.</li>
</ul>
</li>
<li><p class="startli"><code>flreconstruct.services</code> : this is the <em>services</em> section where explicit configuration for the embedded Bayeux/datatools <em>service manager</em> is defined (by tag or explicit configuration file).</p>
<p class="startli">Parameters of interest are:</p><ul>
<li><code>configUrn</code> : the configuration tag for the service manager associated to the data producer setup (string, optional). If not set, it is automatically resolved from the experimental setup tag.</li>
<li><code>config</code> : the path to the main configuration file for the service manager service associated to the reconstrcution setup (string/path, optional). If not set, it is automatically resolved from the <code>configUrn</code> tag.</li>
</ul>
</li>
<li><p class="startli"><code>flreconstruct.plugins</code> : this is the <em>plugins</em> section where explicit directives are defined to load Falaise plugin libraries which define various types (classes) of processing modules.</p>
<p class="startli">Parameters of interest are:</p><ul>
<li><code>plugins</code> : the list of plugins to be loaded.</li>
<li><code>PLUGIN_NAME.directory</code> : the directory from where the plugin dynamic library named <code>PLUGIN_NAME</code> should be loaded (default: "@falaise.plugins:", i.e. the standard location for the installation of Falaise's plugins).</li>
</ul>
</li>
<li><p class="startli"><code>flreconstruct.pipeline</code> : this is the <em>pipeline</em> section where general setup of the reconstruction pipeline is provided.</p>
<p class="startli">Parameters of interest are:</p><ul>
<li><code>configUrn</code> : the tag of a registered/official pipeline.</li>
<li><code>config</code> : the main configuration file describing the modules used along the pipeline. If not set, it is automatically resolved from the <code>configUrn</code> tag.</li>
<li><code>module</code> : the name of the top level pipeline module, chosen from the list of modules defined in the main configuration file (default: <code>"pipeline"</code>).</li>
</ul>
</li>
</ul>
<p>A sample configuration script (commented) is provided in this <a href="FLReconstruct-3.0.0.conf">document</a> (for Falaise 3.0.0).</p>
<p>Additional sections may be added. These are the <em>inline</em> module sections described below.</p>
<h2><a class="anchor" id="usingflreconstruct_scriptingflsimulate_inlinemodules"></a>
Inline modules </h2>
<p>In the case the <code>flreconstruct.pipeline</code> section does not define an explicit pipeline configuration by tag (<code>configUrn</code>) or configuration file path (<code>config</code>), it is possible to provide a list of additional sections which define reconstruction modules. This technique is named the <em>inline</em> pipeline mode. Such a section uses the following format:</p>
<div class="fragment"><div class="line">[name=&quot;ModuleName&quot; type=&quot;ModuleType&quot;]</div><div class="line"></div><div class="line">... module&#39;s configuration parameters ...</div></div><!-- fragment --><p>where <code>ModuleName</code> is the unique name of the module and <code>ModuleType</code> is the identifier of its registered class type (see below).</p>
<p>This mode should not be used for production runs. It is expected that only official registered pipeline setups are used in such a case, through the <code>configUrn</code> properties in the <code>flreconstruct.pipeline</code> section.</p>
<h1><a class="anchor" id="usingflreconstruct_usingstandardpipelines"></a>
Using Standard Pipelines </h1>
<p>FLReconstruct implements a "pipeline" architecture in which events flow through an ordered sequence of "modules". Each module performs a specific task on the event (e.g. count hits), writing its results into the event for further processing by downstream modules. The sequence of modules and their configuration (e.g. algorithm parameters) in the pipeline are constructed via a <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1multi__properties.html">datatools::multi_properties</a></code> script. A set of pipeline scripts are supplied with Falaise by the Software Board to provide easy to use, validated reconstruction chains.</p>
<p>The available pipelines can be viewed by passing the <code>--help-pipeline-list</code> argument to <code>flreconstruct</code>. This will print a list of the available builtin pipelines</p>
<div class="fragment"><div class="line">$ flreconstruct --help-pipeline-list</div><div class="line">List of supported reconstruction pipeline:</div><div class="line">urn:snemo:demonstrator:reconstruction:1.0.0:pipeline : Processing pipeline modules for the SuperNEMO reconstruction setup (version 1.0.0)</div><div class="line">urn:snemo:demonstrator:reconstruction:hc-1.0.0:pipeline : Processing pipeline modules for the SuperNEMO reconstruction setup (Half-Commissioning version 1.0.0)</div><div class="line">$</div></div><!-- fragment --><p>In order to use a official registered pipeline, one shoud use:</p>
<div class="fragment"><div class="line">[name=&quot;flreconstruct.pipeline&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line">configUrn : string = PIPELINE_TAG</div></div><!-- fragment --><p>where <code>PIPELINE_TAG</code> is the release tag of a reconstruction pipeline. Example with the official pipeline with tag <code>"urn:snemo:demonstrator:reconstruction:1.0.0:pipeline"</code>:</p>
<div class="fragment"><div class="line">[name=&quot;flreconstruct.plugins&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line">plugins : string[4] = &quot;Falaise_CAT&quot;                     \</div><div class="line">                      &quot;TrackFit&quot;                        \</div><div class="line">                      &quot;Falaise_TrackFit&quot;                \</div><div class="line">                      &quot;Falaise_ChargedParticleTracking&quot;</div><div class="line"></div><div class="line">[name=&quot;flreconstruct.pipeline&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line">configUrn : string = &quot;urn:snemo:demonstrator:reconstruction:1.0.0:pipeline&quot;</div></div><!-- fragment --><p>Standard pipeline scripts are organised into directories based on the experiment they apply to, and should only be used for reconstructing data from these experiments. Note that <code>flreconstruct</code> tries to validate that a pipeline script can be applied to the input data. Pipeline definition scripts for each experiments are tagged with a versioning URN. You should always consider carefully which version tag to use for production and check its compatibility with the process which has generated input data (i.e. the FLSimulate setup).</p>
<p>The output file generated by <code>flreconstruct</code> may be opened and the results visualized using the [<code>flvisualize</code> GUI application](<a class="el" href="usingflvisualize.html">Using The FLVisualize Application</a>)</p>
<p>Builtin reconstruction scripts can be run in <code>flreconstruct</code>:</p>
<div class="fragment"><div class="line">$ flreconstruct -i example.brio -p myrecscript.conf</div></div><!-- fragment --><p>If standard reconstruction scripts are published in Falaise, it is possible to use the following syntax:</p>
<div class="fragment"><div class="line">$ flreconstruct -i example.brio -p @falaise:config/snemo/demonstrator/reconstruction/pipeline/1.0.0/flreconstruct.conf</div></div><!-- fragment --><p>Here <code>@falaise:</code> is simply shorthand for "the root  directory  of
standard Falaise resources" and can be viewed as a "mount point" for standard resource files. The subsequent path is simply the path from that root to the standard reconstruction script.</p>
<p>If the script itself is officially tagged, one can also use directly its tag from the command line:</p>
<div class="fragment"><div class="line">$ flreconstruct -i example.brio -p &quot;urn:snemo:demonstrator:reconstruction:1.0.0&quot;</div></div><!-- fragment --><p>Note here that the FLreconstruct script tagged <code>"urn:snemo:demonstrator:reconstruction:1.0.0"</code> is based on the reconstruction pipeline tagged <code>"urn:snemo:demonstrator:reconstruction:1.0.0:pipeline"</code>. The dependency scheme associated to this specific FLReconstruct script is:</p>
<div class="fragment"><div class="line">+-- urn:snemo:demonstrator:reconstruction:1.0.0 (reconstruction script)</div><div class="line">    +-- urn:snemo:demonstrator:setup:1.0 (related experimental setup)</div><div class="line">    +-- urn:snemo:demonstrator:setup:1.0:services</div><div class="line">    |   +-- urn:snemo:demonstrator:geometry:4.0 (used geometry model)</div><div class="line">    +-- urn:snemo:demonstrator:setup:1.0:variants (used variant configuration)</div><div class="line">    |   +-- urn:snemo:demonstrator:setup:1.0:variants:profiles:basic-1.0.0 (variant profile is fixed)</div><div class="line">    +-- urn:snemo:demonstrator:reconstruction:1.0.0:pipeline (reconstruction pipeline)</div></div><!-- fragment --><p>We can see that choosing the top-level script implies to fix all configuration of all components used by the software.</p>
<h1><a class="anchor" id="usingflreconstruct_usingoutputpaths"></a>
Writing Reconstruction Results to File </h1>
<p>To write <code>flreconstruct</code>'s results to file (e.g. for later analysis), the <code>-o</code> option may be used to write processed events to a file supplied as the argument, with the output format chosen based on the file extension.</p>
<p>To output to the BRIO format recognised by <code>flreconstruct</code> use the <code>.brio</code> extension:</p>
<div class="fragment"><div class="line">$ flreconstruct -i example.brio -p myrecscript.conf -o results.brio</div></div><!-- fragment --><p>The resultant file may be examined directly to see what data has been written by simply passing it back to <code>flreconstruct</code>, e.g.</p>
<div class="fragment"><div class="line">$ flreconstruct -i results.brio</div><div class="line">... output ...</div></div><!-- fragment --><p>Using the <code>.xml</code> extension leads to output a file in human readable XML format. This may be very useful for debugging purpose but not production because the size of such a file is very large.</p>
<p>The resultant file may also be further processed by <code>flreconstruct</code> using a pipeline constructed from your own analysis modules. Please see the document on <a class="el" href="flreconstructpipelineoutput.html">FLReconstruct Pipeline Output</a> for details of the data structures stored for each processed event. Further documents are available detailing <a class="el" href="writingflreconstructmodules.html">how to write your reconstruction/analysis modules</a>, and <a class="el" href="workingwitheventrecords.html">how to access event data from modules</a>.</p>
<p>Output to ROOT format is also possible by supplying an output file with the <code>.root</code> extension:</p>
<div class="fragment"><div class="line">$ flreconstruct -i example.brio -p myrecscript.conf -o results.root</div></div><!-- fragment --><p>The resultant file contains a single flat <code>TTree</code> structure that may be browsed interactively. Note that currently this format only outputs simulated and calibrated data, with no further reconstruction results. A separate <a class="el" href="usingflptd2root.html">converter program is available</a> for running full conversion, and will be gradually integrated into flreconstruct for direct conversion.</p>
<h1><a class="anchor" id="usingflreconstruct_usingcustompipelines"></a>
Using Custom Pipelines </h1>
<p>The standard pipelines provided by Falaise are intended to cover a wide range of use cases for standard reconstruction tasks leading to analyses. However, if you need to study improvements to the reconstruction via tuning existing modules or adding new ones then custom pipeline scripts can be used in <code>flreconstruct</code>. The <a class="el" href="writingflreconstructpipelinescripts.html">Writing FLReconstruct Pipeline Scripts</a> tutorial covers the syntax and structure of custom pipeline scripts.</p>
<h1><a class="anchor" id="usingflreconstruct_example"></a>
Example </h1>
<p>Falaise provides an example of FLreconstruct configuration. It is published from the installation resource directory in <code>examples/flreconstruct/ex01/</code>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
