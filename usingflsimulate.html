<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Falaise: Using The FLSimulate Application</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Falaise
   &#160;<span id="projectnumber">4.0.0</span>
   </div>
   <div id="projectbrief">SuperNEMO Software Toolkit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Using The FLSimulate Application </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="usingflsimulate_intro"></a>
Introduction to FLSimulate </h1>
<p>FLSimulate's task is to simulate the generation and passage of particles through the SuperNEMO detector, recording the detector response and writing this to an output file. Its simulation engine for physics uses the <a href="http://geant4.cern.ch">Geant4</a> toolkit, with geometry modelling and I/O handled by the Bayeux framework.</p>
<p>Here we present a brief overview of running FLSimulate from the command line to generate an output file suitable for input to the <a class="el" href="usingflreconstruct.html">FLReconstruct</a> and [FLVisualize](<a class="el" href="usingflvisualize.html">Using The FLVisualize Application</a>) applications.</p>
<p>Each FLSimulate simulation setup is built on top of an <em>experimental setup</em>. The experimental setup is characterized by a geometry model and possibly other dedicated services (electronics...).</p>
<p>When initialized, the simulation setup triggers :</p><ul>
<li>the instantiation of a <em>variants service</em> (for setting user options like geometry layout, vertex and decay generators...)</li>
<li>the instantiation of some dedicated <em>services</em> (geometry, electronics...),</li>
<li>the instantiation of a some <em>modules</em> dedicated to specific tasks:<ul>
<li>the <em>simulation</em> module with some core components for vertex and particles generation, particle tracking (Geant4 based engine),</li>
<li>the <em>digitization</em> module (not used yet),</li>
<li>the <em>output</em> module to save output simulated data (and possible embedded metadata).</li>
</ul>
</li>
</ul>
<p>At present, FLSimulate only supports simulation of the SuperNEMO demonstrator module, with several geometry and simulation <em>variants</em>.</p>
<p>The user is free to choose among several options:</p><ul>
<li>geometry layout of the detector: <code>Basic</code> (full detector) or <code>HalfCommissioning</code></li>
<li>activation of the magnetic field of not,</li>
<li>use of the external shieling of not,</li>
<li>change source material and thickness,</li>
<li>use of calibration sources of not,</li>
<li>use of a specific vertex generator, which may depends on the geometry layout,</li>
<li>use of a specific event generator, which may depends on the geometry layout,</li>
<li>use of specific simulation options. Other options are also available (see section below).</li>
</ul>
<p>Please contact the Software Working Group if you have any questions or feature requests.</p>
<p>There is also an old (legacy) version of FLSimulate (flsimulate_legacy) which does not provide as many features than the current one. It is deprecated and cannot support the new geometry and variants system.</p>
<h1><a class="anchor" id="usingflsimulate_commandline"></a>
Using FLSimulate on the Command Line </h1>
<p>FLSimulate is implemented as a simple command line application just like familiar UNIX commands such as <code>ls</code>. In the following, we will write commands assuming that the <code>flsimulate</code> executable is in your path. If it is not, simply use the relative or absolute path to <code>flsimulate</code>.</p>
<p>You can get help on the options that can be passed to <code>flsimulate</code> by running it with the <code>-h</code> of <code>--help</code> options, e.g.</p>
<div class="fragment"><div class="line">$ flsimulate --help</div><div class="line">flsimulate (3.3.0) : SuperNEMO simulation program</div><div class="line">Usage:</div><div class="line">  flsimulate [options]</div><div class="line">Options:</div><div class="line">  -h [ --help ]                        print this help message</div><div class="line">  --help-scripting                     print help on input script format and</div><div class="line">                                       schema</div><div class="line">  --help-simulation-setup              print help on simulation setup</div><div class="line">  --version                            print version number</div><div class="line">  -V [ --verbosity ] level             set the verbosity level</div><div class="line">                                       Example:</div><div class="line">                                         -V &quot;debug&quot;</div><div class="line">  -u [ --user-profile ] name (=normal) set the user profile (&quot;expert&quot;,</div><div class="line">                                       &quot;normal&quot;, &quot;production&quot;)</div><div class="line">  -d [ --mount-directory ] rule        register directories&#39; mount points</div><div class="line">                                       Example:</div><div class="line">                                         -d &quot;nemoprod@/etc/nemoprod/config&quot;</div><div class="line">                                         -d &quot;nemoprod.data@/data/nemoprod/runs&quot;</div><div class="line">  -c [ --config ] file                 configuration script for simulation</div><div class="line">                                       Examples:</div><div class="line">                                         -c &quot;simu.conf&quot;</div><div class="line">                                         -c &quot;${WORKER_DIR}/config/simu1.conf&quot;</div><div class="line">  -m [ --output-metadata-file ] file   file in which to store metadata</div><div class="line">                                       Example:</div><div class="line">                                         -m &quot;simu.meta&quot;</div><div class="line">  -E [ --embedded-metadata ] flag (=1) flag to (de)activate recording of</div><div class="line">                                       metadata in the simulation results</div><div class="line">                                       output file</div><div class="line">  -o [ --output-file ] file            file in which to store simulation</div><div class="line">                                       results</div><div class="line">                                       Examples:</div><div class="line">                                         -o &quot;example.brio&quot;</div><div class="line">                                         -o &quot;${WORKER_DIR}/data/run_1.xml&quot;</div></div><!-- fragment --><p>The <code>--version</code> option provides detailed information of the current status of the application, including which libraries it uses:</p>
<div class="fragment"><div class="line">$ flsimulate --version</div><div class="line">flsimulate 3.3.0</div><div class="line"></div><div class="line">Copyright (C) 2013-2017 SuperNEMO Collaboration</div><div class="line"></div><div class="line">flsimulate uses the following external libraries:</div><div class="line">* Falaise : 3.3.0</div><div class="line">* Bayeux  : 3.1.2</div><div class="line">* Boost   : 106300</div><div class="line">* Geant4  : 9.6.4</div></div><!-- fragment --><p>Note that the exact versions shown will depend on the current release and what versions of packages are linked.</p>
<h1><a class="anchor" id="usingflsimulate_quickstart"></a>
Quick start </h1>
<p>Here we propose to run FLSimulate with the default simulation setup. Only the output file is set from the command line:</p>
<div class="fragment"><div class="line">$ flsimulate -o example.xml</div><div class="line">...</div></div><!-- fragment --><p>The output <code>example.xml</code> file contains one unique simulated event corresponding to a Se-82 (0nubb) decay emitted from a random source pad (SuperNEMO Demonstrator geometry model 4.1 with <code>Basic</code> layout). You may browse the output XML file using your favorite text editor. You will see some leading records of type <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1properties.html">datatools::properties</a></code> corresponding to the metadata. Then comes a record of type <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code>. This data structure contains the unique simulated event with collections of truth hits.</p>
<p>You may display the event with: </p><div class="fragment"><div class="line">$ flvisualize -i example.xml</div><div class="line">...</div></div><!-- fragment --><h1><a class="anchor" id="usingflsimulate_scriptingflsimulate"></a>
Scripting FLSimulate </h1>
<p>FLSimulate basically runs the simulation in batch mode. Practically, a <em>configuration script</em> must be generally provided by the user.</p>
<h2><a class="anchor" id="usingflsimulate_scriptingflsimulate_format"></a>
Script's format </h2>
<p>The script uses the Bayeux's <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1multi__properties.html">datatools::multi_properties</a></code> format. The script contains a mandatory header:</p>
<div class="fragment"><div class="line">#@description a short description of the simulation run</div><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div></div><!-- fragment --><p>The '<code>#@description</code>' line is optional but highly recommended.</p>
<p>You may add comments at any place in the script. Just prepend a sharp ('<code>#</code>') symbol to any comment line. You may also prepend a comment at the end of a line. Examples:</p>
<div class="fragment"><div class="line"># This is a single commented line</div><div class="line"></div><div class="line">{...some script command...} # Comment starts at the end of the line</div><div class="line"></div><div class="line"># This is</div><div class="line"># a commented</div><div class="line"># block</div></div><!-- fragment --><p>Note that lines starting with '<code>#@</code>' are generally special meta-comments with embedded commands. They should not be considered as comments. As a matter of rule, the use of lines starting with '<code>#@</code>' is reserved for system use.</p>
<p>After the header, the script contains <em>sections</em>. A section starts with a section definition line with two identifiers:</p>
<ul>
<li>the <em>name</em> of the section,</li>
<li>the <em>type</em> of the section (here it must be <code>"flsimulate::section"</code>).</li>
</ul>
<p>The syntax is: </p><div class="fragment"><div class="line">[name=&quot;SectionName&quot; type=&quot;flsimulate::section&quot;]</div><div class="line"></div><div class="line">... section&#39;s body ...</div></div><!-- fragment --><p>The section's body uses the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1properties.html">datatools::properties</a></code> format. After the definition line, a short description may be optionally provided thanks to the '<code>#@config</code>' meta-comment:</p>
<div class="fragment"><div class="line">#@config a short description of the purpose of the section</div></div><!-- fragment --><p>Then comes the section's body which consists in a list of parameter setting directives. The format is:</p>
<div class="fragment"><div class="line">#@description a short description of the parameter</div><div class="line">NAME : TYPE [DECORATOR] = VALUE</div></div><!-- fragment --><p>where <code>NAME</code> is the parameter's name, <code>TYPE</code> its type and <code>VALUE</code> the selected value for this parameter. Some parameters may use an optional <code>DECORATOR</code> which gives additional informations about the parameter's type or processing. Again, the <code>#@description</code> line is optional, but recommended. Example: </p><div class="fragment"><div class="line">#@description The number of events to be generated</div><div class="line">numberOfEvents : integer = 10000</div></div><!-- fragment --><h2><a class="anchor" id="usingflsimulate_changenumberofevents"></a>
How to change the number of events simulated </h2>
<p>By default, FLSimulate generate only one event. To change this behaviour, you must create a <code>simu.conf</code> script with the <code>flsimulate</code> section and define the <code>numberOfEvents</code> integer parameter in it: </p><div class="fragment"><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;flsimulate&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">numberOfEvents : integer = 100</div></div><!-- fragment --><h2><a class="anchor" id="usingflsimulate_selecteventgenerator"></a>
How to select the event generator </h2>
<p>FLSimulate use a default primary event generator which is generally selected from the context of the selected simulation setup. The choice of the event generator is handle by the embedded <em>variant service</em> (<code>primary_events</code> registry). You must create a <code>simu.conf</code> script with the <code>flsimulate.variantService</code> section and define the <code>settings</code> string array parameter in it. This array must contain the proper <em>variant</em> setting directive, namely: </p><div class="fragment"><div class="line">primary_events:generator=GENERATOR_NAME</div></div><!-- fragment --><p> where <code>GENERATOR_NAME</code> is the name of a valid decay generator.</p>
<p>Example: to select the Tl-208 decay generator, use: </p><div class="fragment"><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;flsimulate&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">numberOfEvents : integer = 100</div><div class="line"></div><div class="line">[name=&quot;flsimulate.variantService&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">settings : string[1] = &quot;primary_events:generator=Tl208&quot;</div></div><!-- fragment --><h2><a class="anchor" id="usingflsimulate_selectevertexgenerator"></a>
How to select the vertex generator </h2>
<p>FLSimulate use a default vertex generator which is generally selected from the geometry context of the selected simulation setup. The choice of the vertex generator is handle by the embedded <em>variant service</em> (<code>vertexes</code> registry). You must create a <code>simu.conf</code> script with the <code>flsimulate.variantService</code> section and define the <code>settings</code> string array parameter in it. This array must contain the proper <em>variant</em> setting directive, namely: </p><div class="fragment"><div class="line">vertexes:generator=GENERATOR_NAME</div></div><!-- fragment --><p> where <code>GENERATOR_NAME</code> is the name of a valid vertex generator.</p>
<p>Example: to select the generator of vertice from the bulk volume of drift cells' field wire, use:</p>
<div class="fragment"><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;flsimulate&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">numberOfEvents : integer = 100</div><div class="line"></div><div class="line">[name=&quot;flsimulate.variantService&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">settings : string[1] = &quot;vertexes:generator=field_wire_bulk&quot;</div></div><!-- fragment --><p>Note the mandatory double quotes ('<code>"</code>') around the variant setting string directive.</p>
<p>You may want to simultaneously modify several variant parameters with respect to the default values. You must then accumulate setting directives, here from the above recipes:</p>
<div class="fragment"><div class="line">...</div><div class="line">[name=&quot;flsimulate.variantService&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">settings : string[2] = \</div><div class="line">  &quot;primary_events:generator=Tl208&quot; \</div><div class="line">  &quot;vertexes:generator=field_wire_bulk&quot;</div></div><!-- fragment --><p>You should take care on the size of the array type between the brackets, i.e. <code>string[2]</code>. It must be compatible with the number of setting directives you pass to the <em>variant service</em>. Note also the use of the backslash ('<code>\</code>') as the last character on a line. It acts as the continuation mark for a very long parameter definition line. In this example, we wrote one setting directive per line (indented by a few spaces) to make the script more readable.</p>
<h2><a class="anchor" id="usingflsimulate_selectgeometrylayout"></a>
How to select the geometry layout </h2>
<p>The choice of some geometry options is handled by the embedded <em>variant service</em> (<code>geometry</code> registry). You must create a <code>simu.conf</code> with the <code>flsimulate.variantService</code> section and define the <code>settings</code> string array parameter in it, as explained above. This array must contain the proper <em>variant</em> setting directive, namely:</p>
<div class="fragment"><div class="line">geometry:layout=LAYOUT_NAME</div></div><!-- fragment --><p>where <code>LAYOUT_NAME</code> is the name of a valid vertex generator. Supported values are:</p><ul>
<li><code>Basic</code> (default),</li>
<li><code>HalfCommissioning</code>.</li>
</ul>
<p>Example: to select the <em>half-commissioning</em> layout, use: </p><div class="fragment"><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;flsimulate&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">numberOfEvents : integer = 100</div><div class="line"></div><div class="line">[name=&quot;flsimulate.variantService&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">settings : string[1] = &quot;geometry:layout=HalfCommissioning&quot;</div></div><!-- fragment --><p>More geometry options are available from the <em>variant service</em>, see <a class="el" href="usingflsimulate.html#usingflsimulate_variants">this section</a>.</p>
<h2><a class="anchor" id="usingflsimulate_chooserng"></a>
How to choose the random numbers sequence </h2>
<p>By default, FLSimulate initializes embedded pseudo random number generators (PRNG) with a default seeding policy. Four seeds are internally chosen by a smart algorithm and then passed to the core components of the simulation engine:</p>
<ul>
<li>the event generator,</li>
<li>the vertex generator,</li>
<li>the Geant4 Monte Carlo engine,</li>
<li>the truth hit postprocessor(s).</li>
</ul>
<p>To gain full control on the simulation process, you can select the seeds yourself. You must create the <code>simu.conf</code> with the <code>flsimulate.simulation</code> section and define the four seeding integer parameters:</p>
<div class="fragment"><div class="line">[name=&quot;flsimulate.simulation&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">rngEventGeneratorSeed         : integer = 314159</div><div class="line">rngVertexGeneratorSeed        : integer = 765432</div><div class="line">rngGeant4GeneratorSeed        : integer = 123456</div><div class="line">rngHitProcessingGeneratorSeed : integer = 987654</div></div><!-- fragment --><p>Beware to use a set of four different values to avoid correlation effects between generators.</p>
<p>Another technique is available, it consists in providing an external file which contains the four seeds. See <a class="el" href="usingflsimulate.html#usingflsimulate_managingrandomnumbersequences">this section</a> for further details.</p>
<h2><a class="anchor" id="usingflsimulate_scriptingflsimulate_sectionsandparameters"></a>
Script's supported sections and parameters </h2>
<p>The FLSimulate's script contains up to five sections of type <code>flsimulate::section</code> with the following names:</p>
<ul>
<li><p class="startli"><code>flsimulate</code> : this is the system/base section where to set general parameters.</p>
<p class="startli">Parameters of interest are:</p><ul>
<li><code>numberOfEvents</code> : the number of events to be generated (integer, optional, default is: <code>1</code>),</li>
<li><code>doSimulation</code> : flag to activate the simulation module (boolean, default is: <code>true</code>),</li>
<li><code>doDigitization</code> : flag to activate the digitization module (boolean, default is: <code>false</code>, not used yet).</li>
</ul>
</li>
<li><p class="startli"><code>flsimulate.simulation</code> : this is the <em>simulation</em> section where the simulation setup is chosen as well as parameters for the management of pseudo random number generators (PRNG): seeds, logging about PRNG states.</p>
<p class="startli">Parameters of interest are:</p><ul>
<li><code>simulationSetupUrn</code> : the simulation setup tag (string, mandatory for production runs, otherwise optional, default tag is: <code>urn:snemo:demonstrator:simulation:2.3</code>).</li>
<li><code>simulationSetupConfig</code> : the explicit path to the simulation configuration file for the Bayeux/mctools <em>Geant4 driver</em> (string/path, optional). If not set, it is automatically resolved from the simulation setup tag.</li>
<li><code>rngSeedFile</code> : the input file for the seeding of random number generators (string/path, mandatory for production runs, otherwise optional; if this file is not provided, initial PRNG seeds are automatically computed and saved in metadata or in a default log file).</li>
<li><code>rngEventGeneratorSeed</code> : the explicit seed (integer) for the event generator.</li>
<li><code>rngVertexGeneratorSeed</code> : the explicit seed (integer) for the vertex generator.</li>
<li><code>rngGeant4GeneratorSeed</code> : the explicit seed (integer) for the Geant4 generator.</li>
<li><code>rngHitProcessingGeneratorSeed</code> : the explicit seed (integer) for the hit post-processing algorithms.</li>
<li><code>rngSeedFileSave</code> : the file path where to store the effective seeds used by the simulation.</li>
</ul>
</li>
<li><code>flsimulate.digitization</code> : this is the <em>digitization</em> section (not used yet).</li>
<li><p class="startli"><code>flsimulate.variantService</code> : this is the <em>variants</em> section where the Bayeux/datatools <em>variant service</em> dedicated to the management of variant parameters is configured. Users are given here the opportunity to tweak some core options about:</p><ul>
<li>the geometry,</li>
<li>the vertex generation,</li>
<li>the decay generation,</li>
<li>the simulation engine itself.</li>
</ul>
<p class="startli">Parameters of interest are:</p><ul>
<li><code>configUrn</code> : the configuration tag for the variant service associated to the simulation setup (string, optional). If not set, it is automatically resolved from the simulation setup tag.</li>
<li><code>config</code> : the path to the main configuration file for the variant service associated to the simulation setup (string/path, optional). If not set, it is automatically resolved from the <code>configUrn</code> tag.</li>
<li><code>profileUrn</code> : the configuration tag for the variant profile chosen by the user to perform the simulation (string, optional). If not set, it may be automatically resolved from the <code>configUrn</code> tag is the variant configuration has a registered default profile.</li>
<li><code>profile</code> : the path to the variant profile chosen by the user to perform the simulation (string/path,optional). If not set, it is automatically resolved from the <code>profileUrn</code> tag.</li>
<li><code>settings</code> : a list of explicit setting for variant parameters chosen by the user to perform the simulation (array of strings, optional). If not set, it is automatically resolved from the <code>profileUrn</code> tag.</li>
</ul>
<p class="startli">See <a class="el" href="usingflsimulate.html#usingflsimulate_variants">this section</a> for details.</p>
</li>
<li><p class="startli"><code>flsimulate.services</code> : this is the <em>services</em> section where explicit configuration for the embedded Bayeux/datatools <em>service manager</em> is defined (by tag or explicit configuration file). Typical services are:</p><ul>
<li>the <em>geometry</em> service : it describes the geometry model associated to the experimental setup on top of which the simulation setup is built.</li>
<li>the <em>electronics</em> service (not used yet) : it describes the electronics model associated to the experimental setup on top of which the simulation setup is built.</li>
</ul>
<p class="startli">Parameters of interest are:</p><ul>
<li><code>configUrn</code> : the configuration tag for the service manager associated to the simulation setup (string, optional). If not set, it is automatically resolved from the simulation setup tag.</li>
<li><code>config</code> : the path to the main configuration file for the service manager service associated to the simulation setup (string/path, optional). If not set, it is automatically resolved from the <code>configUrn</code> tag.</li>
</ul>
</li>
</ul>
<p>A sample configuration script (commented) is provided in this <a href="FLSimulate-3.3.0.conf">document</a> (for Falaise 3.3.0).</p>
<p>For a given run, the simulation setup is selected from the script's <code>flsimulate.simulation</code> section. Falaise uses a special service to registered blessed/official configuration (geometry, simulation, reconstruction...). Any setup of interest may be registered with an unique <em>tag</em>. The tag is a simple character string which uses an URN scheme. For example, Falaise version 3.3.0 is released with the registered simulation setup tag 2.3 with tag <code>urn:snemo:demonstrator:simulation:2.3</code>. This is the default simulation setup which will be used if not explicitely requested by the user.</p>
<p>Thus, in the <code>flsimulate.simulation</code> section, the simulation setup tag is optional and defaults to: <code>urn:snemo:demonstrator:simulation:2.3</code>. If no other parameters are explicitly set, FLSimulate will try to resolve all other configuration components using a dependency scheme displayed on the table below:</p>
<div class="fragment"><div class="line">+-- urn:snemo:demonstrator:simulation:2.3 (simulation setup)</div><div class="line">   +-- urn:snemo:demonstrator:setup:1.0 (related experimental setup)</div><div class="line">   +-- urn:snemo:demonstrator:simulation:2.3:services (used service configuration)</div><div class="line">   |   +-- urn:snemo:demonstrator:geometry:4.1 (used geometry model)</div><div class="line">   +-- urn:snemo:demonstrator:simulation:2.3:variants (used variant configuration)</div><div class="line">   +-- urn:snemo:demonstrator:simulation:2.3:variants:profiles:default (default variant profile)</div><div class="line">   +-- urn:snemo:demonstrator:simulation:vertexes:4.2 (used vertex generation setup)</div><div class="line">   +-- urn:snemo:demonstrator:simulation:decays:1.4 (used decay generation setup)</div></div><!-- fragment --><p>Effective paths to various configuration files are automatically resolved by a special service.</p>
<p>The default variant profile, namely <code>urn:snemo:demonstrator:simulation:2.3:variants:profiles:default</code>, is associated to the default simulation setup. It implies:</p>
<ul>
<li>the <code>Basic</code> geometry layout (full) demonstrator module with external iron shielding, uniform magnetic field (25 Gauss), enriched Se source pads...</li>
<li>(0nubb) decays of Se-82,</li>
<li>vertices generated from the bulk volume of random source pads.</li>
</ul>
<p>To learn more about the format of the simulation configuration script, use:</p>
<div class="fragment"><div class="line">$ flsimulate --help-scripting</div><div class="line">...</div></div><!-- fragment --><h1><a class="anchor" id="usingflsimulate_variants"></a>
FLSimulate's variant system </h1>
<h2>Basics </h2>
<p>As mentionned above, FLSimulate embeds a <em>variant service</em> which offers to the user the possibility to tweak an official set of parameters from a <em>variant repository</em>. A variant <em>profile</em> can thus be generated and imported by the FLSimulate's subsystems.</p>
<p>The variant repository is a container which typically contains several sets of variant parameters, the <em>variant registries</em>, organized by topics.</p>
<p>The variant registry implements a dynamic hierarchy of variant parameters and depender variant menus. It is organized like a filesystem where each parameter and variant has an unique path.</p>
<p>As an illustration, here is the organization of the geometry registry used by the SuperNEMO demonstrator simulation setup (2." (tag : `"urn:snemo:demonstrator:simulation:2.3`):</p>
<div class="fragment"><div class="line">geometry/</div><div class="line">+-- layout (string)</div><div class="line">|   +-- if_basic/</div><div class="line">|   |   +-- magnetic_field (boolean)</div><div class="line">|   |   |   +-- is_active/</div><div class="line">|   |   |       +-- type</div><div class="line">|   |   |           +-- if_mapped/</div><div class="line">|   |   |           |   +-- map</div><div class="line">|   |   |           |   |   +-- if_user/</div><div class="line">|   |   |           |   |       +-- map_file</div><div class="line">|   |   |           |   +-- z_inverted</div><div class="line">|   |   |           +-- if_uniform_vertical/</div><div class="line">|   |   |               +-- magnitude (real, as magnetic flux density)</div><div class="line">|   |   |               +-- direction (string)</div><div class="line">|   |   +-- source_layout (string)</div><div class="line">|   |   |   +-- if_basic/</div><div class="line">|   |   |       +-- thickness (real, as length)</div><div class="line">|   |   |       +-- material (string)</div><div class="line">|   |   +-- source_calibration (boolean)</div><div class="line">|   |   |   +-- is_active/</div><div class="line">|   |   |       +-- type (string)</div><div class="line">|   |   +-- shielding (boolean)</div><div class="line">|   +-- if_half_commissioning/</div><div class="line">|       +-- gap (real, as length)</div><div class="line">+-- calo_film_thickness (real, as length)</div></div><!-- fragment --><p>The top level so-called <code>geometry</code> item &ndash; here displayed with an arbitrary trailing slash ('<code>/</code>') &ndash; represents the <em>registry</em> which hosts all variant parameters related to the geometry model. Items <em>without</em> a trailing slash are <em>variant parameters</em> (here their types are shown between parenthesis). They may be given values selected by the user, depending on their type and constraints implemented by the variant service: support for units, range or enumeration of allowed values... Items <em>with</em> a trailing slash are specific <em>variant menus</em> which are activated only if specific values are selected for their parent parameter. An activated variant menu publishes a new set of variant parameters which are thus made available for the user from a deeper level of the variant hierarchy.</p>
<h2>FLSimulate registries </h2>
<p>In the current implementation (Falaise 3.3.0 and simulation setup version 2.3), four variant <em>registries</em> are defined in the variant repository:</p><ul>
<li><code>geometry</code> : handles geometry options,</li>
<li><code>vertexes</code> : handles vertex generation options,</li>
<li><code>primary_events</code>: handles decays generation options,</li>
<li><code>simulation</code> : handles options for the Geant4 engine.</li>
</ul>
<p>The list of user choices is described in this <a href="FLSimulateVariantsDoc-2.1.pdf">document</a> (for SuperNEMO Demonstrator simulation setup version 2.2 and Falaise 3.2.0). It describes all available simulation variant parameters and their possible dependencies in this simulation context.</p>
<p>Note that the variant system tries to ensure the consistence between various choices. For example, the vertex generators from calibration source (registry <code>vertexes</code>) are not available when the calibration sources are not arranged in the source frame geometry model (registry <code>geometry</code>). A dependency scheme is thus supported to take into account such constraints.</p>
<p>The lists of valid vertex and event generators for each geometry variant options can also be dynamically browsed through the <code>flsimulate-configure</code> program (with builtin GUI mode of your Bayeux setup).</p>
<p>To get help from the command line, run: </p><div class="fragment"><div class="line">$ flsimulate-configure --help</div></div><!-- fragment --><p>To launch a FlSimulate configuration session, run: </p><div class="fragment"><div class="line">$ flsimulate-configure</div></div><!-- fragment --><p>And then inspect the options available from the <code>Vertex generation</code> and <code>Primary events</code> panels in the GUI. Be aware that some choices may be inhibited by the <code>Geometry</code> context.</p>
<p>The image below shows the typical GUI interface of the <code>flsimulate-configure</code> variant inspector/editor program. The interface here displays the <code>geometry</code> registry panel:</p>
<div class="image">
<img src="fls_variants_gui_1.png" alt="fls_variants_gui_1.png"/>
<div class="caption">
FLSimulate's variant inspector GUI (geometry panel)</div></div>
 <p>The next image shows the selection of the vertex generator from the <code>Vertex generation</code> registry panel:</p>
<div class="image">
<img src="fls_variants_gui_2.png" alt="fls_variants_gui_2.png"/>
<div class="caption">
FLSimulate's variant inspector GUI (vertexes panel)</div></div>
 <p>Notice: You Bayeux setup should have been compiled with Qt GUI support to benefit of the <code>flsimulate-configure</code>'s GUI interface.</p>
<p>By <code>flsimulate-configure</code> uses a default simulation setup (example: "urn:snemo:demonstrator:simulation:2.3"). You can change to some arbitrary simulation setup with the <code>--setup-tag</code> switch: </p><div class="fragment"><div class="line">$ flsimulate-configure --setup-tag &quot;urn:snemo:demonstrator:simulation:2.3&quot;</div></div><!-- fragment --><p> This will activate a variant context specific to the selected simulation setup.</p>
<p>Be aware that two different simulation setups may not be compatible in terms of variant context. It means that a variant profile generated and used by simulation setup X is not automatically usable with simulation setup Y, typically because the newest Y setup publishes and requires more variant parameters associated to a more complex and/or realistic description of the experiment.</p>
<h2><a class="anchor" id="usingflsimulate_variants_explicitsettings"></a>
Using explicit variant settings  </h2>
<p>The <code>flsimulate.variantService</code> section may contains the <code>settings</code> parameter. It consists in a list of assignment instructions to be passed to the variant service.</p>
<p>The format of a setting directive is:</p>
<div class="fragment"><div class="line">REGISTRY_NAME:PATH_TO_VARIANT_PARAMATER=VALUE</div></div><!-- fragment --><p>where:</p><ul>
<li><code>REGISTRY_NAME</code> is the name of the variant registry which hosts the selected parameter,</li>
<li><code>PATH_TO_VARIANT_PARAMATER</code> is the path of the target parameter in the registry directory,</li>
<li><code>VALUE</code> is the textual representation of the selected value for the target parameter.</li>
</ul>
<p>For example, to simulate 100 Tl-208 events from the bulk volume of the tracker cells' field wires in the full Demonstrator, you must create the following <code>simu.conf</code> script (using the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1multi__properties.html">datatools::multi_properties</a></code> format):</p>
<div class="fragment"><div class="line">#@description Main flsimulate configuration script</div><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;flsimulate&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">numberOfEvents : integer = 100</div><div class="line"></div><div class="line">[name=&quot;flsimulate.variantService&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">settings : string[2] = \</div><div class="line">  &quot;vertexes:generator=field_wire_bulk&quot; \</div><div class="line">  &quot;primary_events:generator=Tl208&quot;</div></div><!-- fragment --><p>The <code>settings</code> parameter must not be used for production runs. One should use an explicit variant profile file (<code>profile</code>) in place of it (see below) or, preferably, a registered variant profile's <em>tag</em> (<code>profileUrn</code>) .</p>
<h2><a class="anchor" id="usingflsimulate_variants_profile"></a>
Using a variant profile </h2>
<p>The <code>flsimulate-configure</code> program proposes an interface to edit/select a set of parameters and then generate a <em>variant profile</em>. A variant profile is a file which contains the explicit list of variant parameters with their values selected for a simulation run.</p>
<div class="fragment"><div class="line">$ flsimulate-configure -o &quot;variants.profile&quot;</div></div><!-- fragment --><p>Here the <code>variant.profile</code> file is generated at exit (option <code>-o</code>). This <em>profile</em> file stores a set of variant options (using a specific format) from which the variant service can pickup the parameters' value selected by the user. The <em>profile</em> contains:</p>
<div class="fragment"><div class="line">#@format=datatools::configuration::variant</div><div class="line">#@format.version=1.0</div><div class="line">#@organization=snemo</div><div class="line">#@application=falaise</div><div class="line"></div><div class="line">[registry=&quot;geometry&quot;]</div><div class="line">layout = &quot;Basic&quot;</div><div class="line">layout/if_basic/magnetic_field = true</div><div class="line">layout/if_basic/magnetic_field/is_active/type = &quot;UniformVertical&quot;</div><div class="line">layout/if_basic/magnetic_field/is_active/type/if_uniform_vertical/magnitude = 25 gauss</div><div class="line">layout/if_basic/magnetic_field/is_active/type/if_uniform_vertical/direction = &quot;+z&quot;</div><div class="line">layout/if_basic/source_layout = &quot;Basic&quot;</div><div class="line">layout/if_basic/source_layout/if_basic/thickness = 250 um</div><div class="line">layout/if_basic/source_layout/if_basic/material = &quot;Se82&quot;</div><div class="line">layout/if_basic/source_calibration = false</div><div class="line">layout/if_basic/shielding = true</div><div class="line">calo_film_thickness = 25 um</div><div class="line"></div><div class="line">[registry=&quot;vertexes&quot;]</div><div class="line">generator = &quot;free_spot&quot;</div><div class="line">generator/if_free_spot/x = 0 mm</div><div class="line">generator/if_free_spot/y = 0 mm</div><div class="line">generator/if_free_spot/z = 0 mm</div><div class="line"></div><div class="line">[registry=&quot;primary_events&quot;]</div><div class="line">generator = &quot;electron.1MeV&quot;</div><div class="line"></div><div class="line">[registry=&quot;simulation&quot;]</div><div class="line">physics_mode = &quot;Constructors&quot;</div><div class="line">physics_mode/if_constructors/em_model = &quot;standard&quot;</div><div class="line">production_cuts = true</div><div class="line">output_profile = &quot;none&quot;</div></div><!-- fragment --><p>The file uses an ASCII format to ease user's understanding and for debugging purpose. However, unless you know what you are doing, you should not edit this file manually (or even reorder parameters or registry sections) because its format is dynamic and depends on the selected options by the user through the <code>flsimulate-configure</code>'s interface.</p>
<p>This file can be reused as input of the <code>flsimulate</code> program (see below). The <code>simu.conf</code> script now contains:.</p>
<div class="fragment"><div class="line">...</div><div class="line">[name=&quot;flsimulate.variantService&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">profile : string as path = &quot;variants.profile&quot;</div></div><!-- fragment --><p>where the <code>variants.profile</code> explicitely publishes all variant parameters that have been chosen by the user. The following example displays the default variant profile associated to the default simulation setup (version 2.3) in Falaise 3.3.0:</p>
<div class="fragment"><div class="line">#@format=datatools::configuration::variant</div><div class="line">#@format.version=1.0</div><div class="line">#@organization=snemo</div><div class="line">#@application=falaise</div><div class="line"></div><div class="line">[registry=&quot;geometry&quot;]</div><div class="line">layout = &quot;Basic&quot;</div><div class="line">layout/if_basic/magnetic_field = true</div><div class="line">layout/if_basic/magnetic_field/is_active/type = &quot;UniformVertical&quot;</div><div class="line">layout/if_basic/magnetic_field/is_active/type/if_uniform_vertical/magnitude = 25 gauss</div><div class="line">layout/if_basic/magnetic_field/is_active/type/if_uniform_vertical/direction = &quot;+z&quot;</div><div class="line">layout/if_basic/source_layout = &quot;Basic&quot;</div><div class="line">layout/if_basic/source_layout/if_basic/thickness = 250 um</div><div class="line">layout/if_basic/source_layout/if_basic/material = &quot;Se82&quot;</div><div class="line">layout/if_basic/source_calibration = false</div><div class="line">layout/if_basic/shielding = true</div><div class="line">calo_film_thickness = 25 um</div><div class="line"></div><div class="line">[registry=&quot;vertexes&quot;]</div><div class="line">generator = &quot;source_pads_bulk&quot;</div><div class="line"></div><div class="line">[registry=&quot;primary_events&quot;]</div><div class="line">generator = &quot;Se82.0nubb&quot;</div><div class="line"></div><div class="line">[registry=&quot;simulation&quot;]</div><div class="line">physics_mode = &quot;Constructors&quot;</div><div class="line">physics_mode/if_constructors/em_model = &quot;standard&quot;</div><div class="line">production_cuts = true</div><div class="line">output_profile = &quot;none&quot;</div></div><!-- fragment --><h1><a class="anchor" id="usingflsimulate_experimentssimsetups"></a>
Available experiments and simulation setups </h1>
<p>The currently only available experiment in <code>flsimulate</code> is the SuperNEMO Demonstrator (tag=<code>"urn:snemo:demonstrator"</code>).</p>
<p>Only one experimental setup is available (tag=<code>"urn:snemo:demonstrator:setup:1.0"</code>). It consists in the description of the SuperNEMO demonstrator detector through a geometry model identified with the <code>"urn:snemo:demonstrator:geometry:4.1"</code> tag as shown above in the dependency table.</p>
<p>In the future, additional experimental setups will be implemented, including not only the geometry model but also the description of the electronics (at least the part of it which is needed for the offline software, digitization...).</p>
<p>As of version 4.1 of the geometry model and its associated variant system, the experimental setup includes two flavours of the general layout of the detector:</p><ul>
<li><code>Basic</code> : realistic model of the full demonstrator detector (<em>French</em> and <em>Italian</em> sides, source frame with calibration sources, external shielding)</li>
<li><code>HalfCommissioning</code> : realistic model of the detector with only one calorimeter wall assemblied with one tracker submodule and no source frame (only <em>French</em> side, like in the context of end 2016-begin 2017).</li>
</ul>
<p>Each of these layouts publishes additional options.</p>
<h1><a class="anchor" id="usingflsimulate_generator_table"></a>
Available Vertex/Event Generators </h1>
<p>The architecture of <code>flsimulate</code> separates the specification of where events are generated (geometry) from the specification of how the events are generated (decays). With several different geometry layouts being modelled and many background, signal and calibration physics sources available, a wide range of vertex and event generators are available.</p>
<p>From Falaise 3.0 (simulation setup version 2.1), the choice of geometry options and vertex/decay generators is done through a Bayeux/datatools <em>variant service</em> embedded in the FLSimulate application. A profile of variant parameters must be created to suit the user's needs (see sections above).</p>
<p>Note that <code>flsimulate</code> will throw an exception if you supply an unknown generator for the experimental setup being simulated. In principle, the variant system does check that the combination of vertex and event generators are sensible.</p>
<h1><a class="anchor" id="usingflsimulate_summaryofavailableconfigurations"></a>
Summary of available configurations </h1>
<p>Falaise is distributed with an official set of predefined configurations of various types:</p><ul>
<li>experiments</li>
<li>experimental setups</li>
<li>geometry models</li>
<li>simulation setups</li>
<li>reconstruction pipelines</li>
</ul>
<p>These official configurations are registered in a dedicated <em>URN service</em>. Each configuration is given an unique identifier: its <em>tag</em>. It is a character string which uses the <em>URN</em> scheme format. In principle, users can thus address, in a given context, any official configuration thanks to its tag. Some configurations are possibly linked by some dependency scheme. Generally, a given simulation setup is designed to work with a special experimental setup. It wouldn't work with another one. For example, the default simulation setup for the SuperNEMO demonstrator implies a collection of vertex generators taht are not compatible with the BiPo3 geometry model. The <em>URN service</em> tries to formally handle such kind of constraints.</p>
<p>Once selected, a tag can thus be associated to one or more configuration files from the Falaise resource directory. Such operations are automatically handled by an <em>URN resolver service</em>.</p>
<p>Users may also use their own simulation setups and associated configuration files. In such case, explicit paths to configuration files must be provided in configuration scripts. This mode should be reserved for expert users.</p>
<h2><a class="anchor" id="usingflsimulate_summaryofavailableexperiments"></a>
List of available experiments </h2>
<ol type="1">
<li>SuperNEMO demonstrator:<ul>
<li>Description: The SuperNEMO demonstrator experiment (all phases: half-commissioning, full demonstrator)</li>
<li>Tag : <code>"urn:snemo:demonstrator"</code></li>
</ul>
</li>
<li>BiPo3 detector (not used yet):<ul>
<li>Description: The BiPo3 detector</li>
<li>Tag : <code>"urn:bipo3:detector"</code></li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="usingflsimulate_summaryofavailableexperimentalsetups"></a>
List of available experimental setups </h2>
<ol type="1">
<li>SuperNEMO demonstrator experimental setup tag 1.0:<ul>
<li>Description: The model of the SuperNEMO demonstrator experimental setup</li>
<li>Tag : <code>"urn:snemo:demonstrator:setup:1.0"</code></li>
<li>Related experiment: <code>"urn:snemo:demonstrator"</code></li>
<li>Associated to:<ul>
<li>Variant system: <code>"urn:snemo:demonstrator:setup:1.0:variants"</code></li>
<li>Services system: <code>"urn:snemo:demonstrator:setup:1.0:services"</code><ul>
<li>Geometry service: <code>"urn:snemo:demonstrator:geometry:4.1"</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="usingflsimulate_summaryofavailablesimulationsetups"></a>
List of available simulation setups </h2>
<ol type="1">
<li>SuperNEMO demonstrator simulation setup tag 2.1:<ul>
<li>Description: Simulation setup for the SuperNEMO demonstrator detector</li>
<li>Tag : <code>"urn:snemo:demonstrator:simulation:2.1"</code></li>
<li>Based on:<ul>
<li>Experimental setup: <code>"urn:snemo:demonstrator:setup:1.0"</code></li>
<li>Vertex generation system: <code>"urn:snemo:demonstrator:simulation:vertexes:4.1"</code></li>
<li>Primary events generation system : <code>"urn:snemo:demonstrator:simulation:decays:1.2"</code></li>
</ul>
</li>
<li>Associated to:<ul>
<li>Services system: <code>"urn:snemo:demonstrator:simulation:2.1:services"</code></li>
<li>Variant system: <code>"urn:snemo:demonstrator:simulation:2.1:variants"</code></li>
<li>Blessed profiles: <code>"urn:snemo:demonstrator:simulation:2.1:variants:profiles:basic-1.0"</code></li>
<li>Default profile: <code>"urn:snemo:demonstrator:simulation:2.1:variants:profiles:default"</code></li>
</ul>
</li>
</ul>
</li>
<li>SuperNEMO demonstrator simulation setup tag 2.2<ul>
<li>Description: Simulation setup for the SuperNEMO demonstrator detector</li>
<li>Tag : <code>"urn:snemo:demonstrator:simulation:2.2"</code></li>
<li>Based on:<ul>
<li>Experimental setup: <code>"urn:snemo:demonstrator:setup:1.0"</code></li>
<li>Vertex generation system: <code>"urn:snemo:demonstrator:simulation:vertexes:4.1"</code></li>
<li>Primary events generation system : <code>"urn:snemo:demonstrator:simulation:decays:1.3"</code></li>
</ul>
</li>
<li>Associated to:<ul>
<li>Services system: <code>"urn:snemo:demonstrator:simulation:2.2:services"</code></li>
<li>Variant system: <code>"urn:snemo:demonstrator:simulation:2.2:variants"</code></li>
<li>Blessed profiles: <code>"urn:snemo:demonstrator:simulation:2.2:variants:profiles:basic-1.0"</code></li>
<li>Default profile: <code>"urn:snemo:demonstrator:simulation:2.2:variants:profiles:default"</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<ol type="1">
<li>SuperNEMO demonstrator simulation setup tag 2.3<ul>
<li>Description: Simulation setup for the SuperNEMO demonstrator detector</li>
<li>Tag : <code>"urn:snemo:demonstrator:simulation:2.3"</code></li>
<li>Based on:<ul>
<li>Experimental setup: <code>"urn:snemo:demonstrator:setup:1.0"</code></li>
<li>Vertex generation system: <code>"urn:snemo:demonstrator:simulation:vertexes:4.2"</code></li>
<li>Primary events generation system : <code>"urn:snemo:demonstrator:simulation:decays:1.4"</code></li>
</ul>
</li>
<li>Associated to:<ul>
<li>Services system: <code>"urn:snemo:demonstrator:simulation:2.3:services"</code></li>
<li>Variant system: <code>"urn:snemo:demonstrator:simulation:2.3:variants"</code></li>
<li>Blessed profiles: <code>"urn:snemo:demonstrator:simulation:2.3:variants:profiles:basic-1.0"</code></li>
<li>Default profile: <code>"urn:snemo:demonstrator:simulation:2.3:variants:profiles:default"</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="usingflsimulate_hits_output_profiles"></a>
Available MC hits output profiles </h1>
<p>By default FLSimulate produces collections of <em>truth</em> MC hits and stored them in the output data model (the <a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classmctools_1_1simulated__data.html">mctools::simulated_data</a> class).</p>
<p>For the SuperNEMO Demonstrator simulation configuration using the <code>Basic</code> geometry layout, four <em>official</em> collections of truth hits are thus populated:</p>
<ul>
<li><code>calo</code> : truth MC hits collected from the scintillator blocks of the main calorimeter</li>
<li><code>xcalo</code> : truth MC hits collected from the scintillator blocks of the X-calorimeter</li>
<li><code>gveto</code> : truth MC hits collected from the scintillator blocks of the gamma veto</li>
<li><code>gg</code> : truth MC hits collected from the drift volume of the tracker cells (Geiger regime)</li>
</ul>
<p>Additional collections of hits can be generated : the <em>detailed</em> MC hits. So far, we use one unique collection of truth hits named <code>__visu.tracks</code>. The <code>__visu.tracks</code> collection collects all <em>MC step hits</em> that have been generated along particle tracks that crossed some volumes of interest. To activate the recording of such output, several <em>output profiles</em> have been made available.</p>
<p>For the <code>Demonstrator/Basic</code> configuration/layout, these are:</p>
<ul>
<li><code>calo_details</code> : collect all Geant4 step hits from the calo, xcalo and gveto sensitive detectors</li>
<li><code>tracker_details</code> : collect all Geant4 step hits from within volumes in the tracker part of the detector</li>
<li><code>source_details</code> : collect all Geant4 step hits from within volumes in the source part of the detector</li>
<li><code>all_details</code> : collect all Geant4 step hits from any volumes of interest (shortcut for the <code>calo_details+tracker_details+source_details</code> rule)</li>
</ul>
<p>The activation of some additional output is done with the <code>simulation:output_profile</code> variant parameter. It may be limited by geometry options, for example the <code>source_details</code> output profile is not available with the <code>HalfCommissioning</code> geometry layout because the source frame is not available in this layout.</p>
<p>Example: select the full detail output profile:</p>
<div class="fragment"><div class="line">#@description Main flsimulate configuration script</div><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line">[name=&quot;flsimulate.variantService&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">settings : string[1] = &quot;simulation:output_profile=all_details&quot;</div></div><!-- fragment --><p>Be aware that using this feature implies that the simulation will use additional CPU and the output file will use a lot of storage. This option should thus be reserved for dedicated studies, debugging and visualization purpose, not for production of large datasets of simulated data.</p>
<p>The description of the output simulation data model is described in a <a class="el" href="flsimulateoutput.html">dedicated page on FLSimulate output</a>.</p>
<h1><a class="anchor" id="usingflsimulate_managingrandomnumbersequences"></a>
Managing random number sequences  </h1>
<p>As shown in the <a class="el" href="usingflsimulate.html#usingflsimulate_chooserng">above section</a>, users can take full control on random number sequences used internally by FLSimulate.</p>
<p>The script <code>flsimulate.simulation</code> section recognizes several configuration parameters concerning PRNG initialization and management.</p>
<p>For production runs, it is mandatory to use the <code>rngSeedFile</code> parameter:</p>
<div class="fragment"><div class="line">[name=&quot;flsimulate.simulation&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">#@config Simulation setup</div><div class="line">...</div><div class="line">#@description Random seeds external file</div><div class="line">rngSeedFile : string as path = &quot;seeds.conf&quot;</div><div class="line">...</div></div><!-- fragment --><p>The <code>seeds.conf</code> file is typically generated by the following command: </p><div class="fragment"><div class="line">$ bxg4_seeds -k -d . -p seeds.conf</div></div><!-- fragment --><p>It uses the following format:</p>
<div class="fragment"><div class="line">{EG=142921705; MGR=569932270; SHPF=1008320517; VG=1002945362}</div></div><!-- fragment --><p>Here we can see that FLSimulate requests 4 seeds, one for each random number generators embedded in the Bayeux/Geant4 simulation engine:</p><ul>
<li><code>EG</code> stands for <em>event generator</em>,</li>
<li><code>VG</code> stands for <em>vertex generator</em>,</li>
<li><code>MGR</code> stands for <em>simulation manager</em> (Geant4 engine),</li>
<li><code>SHPF</code> stands for <em>step hit processing factory</em>, a software component responsible of the generation of the final collection of truth hits (see below).</li>
</ul>
<p>It is very important to make sure that all simulation runs use different sets of seeds in order to ensure statistical independancy of generated simulation data samples. The <code>bxg4_seeds</code> program helps to generated such lists of independant seed sets in the context of a massive Monte Carlo production.</p>
<p>If the input seed file is not provided, the initial seeds will be automatically generated by the seed manager embedded in FLSimulate.</p>
<p>User may also provide the <code>rngSeedFileSave</code> parameter: it describes the file where to save the original seeds, particularly when they are not set explicitely through <code>rngSeedFile</code> or <code>rngXXXGeneratorSeed</code> parameters. By default, original seeds will be saved in metadata of in the <code>__flsimulate-seeds.log</code> file in the current directory. One can thus select explicitely this output file with:</p>
<div class="fragment"><div class="line">[name=&quot;flsimulate.simulation&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">#@config Simulation setup</div><div class="line">...</div><div class="line">#@description File to save initial random seeds</div><div class="line">rngSeedFileSave : string as path = &quot;path/to/the/init-seeds.log&quot;</div><div class="line">...</div></div><!-- fragment --><h1><a class="anchor" id="usingflsimulate_outputdatafile"></a>
Output data file </h1>
<p>The FLSimulate output file is set from the command line through the <code>-o</code> or <code>--output-file</code> switch. It may use the XML format (for debugging purpose) or Bayeux's Brio binary format (for production).</p>
<p>Simulation then runs with:</p>
<div class="fragment"><div class="line">$ flsimulate -c simu.conf -o example.brio</div><div class="line">... lots of logging ...</div></div><!-- fragment --><p>Here the <code>example.brio</code> file contains the Monte Carlo generated events.</p>
<p>The system automatically select the proper format driver from the file extension. Supported file extensions are:</p>
<ul>
<li><code>.brio</code> : Boost over Root I/O with embedded portable binary format (fast and highly compressed, reserved for production)</li>
<li><code>.data</code>, <code>.data.gz</code>, <code>.data.bz2</code> : Portable binary format (fast and possibly highly compressed, reserved for production)</li>
<li><code>.txt</code>, <code>.txt.gz</code>, <code>.txt.bz2</code> : Portable ASCII text format (slow and possibly highly compressed)</li>
<li><code>.xml</code>, <code>.xml.gz</code>, <code>.xml.bz2</code> : Portable XML format (very slow and possibly compressed, reserved for debugging)</li>
</ul>
<p>The resultant data files can be examined with the <code>flreconstruct</code> application, see the <a class="el" href="usingflreconstruct.html">dedicated guide</a> for further details.</p>
<p>Note also that FLSimulate automatically computes some metadata besides the simulated events. These metadata are stored by default within the output data file itself. These metadata can be reused in the context of the data reconstruction or other analysis tools. It is also possible to save the metadata container within a human readable companion file (using the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1multi__properties.html">datatools::multi_properties</a></code> format) using the <code>--output-metadata-file</code> switch. Example:</p>
<div class="fragment"><div class="line">$ flsimulate -c simu.conf -o example.brio --output-metadata-file example.meta</div><div class="line">...</div></div><!-- fragment --><p>In case the user does not choose to store the metadata in the output data file and no explicit external metadata file is selected, a default one is generated with name <code>__flsimulate-metadata.log</code>.</p>
<h1><a class="anchor" id="usingflsimulate_outputmetadata"></a>
Output metadata </h1>
<p>Each FLSimulate run produces a set of <em>context sensitive</em> data, known as <em>metadata</em>. A set of metadata is thus created just before the simulation run starts. It contains informations about the simulation's configuration setup and inputs, arranged in sections (general, simulation, digitization, variants, services...) in the same way the configuration script is organized. This enables the off line check of the simulation parameters.</p>
<p>As mentionned above, metadata is saved by default in the output data file, through some kind of header (XML) or parallel branch (BRIO). If asked on the command line (<code>-m</code> or <code>--output-metadata-file</code> switch), FLSimulate also saves metadata using the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1multi__properties.html">datatools::multi_properties</a></code> format in an external companion file (default name is: <code>__flsimulate-metadata.log</code>).</p>
<h1><a class="anchor" id="usingflsimulate_userprofiles"></a>
User profiles </h1>
<p>Falaise proposes three <em>user profiles</em> for the Monte Carlo production:</p>
<ul>
<li><code>expert</code> : reserved for <em>expert</em> users who are able to hack/corrupt/distort the Falaise and FLSimulate systems thanks to a large set of options and features,</li>
<li><code>normal</code> : for <em>normal</em> users with a smaller set of options and features; this is the default profile,</li>
<li><code>production</code> : this mode should be reserved for official production of Monte Carlo data; some options and features are inhibited to prevent from generating data with ambiguous or non official configuration(s).</li>
</ul>
<p>!TODO give details about what can/cannot be done within each user profile.</p>
<h1><a class="anchor" id="usingflsimulate_examples"></a>
Examples </h1>
<h2><a class="anchor" id="usingflsimulate_examples_example1"></a>
Example 1 : using FLSimulate with a configuration script </h2>
<p>Here we want to simulate 10 Tl-208 events from the bulk volume of the tracker cells' field wires in the full Demonstrator.</p>
<ol type="1">
<li>Prepare the following <code>simu.conf</code> script: <div class="fragment"><div class="line">#@description Main flsimulate configuration script</div><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;flsimulate&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">numberOfEvents : integer = 10</div><div class="line"></div><div class="line">[name=&quot;flsimulate.variantService&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">settings : string[3] = \</div><div class="line">  &quot;vertexes:generator=field_wire_bulk&quot; \</div><div class="line">  &quot;primary_events:generator=Tl208&quot; \</div><div class="line">  &quot;simulation:output_profile=all_details&quot;</div></div><!-- fragment --></li>
<li>Run <code>flsimulate</code>: <div class="fragment"><div class="line">$ flsimulate -c simu.conf -o example.brio</div><div class="line">...</div></div><!-- fragment --> Here we use the <em>brio</em> format. This binary format is not user friendly and we cannot display its contents with standard tools.</li>
<li>You may display the events with: <div class="fragment"><div class="line">$ flvisualize -i example.brio</div><div class="line">...</div></div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="usingflsimulate_examples_example2"></a>
Example 2 : using FLSimulate with a configuration script and an explicit variant profile </h2>
<p>Here we use the same simulation setup than in case 2:</p>
<ol type="1">
<li>Prepare the following <code>variant.profile</code> file: <div class="fragment"><div class="line">$ flsimulate-configure \</div><div class="line">    --no-gui \</div><div class="line">    -t urn:snemo:demonstrator:simulation:2.1 \</div><div class="line">    -s &quot;geometry:layout=Basic&quot; \</div><div class="line">    -s &quot;vertexes:generator=field_wire_bulk&quot; \</div><div class="line">    -s &quot;primary_events:generator=Tl208&quot; \</div><div class="line">    -s &quot;simulation:output_profile=all_details&quot; \</div><div class="line">    -o &quot;variant.profile&quot;</div></div><!-- fragment --> Note the list of <code>--variant-set</code> switches used to select the options. We obtain the following profile: <div class="fragment"><div class="line">#@format=datatools::configuration::variant</div><div class="line">#@format.version=1.0</div><div class="line">#@organization=snemo</div><div class="line">#@application=falaise</div><div class="line"></div><div class="line">[registry=&quot;geometry&quot;]</div><div class="line">layout = &quot;Basic&quot;</div><div class="line">layout/if_basic/magnetic_field = true</div><div class="line">layout/if_basic/magnetic_field/is_active/type = &quot;UniformVertical&quot;</div><div class="line">layout/if_basic/magnetic_field/is_active/type/if_uniform_vertical/magnitude = 25 gauss</div><div class="line">layout/if_basic/magnetic_field/is_active/type/if_uniform_vertical/direction = &quot;+z&quot;</div><div class="line">layout/if_basic/source_layout = &quot;Basic&quot;</div><div class="line">layout/if_basic/source_layout/if_basic/thickness = 250 um</div><div class="line">layout/if_basic/source_layout/if_basic/material = &quot;Se82&quot;</div><div class="line">layout/if_basic/source_calibration = false</div><div class="line">layout/if_basic/shielding = true</div><div class="line">calo_film_thickness = 25 um</div><div class="line"></div><div class="line">[registry=&quot;vertexes&quot;]</div><div class="line">generator = &quot;field_wire_bulk&quot;</div><div class="line"></div><div class="line">[registry=&quot;primary_events&quot;]</div><div class="line">generator = &quot;Tl208&quot;</div><div class="line"></div><div class="line">[registry=&quot;simulation&quot;]</div><div class="line">physics_mode = &quot;Constructors&quot;</div><div class="line">physics_mode/if_constructors/em_model = &quot;standard&quot;</div><div class="line">production_cuts = true</div><div class="line">output_profile = &quot;all_details&quot;</div></div><!-- fragment --></li>
<li>Prepare the following <code>simu.conf</code> script: <div class="fragment"><div class="line">#@description Main flsimulate configuration script</div><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;flsimulate&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">numberOfEvents : integer = 10</div><div class="line"></div><div class="line">[name=&quot;flsimulate.variantService&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">profile : string as path = &quot;variant.profile&quot;</div></div><!-- fragment --></li>
<li>Run <code>flsimulate</code>: <div class="fragment"><div class="line">$ flsimulate -c simu.conf -o example.data.gz</div><div class="line">...</div></div><!-- fragment --></li>
<li>Display the events: <div class="fragment"><div class="line">$ flvisualize -i example.data.gz</div><div class="line">...</div></div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="usingflsimulate_examples_example3"></a>
Example 3 : using FLSimulate with an explicit configuration, profile and seeds </h2>
<p>Here we use again the same simulation setup than in examples 1 and 2.</p>
<ol type="1">
<li>Generate a set of seeds: <div class="fragment"><div class="line">$ bxg4_seeds -k -d . -T -p seeds.conf</div></div><!-- fragment --></li>
<li>Generate the <code>variant.profile</code> file: <div class="fragment"><div class="line">$ flsimulate-configure \</div><div class="line">    --no-gui \</div><div class="line">    -t urn:snemo:demonstrator:simulation:2.1 \</div><div class="line">    -s &quot;geometry:layout=Basic&quot; \</div><div class="line">    -s &quot;vertexes:generator=field_wire_bulk&quot; \</div><div class="line">    -s &quot;primary_events:generator=Tl208&quot; \</div><div class="line">    -s &quot;simulation:output_profile=none&quot; \</div><div class="line">    -o &quot;variant.profile&quot;</div></div><!-- fragment --></li>
<li>Prepare the following <code>simu.conf</code> script: <div class="fragment"><div class="line">#@description Main flsimulate configuration script</div><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;flsimulate&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">numberOfEvents : integer = 10</div><div class="line"></div><div class="line">[name=&quot;flsimulate.simulation&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">rngSeedFile : string as path = &quot;seeds.conf&quot;</div><div class="line"></div><div class="line">[name=&quot;flsimulate.variantService&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">profile : string as path = &quot;variant.profile&quot;</div></div><!-- fragment --></li>
<li>Run <code>flsimulate</code> twice: <div class="fragment"><div class="line">$ flsimulate -c simu.conf -o example.xml</div><div class="line">...</div><div class="line">$ flsimulate -c simu.conf -o example2.xml</div><div class="line">...</div></div><!-- fragment --></li>
<li>Check that both generated files have strictly the same contents: <div class="fragment"><div class="line">$ diff example.xml example2.xml</div><div class="line">$ echo $?</div><div class="line">0</div></div><!-- fragment --></li>
<li>Display the events: <div class="fragment"><div class="line">$ flvisualize -i example.xml</div><div class="line">...</div></div><!-- fragment --> </li>
</ol>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
