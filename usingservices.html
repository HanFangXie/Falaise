<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Falaise: Using Services in FLReconstruct Modules</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Falaise
   &#160;<span id="projectnumber">4.0.1</span>
   </div>
   <div id="projectbrief">SuperNEMO Software Toolkit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Using Services in FLReconstruct Modules </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="useservices_introduction"></a>
Introduction </h1>
<p>If you have just started using Falaise or the FLReconstruct application, we strongly recommend that you familiarize yourself with the basic usage of FLReconstruct covered in <a class="el" href="usingflreconstruct.html">The FLReconstruct Application</a>. You should also be familiar with composing and using pipeline modules, as covered in <a class="el" href="writingflreconstructmodules.html">Writing FLReconstruct Modules</a>.</p>
<p>In FLReconstruct, modules are the basic "unit" for processing events. Each event stores data relevant to that event, but creation, use, and interpretation of this data may require other data which common to a set of events (e.g. a detector run). These data are supplied through <em>Services</em>.</p>
<p>Your module can access any services it needs via the <a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1service__manager.html">datatools::service_manager</a> reference supplied to its constructor by the flreconstruct application. From this, you can get a smart pointer to a current service.</p>
<p>In this tutorial, we will see how to implement a module requiring the <a class="el" href="classsnemo_1_1geometry__svc.html">snemo::geometry_svc</a> service.</p>
<h1><a class="anchor" id="useservices_module"></a>
Implementing a Service-Aware Module </h1>
<h2>Source Code for Service-Awareness </h2>
<p>This tutorial builds on the basic module implemented in <a class="el" href="writingflreconstructmodules.html">Writing FLReconstruct Modules</a>. You should therefore have a workspace and module sources arranged as</p>
<div class="fragment"><div class="line">$ cd MyWorkspace</div><div class="line">$ ls</div><div class="line">MyModule</div><div class="line">$ cd MyModule</div><div class="line">$ ls</div><div class="line">CMakeLists.txt         MyModulePipeline.conf</div><div class="line">MyModule.cpp           MyModulePipeline2.conf</div><div class="line">$</div></div><!-- fragment --><p>The <code>CMakeLists.txt</code> build script and <code>.conf</code> pipeline scripts are identical to the earlier tutorial. We begin by modifying the module's implementation as follows:</p>
<div class="fragment"><div class="line"><span class="comment">// Interface from Falaise</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="module_8h.html">falaise/snemo/processing/module.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="geometry_8h.html">falaise/snemo/services/geometry.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>MyModule {</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  <span class="comment">// Default constructor</span></div><div class="line">  MyModule() = <span class="keywordflow">default</span>;</div><div class="line"></div><div class="line">  <span class="comment">// User-defined Constructor</span></div><div class="line">  MyModule(<a class="code" href="classfalaise_1_1config_1_1property__set.html">falaise::config::property_set</a> <span class="keyword">const</span>&amp; <span class="comment">/*ps*/</span>, <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1service__manager.html">datatools::service_manager</a>&amp; sp)</div><div class="line">      : geosvc{sp} {}</div><div class="line"></div><div class="line">  <span class="comment">// Process event</span></div><div class="line">  <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fb">falaise::processing::status</a> process(<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a>&amp; <span class="comment">/*e*/</span>) {</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;MyModule::process called!\n&quot;</span>;</div><div class="line">    geosvc-&gt;<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1service__manager.html#a06c39c212ed53f1bf719c69b2acc42a6">tree_dump</a>(std::cout);</div><div class="line">    <span class="keywordflow">return</span> falaise::processing::status::PROCESS_OK;</div><div class="line">  }</div><div class="line"></div><div class="line"> <span class="keyword">private</span>:</div><div class="line">  <a class="code" href="classsnemo_1_1service__handle.html">snemo::service_handle&lt;snemo::geometry_svc&gt;</a> geosvc;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// Register module with Falaise&#39;s plugin system on load</span></div><div class="line"><a class="code" href="module_8h.html#a63c0e69cd4edd7150e04dd18e3de1358">FALAISE_REGISTER_MODULE</a>(MyModule)</div></div><!-- fragment --><p>The changes are pretty simple:</p>
<ol type="1">
<li>The service is held as a data member of type <code><a class="el" href="classsnemo_1_1service__handle.html" title="Semi-smart pointer holding a service interface.">snemo::service_handle</a>&lt;<a class="el" href="classsnemo_1_1geometry__svc.html" title="Locate, track, and trace elements of the SuperNEMO detector geometry.">snemo::geometry_svc</a>&gt;</code><ul>
<li><a class="el" href="classsnemo_1_1service__handle.html">snemo::service_handle</a> is the "smart pointer" holding the service implementation</li>
<li><a class="el" href="classsnemo_1_1geometry__svc.html">snemo::geometry_svc</a> is the type of the service implementation we need.</li>
</ul>
</li>
<li>The service is initialized by in <code>MyModule</code>'s constructor from the supplied <a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1service__manager.html">datatools::service_manager</a> instance.</li>
<li>The service is used in the <code>process</code> member function, here for illustration only by calling the <code>tree_dump</code> member function of the held <a class="el" href="classsnemo_1_1geometry__svc.html">snemo::geometry_svc</a> instance.</li>
</ol>
<p>You do not need to worry about checking that the service is correctly constructed and valid. <a class="el" href="classsnemo_1_1service__handle.html">snemo::service_handle</a> will throw exceptions if:</p>
<ul>
<li>A valid service of the requested type cannot be constructed</li>
<li>The service is accessed (e.g. <code>geosvc-&gt;tree_dump(std::cout)</code>) and is not valid</li>
</ul>
<p>The <code>flreconstruct</code> pipeline with handle these errors and report them on the command line.</p>
<h2>Building and Running a Service-Aware Module </h2>
<p>No special steps are needed to build or run a service-aware module, so you can follow the <a class="el" href="writingflreconstructmodules.html#minimalmodulebuilding">build instructions from the original example</a> and <a class="el" href="writingflreconstructmodules.html#minimalmodulerunning">run the module in the same way</a>.</p>
<h1><a class="anchor" id="useservices_servicelist"></a>
Available Services </h1>
<ul>
<li><a class="el" href="classsnemo_1_1geometry__svc.html">snemo::geometry_svc</a> : queries related to geometric positions, etc in the detector </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
