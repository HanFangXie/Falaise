<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Falaise: Working With Events in FLReconstruct</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Falaise
   &#160;<span id="projectnumber">3.0.0</span>
   </div>
   <div id="projectbrief">SuperNEMO Software Toolkit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Working With Events in FLReconstruct </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#workingwitheventrecords_introduction">Introduction to event record </a></li>
<li class="level1"><a href="#workingwitheventrecords_things_readingdata">Reading Data from datatools::things Instances </a></li>
<li class="level1"><a href="#things_writingdata">Writing Data to datatools::things Instances </a></li>
<li class="level1"><a href="#things_customdata">Implementing Custom Objects for Storage in datatools::things </a></li>
<li class="level1"><a href="#things_customdata_serialization">Serializing Custom Objects to Persistant Files/Archives </a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="workingwitheventrecords_introduction"></a>
Introduction to event record </h1>
<p>The C++ type used to represent events in <code>flreconstruct</code> is the <a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a> class. Pipeline module classes inherit from <a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html">dpp::base_module</a> and thus must implement the pure abstract method <a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#a8ef4d1b3d5951955116946196e3f5ba4">dpp::base_module::process</a> . This method is called for each event, and is passed a reference to the mutable <a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a> object representing the current event being passed through the pipeline.</p>
<p>The <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> class implements an associative, hierarchical and heterogenous collection of objects. To put it in simpler terms, it provides a dictionary mapping string "keys" to object instances inheriting from the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1i__serializable.html">datatools::i_serializable</a></code> pure abstract base class. It's the dictionary like interface that provides the associativity, and the storage of pointer-to-base-class that provides the heterogeneity (many different concrete types). As <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> itself inherits from <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1i__serializable.html">datatools::i_serializable</a></code>, it is capable of storing other <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> instances, providing the possibility of arranging objects in a tree-like structure.</p>
<p>In this tutorial, we'll look at three basic aspects of working with <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> instances provided to the <code>process</code> method of your custom pipeline module,</p>
<ol type="1">
<li>Reading data from the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> instance</li>
<li>Writing builtin objects to the instance</li>
<li>Implementing custom objects for storage in <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code></li>
</ol>
<h1><a class="anchor" id="workingwitheventrecords_things_readingdata"></a>
Reading Data from datatools::things Instances </h1>
<p>To work with events in the pipeline we first need to implement a pipeline module to do this. The basics of how to do this are covered in <a class="el" href="writingflreconstructmodules.html">a dedicated tutorial</a> and you should familiarize yourself with this material as this tutorial will build on it.</p>
<p>First of all we implement our module, build it and write a pipeline script to use it in <code>flreconstruct</code>. Note that we have stripped all comments except those relating to the process methods, and that the module takes no configuration. If you require details on how to implement a basic flreconstruct method, please refer to the <a class="el" href="writingflreconstructmodules.html">introductory tutorial</a> first. We begin with the header:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef ACCESSTHINGSMODULE_HH</span></div><div class="line"><span class="preprocessor">#define ACCESSTHINGSMODULE_HH</span></div><div class="line"><span class="preprocessor">#include &quot;bayeux/dpp/base_module.h&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>AccessThingsModule : <span class="keyword">public</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html">dpp::base_module</a> {</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  AccessThingsModule();</div><div class="line">  <span class="keyword">virtual</span> ~AccessThingsModule();</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#a23902ec59ce6bd2f930575f20e8d2d56">initialize</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1properties_1_1basic__key__validator.html">datatools::properties</a>&amp; myConfig,</div><div class="line">                          <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1service__manager.html">datatools::service_manager</a>&amp; flServices,</div><div class="line">                          <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacedpp.html#ac44582f8a6edf81cf4a8708ba42bb0d7">dpp::module_handle_dict_type</a>&amp; what);</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fb">dpp::base_module::process_status</a> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#a8ef4d1b3d5951955116946196e3f5ba4">process</a>(<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1things_1_1entry__type.html">datatools::things</a>&amp; workItem);</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#a0e2182e3b2486fa9e9a2eaff6ea43773">reset</a>();</div><div class="line"></div><div class="line"> <span class="keyword">private</span>:</div><div class="line">  DPP_MODULE_REGISTRATION_INTERFACE(AccessThingsModule);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="preprocessor">#endif // ACCESSTHINGSMODULE_HH</span></div></div><!-- fragment --><p>and now the implementation:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;AccessThingsModule.h&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;boost/foreach.hpp&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;bayeux/mctools/simulated_data.h&quot;</span></div><div class="line"></div><div class="line">DPP_MODULE_REGISTRATION_IMPLEMENT(AccessThingsModule,<span class="stringliteral">&quot;AccessThingsModule&quot;</span>);</div><div class="line"></div><div class="line">AccessThingsModule::AccessThingsModule() : <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacedpp.html">dpp</a>::base_module()</div><div class="line">{}</div><div class="line"></div><div class="line">AccessThingsModule::~AccessThingsModule() {</div><div class="line">  <span class="keywordflow">if</span> (<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacebayeux.html#a0a85cbdd2a66e4856095ddcd81256e5a">is_initialized</a>()) this-&gt;<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacedatatools_1_1ui_1_1ansi__colors.html#a78c6ee9526a9347d85718f8f7c6a7ce3">reset</a>();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> AccessThingsModule::initialize(<span class="keyword">const</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1properties_1_1basic__key__validator.html">datatools::properties</a>&amp; <span class="comment">/*myConfig*/</span>,</div><div class="line">                          <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1service__manager.html">datatools::service_manager</a>&amp; <span class="comment">/*flServices*/</span>,</div><div class="line">                          <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacedpp.html#ac44582f8a6edf81cf4a8708ba42bb0d7">dpp::module_handle_dict_type</a>&amp; <span class="comment">/*moduleDict*/</span>) {</div><div class="line">  this-&gt;_set_initialized(<span class="keyword">true</span>);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">//! [AccessThingsModule::Process]</span></div><div class="line"><span class="comment"></span><a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fb">dpp::base_module::process_status</a></div><div class="line">AccessThingsModule::process(<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1things_1_1entry__type.html">datatools::things</a>&amp; workItem) {</div><div class="line">  <span class="comment">// Print most basic information</span></div><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;AccessThingsModule::process called!&quot;</span> &lt;&lt; std::endl;</div><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;[name]        : &quot;</span> &lt;&lt; workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#a4c997ae452b0ed9c4d1332215778329a">get_name</a>() &lt;&lt; std::endl;</div><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;[description] : &quot;</span> &lt;&lt; workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#a34691a0cdf236da3123ec6cbe87b25f3">get_description</a>() &lt;&lt; std::endl;</div><div class="line"></div><div class="line">  <span class="comment">// Extract list of keys stored by the object</span></div><div class="line">  std::vector&lt;std::string&gt; workItemKeyList;</div><div class="line">  workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#afb6ad984d68833d0e523aa18b3ff4b32">get_names</a>(workItemKeyList);</div><div class="line"></div><div class="line">  <span class="comment">// Iterate over keys, printing their name and the type of the object</span></div><div class="line">  <span class="comment">// they map to</span></div><div class="line">  BOOST_FOREACH(std::string key, workItemKeyList) {</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;- [key, serial_tag] : &quot;</span></div><div class="line">              &lt;&lt; key</div><div class="line">              &lt;&lt; <span class="stringliteral">&quot;, &quot;</span></div><div class="line">              &lt;&lt; workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#a8cf0156cc4de67b0db98e16906d100a9">get_entry_serial_tag</a>(key)</div><div class="line">              &lt;&lt; std::endl;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Grab simulated data bank</span></div><div class="line">  <span class="comment">// Simulated data will only be present in simulation output files,</span></div><div class="line">  <span class="comment">// so wrap in a try block</span></div><div class="line">  <span class="keywordflow">try</span> {</div><div class="line">    <span class="keyword">const</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classmctools_1_1simulated__data.html">mctools::simulated_data</a>&amp; simData = workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#ae25dcb9db6842b22f0120dcc217f0856">get</a>&lt;<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classmctools_1_1simulated__data.html">mctools::simulated_data</a>&gt;(<span class="stringliteral">&quot;SD&quot;</span>);</div><div class="line">    simData.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classmctools_1_1simulated__data.html#a7a38080ffeb5c5d227f9a396fb892c6e">tree_dump</a>();</div><div class="line">  } <span class="keywordflow">catch</span> (std::logic_error&amp; e) {</div><div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;failed to grab SD bank : &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div><div class="line">    <span class="keywordflow">return</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fbac20a7087afe9ad452ccfd43adac9f75a">dpp::base_module::PROCESS_INVALID</a>;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// MUST return a status, see ref dpp::processing_status_flags_type</span></div><div class="line">  <span class="keywordflow">return</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fbac1745017d77e86b4b276caabbbb5ddfc">dpp::base_module::PROCESS_OK</a>;</div><div class="line">}<span class="comment"></span></div><div class="line"><span class="comment">//! [AccessThingsModule::Process]</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">void</span> AccessThingsModule::reset() {</div><div class="line">  this-&gt;_set_initialized(<span class="keyword">false</span>);</div><div class="line">}</div></div><!-- fragment --><p>The key method to look at is <code>AccessThings::process</code> which as we've seen before is passed a reference to the current event in the pipeline.</p>
<p>We begin working with the event by simply printing its name and description. This is a trivial demonstration that the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> interface works, as for event date these are likely to be blank.</p>
<p>The second, more relevant task, is to extract the list of keys, and thus data banks, stored in the event. Here, we use the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#afb6ad984d68833d0e523aa18b3ff4b32">datatools::things::get_names</a></code> method to fill a <code>std::vector</code> with the key names. We then iterate over this vector to print out the key name and, by using the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#a8cf0156cc4de67b0db98e16906d100a9">datatools::things::get_entry_serial_tag</a></code> method, typename of the object it maps to.</p>
<div class="fragment"><div class="line"><span class="comment">// Extract list of keys stored by the object</span></div><div class="line">std::vector&lt;std::string&gt; workItemKeyList;</div><div class="line">workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#afb6ad984d68833d0e523aa18b3ff4b32">get_names</a>(workItemKeyList);</div><div class="line"></div><div class="line"><span class="comment">// Iterate over keys, printing their name and the type of the object</span></div><div class="line"><span class="comment">// they map to</span></div><div class="line">BOOST_FOREACH(std::string key, workItemKeyList) {</div><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;- [key, serial_tag] : &quot;</span></div><div class="line">            &lt;&lt; key</div><div class="line">            &lt;&lt; <span class="stringliteral">&quot;, &quot;</span></div><div class="line">            &lt;&lt; workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#a8cf0156cc4de67b0db98e16906d100a9">get_entry_serial_tag</a>(key)</div><div class="line">            &lt;&lt; std::endl;</div><div class="line">}</div></div><!-- fragment --><p>If we know the type of the key we wish to extract, we can use the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#ae25dcb9db6842b22f0120dcc217f0856">datatools::things::get</a></code> method to obtain a reference to it.</p>
<div class="fragment"><div class="line"><span class="keywordflow">try</span> {</div><div class="line">  <span class="keyword">const</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classmctools_1_1simulated__data.html">mctools::simulated_data</a>&amp; simData = workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#ae25dcb9db6842b22f0120dcc217f0856">get</a>&lt;<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classmctools_1_1simulated__data.html">mctools::simulated_data</a>&gt;(<span class="stringliteral">&quot;SD&quot;</span>);</div><div class="line">  simData.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classmctools_1_1simulated__data.html#a7a38080ffeb5c5d227f9a396fb892c6e">tree_dump</a>();</div><div class="line">} <span class="keywordflow">catch</span> (std::logic_error&amp; e) {</div><div class="line">  std::cerr &lt;&lt; <span class="stringliteral">&quot;failed to grab SD bank : &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div><div class="line">  <span class="keywordflow">return</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fba79ec090dd9766c037f530f60aa735204">dpp::base_module::PROCESS_ERROR</a>;</div><div class="line">}</div></div><!-- fragment --><p>We know that the "SD" ( <b>S</b> imulated <b>D</b> ata) entry should map to an instance of <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classmctools_1_1simulated__data.html">mctools::simulated_data</a></code> so we use the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#ae25dcb9db6842b22f0120dcc217f0856">datatools::things::get</a></code> method to obtain a const reference to it (const being read only). This method takes a template argument which is the typename we want to extract, and a function argument which is the name of the key to get. The method will throw an exception if either</p>
<ul>
<li>The key does not exist.</li>
<li>The key exists, but it does not map to the requested type</li>
</ul>
<p>We therefore wrap the extraction in a try-catch block to handle both of these potential errors. If we're able to get the reference to the object, then we can use it directly. In this example, we simply use the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classmctools_1_1simulated__data.html#a7a38080ffeb5c5d227f9a396fb892c6e">mctools::simulated_data::tree_dump</a></code> method to dump some information on the object to screen. You should consult the documentation of the classes extracted to see what you can do with them. If an exception is thrown, then we report the error to the standard error stream, and return the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fbac20a7087afe9ad452ccfd43adac9f75a">dpp::base_module::PROCESS_INVALID</a></code> flag. This will make the pipeline abort any further processing of the event and subsequent events, but other flags are available to handle a range of process errors.</p>
<p>To see the effect of this reading, we compile the above code into a shared library just as before using the following CMake script:</p>
<div class="fragment"><div class="line"><span class="preprocessor"># - Basic CMake setup</span></div><div class="line"><span class="preprocessor"># Check version meets ou requirements</span></div><div class="line"><span class="preprocessor"># Declare project, which will configure compiler for us</span></div><div class="line">cmake_minimum_required(VERSION 3.3)</div><div class="line">project(AccessThingsModule)</div><div class="line"></div><div class="line"><span class="preprocessor"># Modules use FalaiseBayeux, so we need to locate this or fail</span></div><div class="line"><span class="preprocessor"># Locating Falaise will automatically locate all of its</span></div><div class="line"><span class="preprocessor"># dependencies such as Bayeux, ROOT and Boost.</span></div><div class="line">find_package(Falaise 2.1.0 REQUIRED)</div><div class="line"></div><div class="line"><span class="preprocessor"># Build a dynamic library from our sources</span></div><div class="line">add_library(AccessThingsModule SHARED AccessThingsModule.h AccessThingsModule.cpp)</div><div class="line"></div><div class="line"><span class="preprocessor"># Link it to the FalaiseModule library</span></div><div class="line"><span class="preprocessor"># This ensures the correct compiler flags, include paths</span></div><div class="line"><span class="preprocessor"># and linker flags are applied to our dynamic library.</span></div><div class="line">target_link_libraries(AccessThingsModule PUBLIC FalaiseModule)</div><div class="line"></div></div><!-- fragment --><p>and run <code>flreconstruct</code> with the following pipeline script:</p>
<p>To see the effect of this writing, we compile the above code into a shared library just as before using the following CMake script:</p>
<div class="fragment"><div class="line">#@description AccessThings Pipeline</div><div class="line">#@key_label   &quot;name&quot;</div><div class="line">#@meta_label  &quot;type&quot;</div><div class="line"></div><div class="line"># - Custom modules</div><div class="line">[name=&quot;flreconstruct.plugins&quot; type=&quot;&quot;]</div><div class="line">plugins : string[1] = &quot;AccessThingsModule&quot;</div><div class="line">AccessThingsModule.directory : string = &quot;.&quot;</div><div class="line"></div><div class="line"># - Pipeline configuration</div><div class="line">[name=&quot;pipeline&quot; type=&quot;AccessThingsModule&quot;]</div><div class="line"></div></div><!-- fragment --><p>You should see output similar to the dump modules we ran in earlier tutorials.</p>
<h1><a class="anchor" id="things_writingdata"></a>
Writing Data to datatools::things Instances </h1>
<p>As the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> instance is passed to pipeline modules by non-const reference, it is directly modifiable by your module. This means your module can store results of working with the event back into the event for later modules to use (you can of course also delete existing data, so be careful!).</p>
<p>Instances of <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> can only store objects that inherit from the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1i__serializable.html">datatools::i_serializable</a></code> abstract base class, so this restricts the types your module can add. For now we will just look at how to store an existing concrete class of <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1i__serializable.html">datatools::i_serializable</a></code> in <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code>, specifically, the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1properties.html">datatools::properties</a></code> class. The use case of adding you own concrete classes of <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1i__serializable.html">datatools::i_serializable</a></code> is deferred to a <a class="el" href="workingwitheventrecords.html#things_customdata">later tutorial in this guide</a>.</p>
<p>We begin by refactoring the <code>process</code> method of our module into read and write parts, first the header</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef ACCESSTHINGSMODULE_HH</span></div><div class="line"><span class="preprocessor">#define ACCESSTHINGSMODULE_HH</span></div><div class="line"><span class="preprocessor">#include &quot;bayeux/dpp/base_module.h&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>AccessThingsModule : <span class="keyword">public</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html">dpp::base_module</a> {</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  AccessThingsModule();</div><div class="line">  <span class="keyword">virtual</span> ~AccessThingsModule();</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#a23902ec59ce6bd2f930575f20e8d2d56">initialize</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1properties_1_1basic__key__validator.html">datatools::properties</a>&amp; myConfig,</div><div class="line">                          <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1service__manager.html">datatools::service_manager</a>&amp; flServices,</div><div class="line">                          <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacedpp.html#ac44582f8a6edf81cf4a8708ba42bb0d7">dpp::module_handle_dict_type</a>&amp; what);</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fb">dpp::base_module::process_status</a> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#a8ef4d1b3d5951955116946196e3f5ba4">process</a>(<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1things_1_1entry__type.html">datatools::things</a>&amp; workItem);</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#a0e2182e3b2486fa9e9a2eaff6ea43773">reset</a>();</div><div class="line"></div><div class="line"> <span class="keyword">private</span>:</div><div class="line">  <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fb">dpp::base_module::process_status</a> read(<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1things_1_1entry__type.html">datatools::things</a>&amp; workItem);</div><div class="line">  <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fb">dpp::base_module::process_status</a> write(<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1things_1_1entry__type.html">datatools::things</a>&amp; workItem);</div><div class="line"></div><div class="line">  DPP_MODULE_REGISTRATION_INTERFACE(AccessThingsModule);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="preprocessor">#endif // ACCESSTHINGSMODULE_HH</span></div><div class="line"></div></div><!-- fragment --><p>and then the implementation</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;AccessThingsModule.h&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;boost/foreach.hpp&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;bayeux/mctools/simulated_data.h&quot;</span></div><div class="line"></div><div class="line">DPP_MODULE_REGISTRATION_IMPLEMENT(AccessThingsModule,<span class="stringliteral">&quot;AccessThingsModule&quot;</span>);</div><div class="line"></div><div class="line">AccessThingsModule::AccessThingsModule() : <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacedpp.html">dpp</a>::base_module()</div><div class="line">{}</div><div class="line"></div><div class="line">AccessThingsModule::~AccessThingsModule() {</div><div class="line">  this-&gt;<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacedatatools_1_1ui_1_1ansi__colors.html#a78c6ee9526a9347d85718f8f7c6a7ce3">reset</a>();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> AccessThingsModule::initialize(<span class="keyword">const</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1properties_1_1basic__key__validator.html">datatools::properties</a>&amp; <span class="comment">/*myConfig*/</span>,</div><div class="line">                          <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1service__manager.html">datatools::service_manager</a>&amp; <span class="comment">/*flServices*/</span>,</div><div class="line">                          <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacedpp.html#ac44582f8a6edf81cf4a8708ba42bb0d7">dpp::module_handle_dict_type</a>&amp; <span class="comment">/*moduleDict*/</span>) {</div><div class="line">  this-&gt;_set_initialized(<span class="keyword">true</span>);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">//! [AccessThingsModule::Process]</span></div><div class="line"><span class="comment"></span><a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fb">dpp::base_module::process_status</a> AccessThingsModule::process(</div><div class="line">    <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1things_1_1entry__type.html">datatools::things</a>&amp; workItem) {</div><div class="line">  process_status readStatus = this-&gt;read(workItem);</div><div class="line">  <span class="keywordflow">if</span> (readStatus != PROCESS_OK) <span class="keywordflow">return</span> readStatus;</div><div class="line"></div><div class="line">  process_status writeStatus = this-&gt;write(workItem);</div><div class="line"></div><div class="line">  <span class="comment">// MUST return a status, see ref dpp::processing_status_flags_type</span></div><div class="line">  <span class="keywordflow">return</span> writeStatus;</div><div class="line">}<span class="comment"></span></div><div class="line"><span class="comment">//! [AccessThingsModule::Process]</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">void</span> AccessThingsModule::reset() {</div><div class="line">  this-&gt;_set_initialized(<span class="keyword">false</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fb">dpp::base_module::process_status</a> AccessThingsModule::read(<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1things_1_1entry__type.html">datatools::things</a>&amp; workItem) {</div><div class="line">  <span class="comment">// Print most basic information</span></div><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;AccessThingsModule::process called!&quot;</span> &lt;&lt; std::endl;</div><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;[name]        : &quot;</span> &lt;&lt; workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#a4c997ae452b0ed9c4d1332215778329a">get_name</a>() &lt;&lt; std::endl;</div><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;[description] : &quot;</span> &lt;&lt; workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#a34691a0cdf236da3123ec6cbe87b25f3">get_description</a>() &lt;&lt; std::endl;</div><div class="line"></div><div class="line">  <span class="comment">// Extract list of keys stored by the object</span></div><div class="line">  std::vector&lt;std::string&gt; workItemKeyList;</div><div class="line">  workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#afb6ad984d68833d0e523aa18b3ff4b32">get_names</a>(workItemKeyList);</div><div class="line"></div><div class="line">  <span class="comment">// Iterate over keys, printing their name and the type of the object</span></div><div class="line">  <span class="comment">// they map to</span></div><div class="line">  BOOST_FOREACH(std::string key, workItemKeyList) {</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;- [key, serial_tag] : &quot;</span></div><div class="line">              &lt;&lt; key</div><div class="line">              &lt;&lt; <span class="stringliteral">&quot;, &quot;</span></div><div class="line">              &lt;&lt; workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#a8cf0156cc4de67b0db98e16906d100a9">get_entry_serial_tag</a>(key)</div><div class="line">              &lt;&lt; std::endl;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Grab simulated data bank</span></div><div class="line">  <span class="comment">// Simulated data will only be present in simulation output files,</span></div><div class="line">  <span class="comment">// so wrap in a try block</span></div><div class="line">  <span class="keywordflow">try</span> {</div><div class="line">    <span class="keyword">const</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classmctools_1_1simulated__data.html">mctools::simulated_data</a>&amp; simData = workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#ae25dcb9db6842b22f0120dcc217f0856">get</a>&lt;<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classmctools_1_1simulated__data.html">mctools::simulated_data</a>&gt;(<span class="stringliteral">&quot;SD&quot;</span>);</div><div class="line">    simData.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classmctools_1_1simulated__data.html#a7a38080ffeb5c5d227f9a396fb892c6e">tree_dump</a>();</div><div class="line">  } <span class="keywordflow">catch</span> (std::logic_error&amp; e) {</div><div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;failed to grab SD bank : &quot;</span> &lt;&lt; e.what() &lt;&lt; std::endl;</div><div class="line">    <span class="keywordflow">return</span> PROCESS_INVALID;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> PROCESS_OK;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">//! [AccessThingsModule::write]</span></div><div class="line"><span class="comment"></span><a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fb">dpp::base_module::process_status</a> AccessThingsModule::write(<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1things_1_1entry__type.html">datatools::things</a>&amp; workItem) {</div><div class="line">  <span class="comment">// Add a new entry to the things</span></div><div class="line">  <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1properties_1_1basic__key__validator.html">datatools::properties</a>&amp; atmProperties = workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#a71e43e4d44db3b4adce071b052153bfe">add</a>&lt;<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1properties_1_1basic__key__validator.html">datatools::properties</a>&gt;(<span class="stringliteral">&quot;ATMProperties&quot;</span>);</div><div class="line">  atmProperties.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1properties.html#a7307aa9ac38ed78321effc896094fe48">set_description</a>(<span class="stringliteral">&quot;Properties added by the AccessThings Module&quot;</span>);</div><div class="line">  atmProperties.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1properties.html#ab2df230748213ab1e7ddb9e8d69890c0">store</a>(<span class="stringliteral">&quot;foo&quot;</span>, <span class="stringliteral">&quot;bar&quot;</span>);</div><div class="line">  atmProperties.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1properties.html#ab2df230748213ab1e7ddb9e8d69890c0">store</a>(<span class="stringliteral">&quot;baz&quot;</span>, 3.14);</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> PROCESS_OK;</div><div class="line">}</div></div><!-- fragment --><p>This separation is done for clarity in this example, but it illustrates that your <code>process</code> method need not be monolithic (and in fact shouldn't be except for trivial cases). The <code>read</code> method is exactly as we implemented earlier. In the <code>write</code> method, we use the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#a71e43e4d44db3b4adce071b052153bfe">datatools::things::add</a></code> method to add new data bank to the event holding a <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1properties.html">datatools::properties</a></code> instance. We pass this method a template argument indicating the type of the data bank, and a string function argument indicating the key under which to store the new data bank. The method returns a reference to the newly created instance so it can be modified in place, as we do by setting the description and adding two properties.</p>
<p>To see the effect of this writing, we compile the above code into a shared library just as before using the following CMake script:</p>
<div class="fragment"><div class="line"><span class="preprocessor"># - Basic CMake setup</span></div><div class="line"><span class="preprocessor"># Check version meets ou requirements</span></div><div class="line"><span class="preprocessor"># Declare project, which will configure compiler for us</span></div><div class="line">cmake_minimum_required(VERSION 3.3)</div><div class="line">project(AccessThingsModule)</div><div class="line"></div><div class="line"><span class="preprocessor"># Modules use FalaiseBayeux, so we need to locate this or fail</span></div><div class="line"><span class="preprocessor"># Locating Falaise will automatically locate all of its</span></div><div class="line"><span class="preprocessor"># dependencies such as Bayeux, ROOT and Boost.</span></div><div class="line">find_package(Falaise 2.1.0 REQUIRED)</div><div class="line"></div><div class="line"><span class="preprocessor"># Build a dynamic library from our sources</span></div><div class="line">add_library(AccessThingsModule SHARED AccessThingsModule.h AccessThingsModule.cpp)</div><div class="line"></div><div class="line"><span class="preprocessor"># Link it to the FalaiseModule library</span></div><div class="line"><span class="preprocessor"># This ensures the correct compiler flags, include paths</span></div><div class="line"><span class="preprocessor"># and linker flags are applied to our dynamic library.</span></div><div class="line">target_link_libraries(AccessThingsModule PUBLIC FalaiseModule)</div><div class="line"></div></div><!-- fragment --><p>To see the effect of the writing new banks into the event, we use a pipeline script to sandwich the module between two dump modules as follows</p>
<div class="fragment"><div class="line">#@description AccessThings Pipeline</div><div class="line">#@key_label   &quot;name&quot;</div><div class="line">#@meta_label  &quot;type&quot;</div><div class="line"></div><div class="line"># - Custom modules</div><div class="line">[name=&quot;flreconstruct.plugins&quot; type=&quot;&quot;]</div><div class="line">plugins : string[1] = &quot;AccessThingsModule&quot;</div><div class="line">AccessThingsModule.directory : string = &quot;.&quot;</div><div class="line"></div><div class="line"># - Pipeline configuration</div><div class="line">[name=&quot;pipeline&quot; type=&quot;dpp::chain_module&quot;]</div><div class="line">modules : string[3] = &quot;preprocess&quot; &quot;access_things&quot; &quot;postprocess&quot;</div><div class="line"></div><div class="line">[name=&quot;preprocess&quot; type=&quot;dpp::dump_module&quot;]</div><div class="line">title : string = &quot;PreProcess&quot;</div><div class="line"></div><div class="line">[name=&quot;postprocess&quot; type=&quot;dpp::dump_module&quot;]</div><div class="line">title : string = &quot;PostProcess&quot;</div><div class="line"></div><div class="line">[name=&quot;access_things&quot; type=&quot;AccessThingsModule&quot;]</div><div class="line"></div></div><!-- fragment --><p>You should see that the <code>PostProcess</code> stage results in output containing the information written into the <code>ATMProperties</code> bank.</p>
<h1><a class="anchor" id="things_customdata"></a>
Implementing Custom Objects for Storage in datatools::things </h1>
<p>As discussed above, the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> object can store instances of any type inheriting from <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1i__serializable.html">datatools::i_serializable</a></code>. If the builtin types provided by Falaise and Bayeux do not meet your needs, you can implement a new custom class derived from <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1i__serializable.html">datatools::i_serializable</a></code>.</p>
<p>In this example, we will implement a simple custom class and add it into the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> event record. This class <b>must</b> inherit from the pure abstract base class <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1i__serializable.html">datatools::i_serializable</a></code> and hence <b>must</b>:</p>
<ul>
<li>Provide a <code>public</code> default constructor</li>
<li>Provide a <code>public</code> virtual destructor</li>
<li>Concretely implement the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1i__serializable.html#ac3e60963a46c6b290e308d891f0e4b78">datatools::i_serializable::get_serial_tag()</a></code> pure virtual method</li>
</ul>
<p>We therefore begin by writing the header file, which we'll name <code>MyDataType.h</code>:</p>
<div class="fragment"><div class="line"><span class="comment">//! \file    MyDataType.h</span></div><div class="line"><span class="comment"></span><span class="comment">//! \brief   Example custom data type for use with datatools::things</span></div><div class="line"><span class="comment"></span><span class="comment">//! \details Store an integer for later use</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="preprocessor">#ifndef MYDATATYPE_HH</span></div><div class="line"><span class="preprocessor">#define MYDATATYPE_HH</span></div><div class="line"><span class="comment">// Standard Library</span></div><div class="line"></div><div class="line"><span class="comment">// Third Party</span></div><div class="line"><span class="comment">// - Bayeux</span></div><div class="line"><span class="preprocessor">#include &quot;bayeux/datatools/i_serializable.h&quot;</span></div><div class="line"></div><div class="line"><span class="comment">// This Project</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>MyDataType : <span class="keyword">public</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1i__serializable.html">datatools::i_serializable</a> {</div><div class="line"> <span class="keyword">public</span>:<span class="comment"></span></div><div class="line"><span class="comment">  //! Construct type</span></div><div class="line"><span class="comment"></span>  MyDataType();</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  //! Destructor</span></div><div class="line"><span class="comment"></span>  <span class="keyword">virtual</span> ~MyDataType();</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  //! Increment counter</span></div><div class="line"><span class="comment"></span>  <span class="keywordtype">void</span> increment();</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  //! Return value of counter</span></div><div class="line"><span class="comment"></span>  <span class="keywordtype">int</span> current_value() <span class="keyword">const</span>;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  //! Declare serialization interfaces for tagging and streaming</span></div><div class="line"><span class="comment"></span>  DATATOOLS_SERIALIZATION_DECLARATION()</div><div class="line"></div><div class="line"> private:</div><div class="line">  <span class="keywordtype">int</span> mdtCounter_;  <span class="comment">//!&lt; Stored counter</span></div><div class="line"><span class="comment"></span>};</div><div class="line"></div><div class="line"><span class="preprocessor">#endif // MYDATATYPE_HH</span></div></div><!-- fragment --><p>Note the inheritance from <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1i__serializable.html">datatools::i_serializable</a></code> and the use of the <code>DATATOOLS_SERIALIZATION_DECLARATION</code> macro, which declares the <code>get_serial_tag</code> method for us. We have also provided concrete methods to implement this type as a simple increment-only counter. Note also the use of Doxygen markup to document the file and methods. This is required for your data type is to be integrated into the official mainline pipeline.</p>
<p>With the header in place we can create the implementation file, which we'll name <code>MyDataType.cpp</code></p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;MyDataType.h&quot;</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">//! Implement the serialization tag mechanism</span></div><div class="line"><span class="comment"></span>DATATOOLS_SERIALIZATION_SERIAL_TAG_IMPLEMENTATION(MyDataType,<span class="stringliteral">&quot;MyDataType&quot;</span>);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">//! Constructor</span></div><div class="line"><span class="comment"></span>MyDataType::MyDataType() : <a class="code" href="namespacedatatools.html">datatools</a>::i_serializable(), mdtCounter_(0) {</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">//! Destructor</span></div><div class="line"><span class="comment"></span>MyDataType::~MyDataType() {</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> MyDataType::increment() {</div><div class="line">  ++mdtCounter_;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> MyDataType::current_value()<span class="keyword"> const </span>{</div><div class="line">  <span class="keywordflow">return</span> mdtCounter_;</div><div class="line">}</div><div class="line"></div></div><!-- fragment --><p>Here we've implemented the trivial constructor/destructor and the counter implementation, and added the <code>DATATOOLS_SERIALIZATION_SERIAL_TAG_IMPLEMENTATION</code> macro. This, together with the use of <code>DATATOOLS_SERIALIZATION_DECLARATION</code> in the header file provides the <b>minimal</b> boilerplate allowing the class to be stored in <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code>. Additional work is needed to make the type fully serializable to/from a file, and this is described in a <a class="el" href="workingwitheventrecords.html#things_customdata_serialization">later section</a>.</p>
<p>To use this type in the pipeline, we update the implementation of the <code>AccessThings</code> module as follows for the header:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef ACCESSTHINGSMODULE_HH</span></div><div class="line"><span class="preprocessor">#define ACCESSTHINGSMODULE_HH</span></div><div class="line"><span class="preprocessor">#include &quot;bayeux/dpp/base_module.h&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>AccessThingsModule : <span class="keyword">public</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html">dpp::base_module</a> {</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  AccessThingsModule();</div><div class="line">  <span class="keyword">virtual</span> ~AccessThingsModule();</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#a23902ec59ce6bd2f930575f20e8d2d56">initialize</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1properties_1_1basic__key__validator.html">datatools::properties</a>&amp; myConfig,</div><div class="line">                          <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1service__manager.html">datatools::service_manager</a>&amp; flServices,</div><div class="line">                          <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacedpp.html#ac44582f8a6edf81cf4a8708ba42bb0d7">dpp::module_handle_dict_type</a>&amp; what);</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fb">dpp::base_module::process_status</a> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#a8ef4d1b3d5951955116946196e3f5ba4">process</a>(</div><div class="line">      <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1things_1_1entry__type.html">datatools::things</a>&amp; workItem);</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#a0e2182e3b2486fa9e9a2eaff6ea43773">reset</a>();</div><div class="line"></div><div class="line"> <span class="keyword">private</span>:</div><div class="line">  DPP_MODULE_REGISTRATION_INTERFACE(AccessThingsModule);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="preprocessor">#endif // ACCESSTHINGSMODULE_HH</span></div><div class="line"></div></div><!-- fragment --><p>and the implementation:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;AccessThingsModule.h&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;boost/foreach.hpp&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;bayeux/mctools/simulated_data.h&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;MyDataType.h&quot;</span></div><div class="line"></div><div class="line">DPP_MODULE_REGISTRATION_IMPLEMENT(AccessThingsModule,<span class="stringliteral">&quot;AccessThingsModule&quot;</span>);</div><div class="line"></div><div class="line">AccessThingsModule::AccessThingsModule() : <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacedpp.html">dpp</a>::base_module()</div><div class="line">{}</div><div class="line"></div><div class="line">AccessThingsModule::~AccessThingsModule() {</div><div class="line">  this-&gt;<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacedatatools_1_1ui_1_1ansi__colors.html#a78c6ee9526a9347d85718f8f7c6a7ce3">reset</a>();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> AccessThingsModule::initialize(<span class="keyword">const</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1properties_1_1basic__key__validator.html">datatools::properties</a>&amp; <span class="comment">/*myConfig*/</span>,</div><div class="line">                          <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1service__manager.html">datatools::service_manager</a>&amp; <span class="comment">/*flServices*/</span>,</div><div class="line">                          <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/namespacedpp.html#ac44582f8a6edf81cf4a8708ba42bb0d7">dpp::module_handle_dict_type</a>&amp; <span class="comment">/*moduleDict*/</span>) {</div><div class="line">  this-&gt;_set_initialized(<span class="keyword">true</span>);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">//! [AccessThingsModule::Process]</span></div><div class="line"><span class="comment"></span><a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1base__module.html#ae8431b8f4f2734bae557791b9f5417fb">dpp::base_module::process_status</a> AccessThingsModule::process(</div><div class="line">    <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/structdatatools_1_1things_1_1entry__type.html">datatools::things</a>&amp; workItem) {</div><div class="line">  <span class="comment">// Add our custom type to the item</span></div><div class="line">  MyDataType &amp; atmCounter = workItem.<a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#a71e43e4d44db3b4adce071b052153bfe">add</a>&lt;MyDataType&gt;(<span class="stringliteral">&quot;ATMCounter&quot;</span>);</div><div class="line">  atmCounter.increment();</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> PROCESS_OK;</div><div class="line"></div><div class="line">}<span class="comment"></span></div><div class="line"><span class="comment">//! [AccessThingsModule::Process]</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">void</span> AccessThingsModule::reset() {</div><div class="line">  this-&gt;_set_initialized(<span class="keyword">false</span>);</div><div class="line">}</div></div><!-- fragment --><p>Note the inclusion of the <code>MyDataType</code> header. We use the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html#a71e43e4d44db3b4adce071b052153bfe">datatools::things::add</a></code> method to add a <code>MyDataType</code> bank to the event. To compile the new type into a loadable module, we simply add the header and implementation to the <code>add_library</code> call in the <code>CMakeLists.txt</code> script:</p>
<div class="fragment"><div class="line"><span class="preprocessor"># - Basic CMake setup</span></div><div class="line"><span class="preprocessor"># Check version meets ou requirements</span></div><div class="line"><span class="preprocessor"># Declare project, which will configure compiler for us</span></div><div class="line">cmake_minimum_required(VERSION 3.3)</div><div class="line">project(AccessThingsModuleCustom)</div><div class="line"></div><div class="line"><span class="preprocessor"># Modules use FalaiseBayeux, so we need to locate this or fail</span></div><div class="line"><span class="preprocessor"># Locating Falaise will automatically locate all of its</span></div><div class="line"><span class="preprocessor"># dependencies such as Bayeux, ROOT and Boost.</span></div><div class="line">find_package(Falaise 2.1.0 REQUIRED)</div><div class="line"></div><div class="line"><span class="preprocessor"># Build a dynamic library from our sources</span></div><div class="line">add_library(AccessThingsModule SHARED</div><div class="line">  AccessThingsModule.h</div><div class="line">  AccessThingsModule.cpp</div><div class="line">  MyDataType.h</div><div class="line">  MyDataType.cpp</div><div class="line">  )</div><div class="line"></div><div class="line"><span class="preprocessor"># Link it to the FalaiseModule library</span></div><div class="line"><span class="preprocessor"># This ensures the correct compiler flags, include paths</span></div><div class="line"><span class="preprocessor"># and linker flags are applied to our dynamic library.</span></div><div class="line">target_link_libraries(AccessThingsModule PUBLIC FalaiseModule)</div></div><!-- fragment --><p>To see the effect of writing our own type, we compile the above code into a shared library using the above CMake script and then use the following pipeline script to sandwich the module between two dump modules</p>
<div class="fragment"><div class="line">#@description AccessThings Pipeline</div><div class="line">#@key_label   &quot;name&quot;</div><div class="line">#@meta_label  &quot;type&quot;</div><div class="line"></div><div class="line"># - Custom modules</div><div class="line">[name=&quot;flreconstruct.plugins&quot; type=&quot;&quot;]</div><div class="line">plugins : string[1] = &quot;AccessThingsModule&quot;</div><div class="line">AccessThingsModule.directory : string = &quot;.&quot;</div><div class="line"></div><div class="line"># - Pipeline configuration</div><div class="line">[name=&quot;pipeline&quot; type=&quot;dpp::chain_module&quot;]</div><div class="line">modules : string[3] = &quot;preprocess&quot; &quot;access_things&quot; &quot;postprocess&quot;</div><div class="line"></div><div class="line">[name=&quot;preprocess&quot; type=&quot;dpp::dump_module&quot;]</div><div class="line">title : string = &quot;PreProcess&quot;</div><div class="line"></div><div class="line">[name=&quot;postprocess&quot; type=&quot;dpp::dump_module&quot;]</div><div class="line">title : string = &quot;PostProcess&quot;</div><div class="line"></div><div class="line">[name=&quot;access_things&quot; type=&quot;AccessThingsModule&quot;]</div><div class="line"></div></div><!-- fragment --><p>You should see that the <code>PostProcess</code> stage results in output containing the information written into the <code>ATMCounter</code> bank.</p>
<h1><a class="anchor" id="things_customdata_serialization"></a>
Serializing Custom Objects to Persistant Files/Archives </h1>
<p>As it stands, our custom <code>MyDataType</code> data object is storable in a <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> instance, but is <em>not</em> capable of being written to file, even though <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> is. If you try and run the <code>AccessThingsModule</code> in a pipeline and output to a file, e.g.</p>
<div class="fragment"><div class="line">$ flreconstruct -i test.brio -p AccessThingsPipeline.conf -o test-reco.brio</div></div><!-- fragment --><p>an exception will be thrown when trying to write the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1things.html">datatools::things</a></code> instance to the file (Mac OS X case shown):</p>
<div class="fragment"><div class="line">...</div><div class="line">libc++abi.dylib: terminating with uncaught exception of type boost::archive::archive_exception: unregistered class - derived class not registered or exported</div><div class="line">Abort trap: 6</div><div class="line">$</div></div><!-- fragment --><p>This occurs because the underlying Boost serialization system does not know how to persist the <code>MyDataType</code> class to file. To make <code>MyDataType</code> persistable by the serialization system, we need to use a couple of macros and one function implementation to</p>
<ul>
<li>Declare and define the serialization/persistant interfaces and implementation</li>
<li>Register this code with the Boost serialization system so it can be loaded from the plugin library.</li>
</ul>
<p>The first addition is to the <code>MyDataType</code> header, where we add a call to the <a href="http://www.boost.org/doc/libs/1_60_0/libs/serialization/doc/traits.html#export">BOOST_CLASS_EXPORT_KEY</a> macro post the class declaration. We defer detailed explanation of this macro to the <a href="http://www.boost.org/doc/libs/1_60_0/libs/serialization/doc/traits.html#export">Boost Documentation</a> suffice to say that this is needed to ensure templated serialization code is instantiated and to register an identifier for the class in the serialization system.</p>
<div class="fragment"><div class="line"><span class="comment">//! \file    MyDataType.h</span></div><div class="line"><span class="comment"></span><span class="comment">//! \brief   Example custom data type for use with datatools::things</span></div><div class="line"><span class="comment"></span><span class="comment">//! \details Store an integer for later use</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="preprocessor">#ifndef MYDATATYPE_HH</span></div><div class="line"><span class="preprocessor">#define MYDATATYPE_HH</span></div><div class="line"><span class="comment">// Standard Library</span></div><div class="line"></div><div class="line"><span class="comment">// Third Party</span></div><div class="line"><span class="comment">// - Bayeux</span></div><div class="line"><span class="preprocessor">#include &quot;bayeux/datatools/i_serializable.h&quot;</span></div><div class="line"></div><div class="line"><span class="comment">// This Project</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>MyDataType : <span class="keyword">public</span> <a class="codeRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1i__serializable.html">datatools::i_serializable</a> {</div><div class="line"> <span class="keyword">public</span>:<span class="comment"></span></div><div class="line"><span class="comment">  //! Construct type</span></div><div class="line"><span class="comment"></span>  MyDataType();</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  //! Destructor</span></div><div class="line"><span class="comment"></span>  <span class="keyword">virtual</span> ~MyDataType();</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  //! Increment counter</span></div><div class="line"><span class="comment"></span>  <span class="keywordtype">void</span> increment();</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  //! Return value of counter</span></div><div class="line"><span class="comment"></span>  <span class="keywordtype">int</span> current_value() <span class="keyword">const</span>;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">  //! Declare serialization interfaces for tagging and streaming</span></div><div class="line"><span class="comment"></span>  DATATOOLS_SERIALIZATION_DECLARATION()</div><div class="line"></div><div class="line"> private:</div><div class="line">  <span class="keywordtype">int</span> mdtCounter_;  <span class="comment">//!&lt; Stored counter</span></div><div class="line"><span class="comment"></span>};</div><div class="line"></div><div class="line"><span class="comment">// Boost.Serialization class export definition</span></div><div class="line"><span class="preprocessor">#include &lt;boost/serialization/export.hpp&gt;</span></div><div class="line">BOOST_CLASS_EXPORT_KEY(MyDataType)</div><div class="line"></div><div class="line"><span class="preprocessor">#endif // MYDATATYPE_HH</span></div></div><!-- fragment --><p>The argument to the macro should be the class name, including a fully qualified namespace if the class is placed inside one.</p>
<p>To isolate the serialization specific code from the main logic of the class, the serialization implementation is written into a dedicated source file:</p>
<div class="fragment"><div class="line"><span class="comment">// Serialization implementation for MyDataType</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//----------------------------------------------------------------------</span></div><div class="line"><span class="comment">// In this first section, we implement the read/write &quot;serialize method.</span></div><div class="line"><span class="comment">// If, and only if, you expect MyDataType to be inherited from (and this</span></div><div class="line"><span class="comment">// is *not* recommended for data types), this section should go into a</span></div><div class="line"><span class="comment">// separate &quot;MyDataType-xxx.ipp&quot; header file. This allows it to</span></div><div class="line"><span class="comment">// be #included by derived classes&#39; own &quot;DerivedData-xxx.ipp&quot; files</span></div><div class="line"><span class="comment">// which is required to propaget the serialization correctly.</span></div><div class="line"></div><div class="line"><span class="comment">// Interface for the class we&#39;re serializing</span></div><div class="line"><span class="preprocessor">#include &quot;MyDataType.h&quot;</span></div><div class="line"></div><div class="line"><span class="comment">// Implement the serialize method</span></div><div class="line"><span class="comment">// - Boost:</span></div><div class="line"><span class="comment">//#include &lt;boost/serialization/base_object.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;boost/serialization/nvp.hpp&gt;</span></div><div class="line"><span class="comment">// - Bayeux</span></div><div class="line"><span class="preprocessor">#include &lt;bayeux/datatools/i_serializable.ipp&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Archive&gt;</div><div class="line"><span class="keywordtype">void</span> MyDataType::serialize(Archive&amp; ar, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*version_*/</span>)</div><div class="line">{</div><div class="line">  <span class="comment">// Serialize the base class first</span></div><div class="line">  ar &amp; DATATOOLS_SERIALIZATION_I_SERIALIZABLE_BASE_OBJECT_NVP;</div><div class="line">  <span class="comment">// Now the concrete data members *in order*</span></div><div class="line">  <span class="comment">// Note the use of Boost&#39;s &quot;make_nvp&quot; function, &quot;nvp&quot; being</span></div><div class="line">  <span class="comment">// &quot;name-value pair&quot;. This creates an effective map in the archive.</span></div><div class="line">  <span class="comment">// It&#39;s a template method, so easy to use for most types.</span></div><div class="line">  ar &amp; boost::serialization::make_nvp(<span class="stringliteral">&quot;mdtCounter&quot;</span>, mdtCounter_);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//----------------------------------------------------------------------</span></div><div class="line"><span class="comment">// This second section adds the boilerplate for registering the class</span></div><div class="line"><span class="comment">// with the Boost Serialization core. It ensures that all needed code</span></div><div class="line"><span class="comment">// for serialization is instantiated (TOD: add clearer explanation of</span></div><div class="line"><span class="comment">// what&#39;s happening here, bottom line, allows use when loaded as</span></div><div class="line"><span class="comment">// a plugin or linked as library without exposing details to clients).</span></div><div class="line"></div><div class="line"><span class="comment">// Include the headers for the file formats we want code exported for</span></div><div class="line"><span class="comment">// This must come before the BOOST_CLASS_EXPORT_IMPLEMENT expansion,</span></div><div class="line"><span class="comment">// then code export is automatic.</span></div><div class="line"><span class="preprocessor">#include &quot;bayeux/datatools/archives_instantiation.h&quot;</span></div><div class="line"><span class="comment">// Boost.Serialization class export definition</span></div><div class="line">BOOST_CLASS_EXPORT_IMPLEMENT(MyDataType)</div><div class="line"></div><div class="line"></div></div><!-- fragment --><p>As documented, this roughly splits into two sections:</p>
<ol type="1">
<li>Implementing the required read/write <code>MyDataType::serialize</code> member function, templated on the type of format (e.g. XML, BRIO) the class will be serialized to. The important points to note are that any base class of <code>MyDataType</code> must be serialized first, followed by the data members in order. Boost's serialization library provides many helper functions to create the key-value pairs in the archive, and <a href="http://www.boost.org/doc/libs/1_60_0/libs/serialization/doc/index.html">its documentation</a> should be consulted for further details here.</li>
<li>Calling the implementation counterpart of <code>BOOST_CLASS_EXPORT_KEY</code>, the <code>BOOST_CLASS_EXPORT_IMPLEMENT</code> macro. This must be called with the same argument as <code>BOOST_CLASS_EXPORT_KEY</code>, and <em>must</em> come after inclusion of <code>Bayeux</code>'s <code>bayeux/datatools/archives_instantiation.h</code> header, with lists support file formats. This ordering ensures <code>MyDataType</code> can be serialized automatically to all supported file formats.</li>
</ol>
<p>This source file is simply added to the inputs to the library:</p>
<div class="fragment"><div class="line"><span class="preprocessor"># - Basic CMake setup</span></div><div class="line"><span class="preprocessor"># Check version meets ou requirements</span></div><div class="line"><span class="preprocessor"># Declare project, which will configure compiler for us</span></div><div class="line">cmake_minimum_required(VERSION 3.3)</div><div class="line">project(AccessThingsModuleCustom)</div><div class="line"></div><div class="line"><span class="preprocessor"># Modules use FalaiseBayeux, so we need to locate this or fail</span></div><div class="line"><span class="preprocessor"># Locating Falaise will automatically locate all of its</span></div><div class="line"><span class="preprocessor"># dependencies such as Bayeux, ROOT and Boost.</span></div><div class="line">find_package(Falaise 2.1.0 REQUIRED)</div><div class="line"></div><div class="line"><span class="preprocessor"># Build a dynamic library from our sources</span></div><div class="line">add_library(AccessThingsModule SHARED</div><div class="line">  AccessThingsModule.h</div><div class="line">  AccessThingsModule.cpp</div><div class="line">  MyDataType.h</div><div class="line">  MyDataType.cpp</div><div class="line">  MyDataTypeSerialization.cpp</div><div class="line">  )</div><div class="line"></div><div class="line"><span class="preprocessor"># Link it to the FalaiseModule library</span></div><div class="line"><span class="preprocessor"># This ensures the correct compiler flags, include paths</span></div><div class="line"><span class="preprocessor"># and linker flags are applied to our dynamic library.</span></div><div class="line">target_link_libraries(AccessThingsModule PUBLIC FalaiseModule)</div></div><!-- fragment --><p>Once compiled, we can run as in previous examples, but this time we will not see an exception being thrown as <code>MyDataType</code> is known to the serialization system and is written into the output file. However, if we try to confirm this by using <code>flreconstruct</code>'s default dump-to-stdout, we see the exception again:</p>
<div class="fragment"><div class="line">$ flreconstruct -i test-reco.brio </div><div class="line">libc++abi.dylib: terminating with uncaught exception of type boost::archive::archive_exception: unregistered class</div><div class="line">Abort trap: 6</div></div><!-- fragment --><p>This might have been expected as the code for serializing <code>MyDataType</code> is held in the <code>AccessThingsModule</code> library and this is not loaded by default in flreconstruct. When using custom data types, you must remember to add them to the list of libraries to be loaded, for example via a script:</p>
<div class="fragment"><div class="line">#@description AccessThings Pipeline</div><div class="line">#@key_label   &quot;name&quot;</div><div class="line">#@meta_label  &quot;type&quot;</div><div class="line"></div><div class="line"># - Custom modules</div><div class="line">[name=&quot;flreconstruct.plugins&quot; type=&quot;&quot;]</div><div class="line">plugins : string[1] = &quot;AccessThingsModule&quot;</div><div class="line">AccessThingsModule.directory : string = &quot;.&quot;</div><div class="line"></div><div class="line"># - Pipeline configuration</div><div class="line">[name=&quot;pipeline&quot; type=&quot;dpp::dump_module&quot;]</div><div class="line"></div></div><!-- fragment --><p>If we now run with this script, we can see that our custom type was indeed serialized to the output file:</p>
<div class="fragment"><div class="line">$ flreconstruct -i test-reco.brio -p ../AccessThingsDump.conf</div><div class="line">[notice:void datatools::library_loader::init():449] Automatic loading of library &#39;AccessThingsModule&#39;...</div><div class="line">|-- Bank &#39;ATMCounter&#39; : &quot;MyDataType&quot;</div><div class="line">`-- Bank &#39;SD&#39; : &quot;mctools::simulated_data&quot;</div><div class="line">...</div></div><!-- fragment --><p>This has only covered the basics of making your data objects serializable. More advanced topics are deferred to later tutorials.</p>
<p><b>TODOS:</b></p><ul>
<li>Clarify split of serialization code and the exact purpose/behaviour of the <code>BOOST_EXPORT_...</code> macros.</li>
<li>Organization of code/files when we have more than one data class</li>
<li>Organization of code/files if we want our data objects to used (and serialized) as data members of other objects. </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
