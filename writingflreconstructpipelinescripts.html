<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Falaise: Writing FLReconstruct Pipeline Scripts</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Falaise
   &#160;<span id="projectnumber">4.0.0</span>
   </div>
   <div id="projectbrief">SuperNEMO Software Toolkit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Writing FLReconstruct Pipeline Scripts </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="wflrps_intro"></a>
Introduction to FLReconstruct Pipeline Scripts </h1>
<p>Though Falaise supplies a set of pipelines for standard reconstruction, it is also possible write your own custom pipeline scripts for use in <code>flreconstruct</code>. These are nothing more than text files marked up using the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1multi__properties.html">datatools::multi_properties</a></code> syntax. Custom pipeline scripts can be run in <code>flreconstruct</code> by passing their path to the <code>-p</code> (or <code>--pipeline</code>) command, for example</p>
<div class="fragment"><div class="line">$ flreconstruct -i example.brio -p myscript.conf</div></div><!-- fragment --><p>or</p>
<div class="fragment"><div class="line">$ flreconstruct -i example.brio -p /home/me/myscript.conf</div></div><!-- fragment --><p>The major use cases for custom pipelines are to study performance improvements to the current pipelines by tuning parameters or implementing new modules. Here we cover the task of writing a script to build a custom pipeline from the standard modules supplied with Falaise. The more advanced step of writing and using new modules is covered in the <a class="el" href="writingflreconstructmodules.html">Writing FLReconstruct Modules</a> section.</p>
<h1><a class="anchor" id="wflrps_discoveringavailablemodules"></a>
Discovering Available Modules </h1>
<p>A list of pipeline modules known to <code>flreconstruct</code> can be obtained using its <code>--help-module-list</code> argument, which will print the module names to stdout:</p>
<div class="fragment"><div class="line">$ flreconstruct --help-module-list</div><div class="line">Things2Root</div><div class="line">bipo3::processing::calorimeter_s2c_module</div><div class="line">dpp::chain_module</div><div class="line">dpp::dummy_module</div><div class="line">dpp::dump_module</div><div class="line">dpp::if_module</div><div class="line">dpp::input_module</div><div class="line">dpp::output_module</div><div class="line">dpp::skip_module</div><div class="line">dpp::utils_module</div><div class="line">mctools::simulated_data_input_module</div><div class="line">snemo::processing::event_header_utils_module</div><div class="line">snemo::processing::mock_calorimeter_s2c_module</div><div class="line">snemo::processing::mock_tracker_s2c_module</div><div class="line">snemo::reconstruction::cat_tracker_clustering_module</div><div class="line">snemo::reconstruction::charged_particle_tracking_module</div><div class="line">snemo::reconstruction::mock_tracker_clustering_module</div><div class="line">snemo::reconstruction::sultan_tracker_clustering_module</div><div class="line">snemo::reconstruction::trackfit_tracker_fitting_module</div><div class="line">snemo::visualization::visu_toy_module</div></div><!-- fragment --><p>Details about the purpose of a module and the parameters you can supply to configure it may be obtained by passing the module name as the argument of the <code>--help-module</code> command. This will print out detailed documentation, if it exists:</p>
<div class="fragment"><div class="line">$ flreconstruct --help-module dpp::chain_module</div><div class="line"></div><div class="line">======================================</div><div class="line">Configuration of ``dpp::chain_module``</div><div class="line">======================================</div><div class="line"></div><div class="line">... further detailed output ...</div></div><!-- fragment --><p>This information can be used to select suitable modules and configurations for your own pipeline. The following sections provide some simple examples of pipeline scripts.</p>
<h1><a class="anchor" id="wflrps_implementing_pipeline_scripts"></a>
Implementing Pipeline Scripts </h1>
<p>To demonstrate the basic syntax and structure of an <code>flreconstruct</code> pipeline script, the following sections build up functionality from single modules up to using a chain of plugin modules.</p>
<h2><a class="anchor" id="trivial_pipeline"></a>
Trivial Pipeline </h2>
<p>If you do not supply a pipeline script to <code>flreconstruct</code>, it will run a dumb pipeline that simple dumps each event to stdout.</p>
<p>We can reproduce this behaviour using the following simple script to configure the pipeline as a single module:</p>
<div class="fragment"><div class="line"># *MUST* define description, key_label and meta_label labels</div><div class="line"># The latter two *MUST* be named &quot;name&quot; and &quot;type&quot;</div><div class="line"># Note that lines beginning with &#39;#&#39; are comments, *except* for lines</div><div class="line"># beginning &#39;#@&#39; which are labels...</div><div class="line"></div><div class="line">#@description Simple pipeline of one module that dumps each event to cout</div><div class="line">#@key_label   &quot;name&quot;</div><div class="line">#@meta_label  &quot;type&quot;</div><div class="line"></div><div class="line"># # Basic section</div><div class="line"># [name=&quot;flreconstruct&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line"># experimentalSetupUrn : string = &quot;urn:snemo:demonstrator:setup:1.0&quot;</div><div class="line"></div><div class="line"># # Variant service section</div><div class="line"># [name=&quot;flreconstruct.variantService&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line"># profile : string as path = &quot;vprofile.conf&quot;</div><div class="line"></div><div class="line"># Must define &quot;pipeline&quot; as this is the module flreconstruct will use</div><div class="line">[name=&quot;pipeline&quot; type=&quot;dpp::dump_module&quot;]</div><div class="line">output : string = &quot;cout&quot;</div></div><!-- fragment --><p>The script is formatted as a <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1multi__properties.html">datatools::multi_properties</a></code> ASCII file. Note the comments, especially:</p>
<ul>
<li>The required presence of the <code>@key_label</code> and <code>@meta_label</code> multi_properties flags</li>
<li>The module constituting the pipeline must have the <code>name</code> key set to <code>pipeline</code>. FLReconstruct will use this to build the pipeline.</li>
</ul>
<p>To try this out, copy the above text into a file, e.g. <code>trivial_pipeline.txt</code> and run <code>flreconstruct</code> with it:</p>
<div class="fragment"><div class="line">$ flreconstruct -i example.brio -p trivial_pipeline.txt</div></div><!-- fragment --><p>You should see the same output as the default case.</p>
<h2><a class="anchor" id="wflrps_chain_pipeline"></a>
Creating a Chained Pipeline </h2>
<p>A pipeline with one module isn't very useful! In most cases we want to plug together a sequence of modules, each performing a well defined task on the event data.</p>
<p>Falaise supplies a special <code>chain_module</code> for chaining several modules together. We can reproduce the same default dump behaviour using a <code>chain_module</code> in a pipeline script as follows</p>
<div class="fragment"><div class="line"># *MUST* define description, key_label and meta_label labels</div><div class="line"># The latter two *MUST* be named &quot;name&quot; and &quot;type&quot;</div><div class="line"># Note that lines beginning with &#39;#&#39; are comments, *except* for lines</div><div class="line"># beginning &#39;#@&#39; which are labels...</div><div class="line"></div><div class="line">#@description Simple pipeline using a chain module with one link</div><div class="line">#@key_label   &quot;name&quot;</div><div class="line">#@meta_label  &quot;type&quot;</div><div class="line"></div><div class="line"># # Basic section</div><div class="line"># [name=&quot;flreconstruct&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line"># experimentalSetupUrn : string = &quot;urn:snemo:demonstrator:setup:1.0&quot;</div><div class="line"></div><div class="line"># # Variant service section</div><div class="line"># [name=&quot;flreconstruct.variantService&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line"># profile : string as path = &quot;vprofile.conf&quot;</div><div class="line"></div><div class="line"># Must define &quot;pipeline&quot; as this is the module flreconstruct will use</div><div class="line">[name=&quot;pipeline&quot; type=&quot;dpp::chain_module&quot;]</div><div class="line"># &#39;modules&#39; key is a list of module names that will be chained together in</div><div class="line"># the given sequence</div><div class="line">modules : string[1] = &quot;my_dump&quot;</div><div class="line"></div><div class="line"># Define the &quot;my_dump&quot; module as a simple dump module which is configured</div><div class="line"># exactly like we did in the simplepipeline example</div><div class="line">[name=&quot;my_dump&quot; type=&quot;dpp::dump_module&quot;]</div><div class="line">output : string = &quot;cout&quot;</div></div><!-- fragment --><p>Here, the <code>modules</code> key of the <code>pipeline</code> module takes a list of modules that will form the <code>chain_module</code>. To try this out, copy the above text into a file, e.g. <code>single_chain_pipeline.txt</code> and run <code>flreconstruct</code> with it:</p>
<div class="fragment"><div class="line">$ flreconstruct -i example.brio -p single_chain_pipeline.txt</div></div><!-- fragment --><p>You should see the same output as the default case.</p>
<h2><a class="anchor" id="wflrps_multi_pipeline"></a>
Multi-Module Pipeline </h2>
<p>A full chain pipeline can chain together 1 &lt; N &lt; X number of modules. The previous example showed the basic construct of a chained pipeline with a single module. We can of course go further and add further module to the pipeline. For example, we can chain two dump modules together. To distinguish these, we configure the modules to have different <code>title</code> and <code>indent</code> parameters.</p>
<div class="fragment"><div class="line"># *MUST* define description, key_label and meta_label labels</div><div class="line"># The latter two *MUST* be named &quot;name&quot; and &quot;type&quot;</div><div class="line"># Note that lines beginning with &#39;#&#39; are comments, *except* for lines</div><div class="line"># beginning &#39;#@&#39; which are labels...</div><div class="line"></div><div class="line">#@description Simple pipeline using a chain module with one link</div><div class="line">#@key_label   &quot;name&quot;</div><div class="line">#@meta_label  &quot;type&quot;</div><div class="line"></div><div class="line"># # Basic section</div><div class="line"># [name=&quot;flreconstruct&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line"># experimentalSetupUrn : string = &quot;urn:snemo:demonstrator:setup:1.0&quot;</div><div class="line"></div><div class="line"># # Variant service section</div><div class="line"># [name=&quot;flreconstruct.variantService&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line"># profile : string as path = &quot;vprofile.conf&quot;</div><div class="line"></div><div class="line"># Must define &quot;pipeline&quot; as this is the module flreconstruct will use</div><div class="line">[name=&quot;pipeline&quot; type=&quot;dpp::chain_module&quot;]</div><div class="line"># &#39;modules&#39; key is a list of module names that will be chained together in</div><div class="line"># the given sequence</div><div class="line">modules : string[2] = &quot;first&quot; &quot;second&quot;</div><div class="line"></div><div class="line"># Define the &quot;first&quot; module as a simple dump module which is configured</div><div class="line"># with some specific formatting</div><div class="line">[name=&quot;first&quot; type=&quot;dpp::dump_module&quot;]</div><div class="line">output : string = &quot;cout&quot;</div><div class="line">title  : string = &quot;FirstModule&quot;</div><div class="line"></div><div class="line"># Define the &quot;second&quot; module as a simple dump module which is configured</div><div class="line"># with some fancier formatting so we can see the difference from the first</div><div class="line">[name=&quot;second&quot; type=&quot;dpp::dump_module&quot;]</div><div class="line">output : string = &quot;cout&quot;</div><div class="line">title  : string = &quot;SecondModule&quot;</div><div class="line">indent : string = &quot;  &quot;</div></div><!-- fragment --><p>The order in which the modules are processed is determined by the order in which you list them in the <code>modules</code> key of the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdpp_1_1chain__module.html">dpp::chain_module</a></code> configuration.</p>
<p>To try this out, copy the above text into a file, e.g. <code>multi_chain_pipeline.txt</code> and run <code>flreconstruct</code> with it:</p>
<div class="fragment"><div class="line">$ flreconstruct -i example.brio -p multi_chain_pipeline.txt</div></div><!-- fragment --><p>Try swapping the order of the modules to see what happens, and also try adding further dump modules to the pipeline to experiment with the sequence.</p>
<h1><a class="anchor" id="wflrps_pluginmodules"></a>
Using Plugin Modules </h1>
<p>Falaise supplies several modules as plugins, that is, functionality loaded into <code>flreconstruct</code> after it starts running.</p>
<h1><a class="anchor" id="further"></a>
Going Further </h1>
<p>You can also write your own modules in C++ and plug them into the pipeline to provide additional functionality. The proceedure for writing and using new modules is covered in several stages, beginning with a <a class="el" href="writingflreconstructmodules.html">simple example</a>.</p>
<h1>Detailed Syntax Guide </h1>
<h2><a class="anchor" id="usingflreconstruct_scriptingflsimulate_format"></a>
Basic Script Syntax </h2>
<p>FLreconstruct scripts use the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1multi__properties.html">datatools::multi_properties</a></code> format from Bayeux. The script must begin with a mandatory header:</p>
<div class="fragment"><div class="line">#@description a short description of the reconstruction run</div><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div></div><!-- fragment --><p>The '<code>#@description</code>' line is optional but highly recommended.</p>
<p>Comments can be placed at any point in the script. Just prepend a sharp ('<code>#</code>') symbol to any comment line. You may also prepend a comment at the end of a line:</p>
<div class="fragment"><div class="line"># This is a single commented line</div><div class="line"></div><div class="line">{...some script command...} # Comment starts at the end of the line</div><div class="line"></div><div class="line"># This is</div><div class="line"># a commented</div><div class="line"># block</div></div><!-- fragment --><p>Note that lines starting with &lsquo;&rsquo;#&amp;lsquo;&rsquo; are generally special meta-comments with embedded commands. They should not be considered as comments. As a matter of rule, the use of lines starting with '<code>#@</code>' is reserved for system use.</p>
<p>After the header, the script contains <em>sections</em>. A section starts with a section definition line with two identifiers:</p>
<ul>
<li>the <em>name</em> of the section,</li>
<li>the <em>type</em> of the section (in <code>flreconstruct</code> scripts it <em>must be</em> <code>"flreconstruct::section"</code>).</li>
</ul>
<p>The syntax is: </p><div class="fragment"><div class="line">[name=&quot;SectionName&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line"></div><div class="line">... section body ...</div></div><!-- fragment --><p>The section body uses the <code><a class="elRef" doxygen="https://supernemo-dbd.github.io/Bayeux/bayeux.doxy.tag:https://supernemo-dbd.github.io/Bayeux/" href="https://supernemo-dbd.github.io/Bayeux/classdatatools_1_1properties.html">datatools::properties</a></code> format from Bayeux. After the definition line, a short description may be optionally provided thanks to the '<code>#@config</code>' meta-comment:</p>
<div class="fragment"><div class="line">#@config a short description of the purpose of the section</div></div><!-- fragment --><p>Then comes the section body which consists in a list of parameter setting directives. The format is:</p>
<div class="fragment"><div class="line">#@description a short description of the parameter</div><div class="line">NAME : TYPE [DECORATOR] = VALUE</div></div><!-- fragment --><p>where <code>NAME</code> is the identifier for the parameter, <code>TYPE</code> is its type and <code>VALUE</code> the selected value for this parameter. Some parameters may use an optional <code>DECORATOR</code> which gives additional information about the parameter's type or processing. Again, the <code>#@description</code> line is optional, but recommended. Example:</p>
<div class="fragment"><div class="line">#@description The number of events to be processed</div><div class="line">numberOfEvents : integer = 10000</div></div><!-- fragment --><h2><a class="anchor" id="usingflreconstruct_mockcalibalgo"></a>
How to run a mock calibration on simulated events </h2>
<p>When we generate simulated events with FLSimulate, the so-called <code>SD</code> bank contains only raw information about truth calorimeter and tracker hits. In order to be able to reconstruct and analyze the events, we must apply a calibration procedure. This calibration procedure consists of determining physics/geometrical observables associated to hits : deposited energy, particle times of flight, hit positions in the geometry model and so on.</p>
<p>The so-called <em>mock calibration</em> computes the <em>calibrated data</em> associated to raw <em>simulated data</em>.</p>
<div class="image">
<img src="flr_mock_calib.png" alt="flr_mock_calib.png"/>
<div class="caption">
Mock calibration algorithms applied to simulated events</div></div>
<p>The mock calibration consists of:</p>
<ul>
<li>Tracker hits: compute the drift radius and longitudinal position along the anode wire of the Geiger avalanche (and associated uncertainties).</li>
<li>Calorimeter hits: compute the total energy deposit in the scintillator block and the reference time when the particles first interacted with the block (and associated uncertainties).</li>
</ul>
<p>A new <code>CD</code> bank holding these data is added in the event record, alongside the raw <code>SD</code> bank.</p>
<p>To see this processing in action, we first prepare a set of 10 simulated events (using the default simulation setup), using the following <code>simu.conf</code> script for FLSimulate: </p><div class="fragment"><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;flsimulate&quot; type=&quot;flsimulate::section&quot;]</div><div class="line">numberOfEvents : integer = 10</div></div><!-- fragment --><p>and run: </p><div class="fragment"><div class="line">$ flsimulate -c simu.conf -o example.brio</div><div class="line">...</div></div><!-- fragment --><p>The resulting <code>example.brio</code> file can be opened with the <code>flvisualize</code> application. We can visualize the first event where we will see any raw tracker/calorimeter hits, as well as the position of the decay vertex (cross on the source foil). An example event is shown below, and your view may differ as by default flsimulate will use different seeds on each run, and the styling/colours may also vary between machines:</p>
<div class="image">
<img src="flr_qs_sd_event.png" alt="flr_qs_sd_event.png"/>
<div class="caption">
A simulated event</div></div>
<p>To process this data in <code>flreconstruct</code> and apply the mock calibration we create the <code>rec.conf</code> script with a custom <code>pipeline</code> inline module made of three consecutive modules. The first one is responsible of the calibration of the tracker hits. The second one is responsible of the calibration of the calorimeter hits. The last one simply prints the content of the events in the standard output:</p>
<div class="fragment"><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;pipeline&quot; type=&quot;dpp::chain_module&quot;]</div><div class="line">modules : string[3] = &quot;CalibrateTracker&quot; &quot;CalibrateCalorimeters&quot; &quot;Dump&quot;</div><div class="line"></div><div class="line">[name=&quot;CalibrateTracker&quot; type=&quot;snemo::processing::mock_tracker_s2c_module&quot;]</div><div class="line"></div><div class="line">[name=&quot;CalibrateCalorimeters&quot; type=&quot;snemo::processing::mock_calorimeter_s2c_module&quot;]</div><div class="line"></div><div class="line">[name=&quot;Dump&quot; type=&quot;dpp::dump_module&quot;]</div></div><!-- fragment --><p>We use default settings for each of the <code>CalibrateTracker</code>, <code>CalibrateCalorimeters</code> and <code>Dump</code> modules so the corresponding sections are empty.</p>
<p>We then run: </p><div class="fragment"><div class="line">$ flreconstruct -i example.brio -p rec.conf -o example-cd.brio</div><div class="line">...</div></div><!-- fragment --><p>The use of the <code>Dump</code> module prints the events in the terminal. Here is the first event: </p><div class="fragment"><div class="line">|-- Bank &#39;CD&#39; : &quot;snemo::datamodel::calibrated_data&quot;</div><div class="line">|   |-- Properties : &lt;empty&gt;</div><div class="line">|   |   `-- &lt;no property&gt;</div><div class="line">|   |-- Calibrated calorimeter hits: 1</div><div class="line">|   |   `-- Hit #0 : Id=0 GID=[1302:0.1.16.6.*] E=1027.5 keV t=2.10165 ns</div><div class="line">|   `-- Calibrated tracker hits: 23</div><div class="line">|       |-- Hit #0 : Id=0 GID=[1204:0.1.0.95] [prompt]</div><div class="line">|       |-- Hit #1 : Id=1 GID=[1204:0.1.1.96] [prompt]</div><div class="line">|       |-- Hit #2 : Id=2 GID=[1204:0.1.2.96] [prompt]</div><div class="line">|       |-- Hit #3 : Id=3 GID=[1204:0.1.2.97] [delayed]</div><div class="line">|       |-- Hit #4 : Id=4 GID=[1204:0.1.3.97] [prompt]</div><div class="line">|       |-- Hit #5 : Id=5 GID=[1204:0.1.4.98] [prompt]</div><div class="line">|       |-- Hit #6 : Id=6 GID=[1204:0.1.5.98] [prompt]</div><div class="line">|       |-- Hit #7 : Id=7 GID=[1204:0.1.5.99] [prompt]</div><div class="line">|       |-- Hit #8 : Id=8 GID=[1204:0.1.6.99] [prompt]</div><div class="line">|       |-- Hit #9 : Id=9 GID=[1204:0.1.6.100] [prompt]</div><div class="line">|       |-- Hit #10 : Id=10 GID=[1204:0.1.7.100] [prompt]</div><div class="line">|       |-- Hit #11 : Id=11 GID=[1204:0.1.7.101] [prompt]</div><div class="line">|       |-- Hit #12 : Id=12 GID=[1204:0.1.8.101] [prompt]</div><div class="line">|       |-- Hit #13 : Id=13 GID=[1204:0.1.8.102] [prompt]</div><div class="line">|       |-- Hit #14 : Id=14 GID=[1204:0.1.0.94] [prompt]</div><div class="line">|       |-- Hit #15 : Id=15 GID=[1204:0.1.1.94] [prompt]</div><div class="line">|       |-- Hit #16 : Id=16 GID=[1204:0.1.2.94] [prompt]</div><div class="line">|       |-- Hit #17 : Id=17 GID=[1204:0.1.3.94] [prompt]</div><div class="line">|       |-- Hit #18 : Id=18 GID=[1204:0.1.4.93] [prompt]</div><div class="line">|       |-- Hit #19 : Id=19 GID=[1204:0.1.5.93] [prompt]</div><div class="line">|       |-- Hit #20 : Id=20 GID=[1204:0.1.6.93] [prompt]</div><div class="line">|       |-- Hit #21 : Id=21 GID=[1204:0.1.7.93] [prompt]</div><div class="line">|       `-- Hit #22 : Id=22 GID=[1204:0.1.8.93] [prompt]</div><div class="line">`-- Bank &#39;SD&#39; : &quot;mctools::simulated_data&quot;</div><div class="line">    |-- Properties : &lt;empty&gt;</div><div class="line">    |   `-- &lt;no property&gt;</div><div class="line">    |-- Collection type : 1</div><div class="line">    |-- Collections of step hit handles :</div><div class="line">    |   |-- Category &#39;calo&#39; has 1 hit(s) [capacity=1]</div><div class="line">    |   `-- Category &#39;gg&#39; has 25 hit(s) [capacity=25]</div><div class="line">    |-- Primary event :</div><div class="line">    |   |-- Auxiliary properties: &lt;none&gt;</div><div class="line">    |   |-- Label : &#39;Se82.0nubb&#39;</div><div class="line">    |   |-- Time  : 0 ns</div><div class="line">    |   |-- Vertex  : &lt;none&gt;</div><div class="line">    |   |-- Particles: [2]</div><div class="line">    |   |   |-- Particle #0 :</div><div class="line">    |   |   |   |-- Generation Id  : &lt;none&gt;</div><div class="line">    |   |   |   |-- Type           : 3 (label=&#39;e-&#39;)</div><div class="line">    |   |   |   |-- PDG code       : &lt;none&gt;</div><div class="line">    |   |   |   |-- Mass           : 0.510999 MeV</div><div class="line">    |   |   |   |-- Charge         : -1 e</div><div class="line">    |   |   |   |-- Time           : 0 ns</div><div class="line">    |   |   |   |-- Kinetic energy : 1.1133 MeV</div><div class="line">    |   |   |   |-- Momentum       : (0.706726,-0.130119,-1.36412) MeV</div><div class="line">    |   |   |   |-- Vertex         : &lt;no vertex&gt;</div><div class="line">    |   |   |   |-- Auxiliary properties: &lt;none&gt;</div><div class="line">    |   |   |   `-- Valid          : 1</div><div class="line">    |   |   `-- Particle #1 :</div><div class="line">    |   |       |-- Generation Id  : &lt;none&gt;</div><div class="line">    |   |       |-- Type           : 3 (label=&#39;e-&#39;)</div><div class="line">    |   |       |-- PDG code       : &lt;none&gt;</div><div class="line">    |   |       |-- Mass           : 0.510999 MeV</div><div class="line">    |   |       |-- Charge         : -1 e</div><div class="line">    |   |       |-- Time           : 0 ns</div><div class="line">    |   |       |-- Kinetic energy : 1.8817 MeV</div><div class="line">    |   |       |-- Momentum       : (0.0921589,0.473499,2.28718) MeV</div><div class="line">    |   |       |-- Vertex         : &lt;no vertex&gt;</div><div class="line">    |   |       |-- Auxiliary properties: &lt;none&gt;</div><div class="line">    |   |       `-- Valid          : 1</div><div class="line">    |   |-- GENBB weight : 1</div><div class="line">    |   |-- Classification : &#39;2e0p0g0a0X&#39;</div><div class="line">    |   `-- Valid: 1</div><div class="line">    |-- Time : &lt;none&gt;</div><div class="line">    `-- Vertex : (-0.0225505,1697.97,182.097) mm</div><div class="line">...</div></div><!-- fragment --><p>We clearly see that a new <code>CD</code> bank (<em>calibrated data</em>) has been added to the event record. It contains two collections of hits, respectively <em>calorimeter</em> and <em>tracker</em> hits.</p>
<p>The <code>example-cd.brio</code> file output by <code>flreconstruct</code> and the pipeline script may be opened in <code>flvisualize</code> as before. Looking at the first event again, we can see additional rendering and information associated to the <code>CD</code> hits (as before, your output will differ due to different random number seeds used in <code>flsimulate</code>):</p>
<div class="image">
<img src="flr_qs_cd_event.png" alt="flr_qs_cd_event.png"/>
<div class="caption">
A calibrated simulated event</div></div>
<p>The superimposed white circles on top of the colored ones represent the calibrated tracker hits for which the drift radius and longitudinal position along the anode wire have been computed from the truth hits' timestamps. Here, there is only one calorimeter hit, the total deposited energy in the block and time of entering the scintillator block are also computed (with respect to the arbitrary decay time set by the simulation engine).</p>
<h2><a class="anchor" id="usingflreconstruct_trackfitalgo"></a>
How to run a tracking algorithm on simulated events </h2>
<p>Now we know how to perform the calibration step, we are interested in the reconstruction of electron tracks in the tracking chamber. For that we need additional processing on top of the <code>CD</code> bank which is now available in the event record.</p>
<p>The reconstruction of tracks associated to charged particles traversing the tracking chamber is a two step procedure:</p>
<ul>
<li>first the calibrated Geiger hits are clusterized in <em>tracker clusters</em>, using some special vicinity criteria,</li>
<li>then a fit is performed on each cluster to compute helix or line segments compatible with the Geiger hits.</li>
</ul>
<div class="image">
<img src="flr_track_fit.png" alt="flr_track_fit.png"/>
<div class="caption">
Track fitting procedure applied to calibrated events</div></div>
<p>We create a new <code>rec.conf</code> script with a custom <code>pipeline</code> inline module made of five consecutive modules. The first two perform the mock calibration as shown in the previous section. Then we use a new module <code>CATTrackerClusterizer</code> to run the clustering algorithm, followed by the <code>TrackFitting</code> module to run the line/helix fitting on the found clusters. As before, we add a dump module at the end of the pipeline to print each event to standard output.</p>
<p>As we now use modules implemented by dedicated Falaise plugins, we must explicitly provide a <code>flreconstruct.plugins</code> section with the list of plugins that must be dynamically loaded to allow the pipeline to work:</p>
<div class="fragment"><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line">[name=&quot;flreconstruct.plugins&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line">plugins : string[3] = &quot;Falaise_CAT&quot; \</div><div class="line">                      &quot;TrackFit&quot; \</div><div class="line">                      &quot;Falaise_TrackFit&quot;</div><div class="line"></div><div class="line">[name=&quot;pipeline&quot; type=&quot;dpp::chain_module&quot;]</div><div class="line">modules : string[5] = \</div><div class="line">  &quot;CalibrateTracker&quot; \</div><div class="line">  &quot;CalibrateCalorimeters&quot; \</div><div class="line">  &quot;CATTrackerClusterizer&quot; \</div><div class="line">  &quot;TrackFitting&quot; \</div><div class="line">  &quot;Dump&quot;</div><div class="line"></div><div class="line">[name=&quot;CalibrateTracker&quot; type=&quot;snemo::processing::mock_tracker_s2c_module&quot;]</div><div class="line"></div><div class="line">[name=&quot;CalibrateCalorimeters&quot; type=&quot;snemo::processing::mock_calorimeter_s2c_module&quot;]</div><div class="line"></div><div class="line">[name=&quot;CATTrackerClusterizer&quot; type=&quot;snemo::reconstruction::cat_tracker_clustering_module&quot;]</div><div class="line">TPC.processing_prompt_hits  : boolean = true</div><div class="line">TPC.processing_delayed_hits : boolean = false</div><div class="line"></div><div class="line">[name=&quot;TrackFitting&quot; type=&quot;snemo::reconstruction::trackfit_tracker_fitting_module&quot;]</div><div class="line">fitting_models   : string[2] = &quot;helix&quot; &quot;line&quot;</div><div class="line">line.only_guess  : string[4] = &quot;BB&quot; &quot;BT&quot; &quot;TB&quot; &quot;TT&quot;</div><div class="line">helix.only_guess : string[8] = &quot;BBB&quot; &quot;BBT&quot; &quot;BTB&quot; &quot;BTT&quot; &quot;TBB&quot; &quot;TBT&quot; &quot;TTB&quot; &quot;TTT&quot;</div><div class="line"></div><div class="line">[name=&quot;Dump&quot; type=&quot;dpp::dump_module&quot;]</div></div><!-- fragment --><p>We run: </p><div class="fragment"><div class="line">$ flreconstruct -i example.brio -p rec.conf -o example-rec.brio</div><div class="line">[notice:void datatools::library_loader::init():449] Automatic loading of library &#39;Falaise_CAT&#39;...</div><div class="line">[notice:void datatools::library_loader::init():449] Automatic loading of library &#39;TrackFit&#39;...</div><div class="line">[notice:void datatools::library_loader::init():449] Automatic loading of library &#39;Falaise_TrackFit&#39;...</div><div class="line">...</div><div class="line">|-- Bank &#39;CD&#39; : &quot;snemo::datamodel::calibrated_data&quot;</div><div class="line">:   ...</div><div class="line">|-- Bank &#39;SD&#39; : &quot;mctools::simulated_data&quot;</div><div class="line">:   ...</div><div class="line">|-- Bank &#39;TCD&#39; : &quot;snemo::datamodel::tracker_clustering_data&quot;</div><div class="line">:   ...</div><div class="line">`-- Bank &#39;TTD&#39; : &quot;snemo::datamodel::tracker_trajectory_data&quot;</div><div class="line">    ...</div></div><!-- fragment --><p>Now two banks have been added in the event records:</p><ul>
<li><code>TCD</code> : the <em>tracker clustering data</em> contains the result of the tracker hit clusterization with one or several solutions, each containing a collection of candidate clusters of hit cells. These clusters are used as the input of the track fitting algorithm</li>
<li><code>TTD</code> : the <em>tracker trajectory data</em> contains the result of the tracker fitting with one or several solutions, each containing a collection of candidate fitted tracks (helix or line).</li>
</ul>
<p>The display shows the best found clusterization/fitting solutions with two clusters of tracker hits (red and blue) and the best associated tracks that have been computed from these clusters. We clearly recognize a two electrons event pattern, but here only one is associated to a calorimeter block.</p>
<div class="image">
<img src="flr_qs_trackfit_event.png" alt="flr_qs_trackfit_event.png"/>
<div class="caption">
A simulated event with reconstructed tracker clusters and fitted tracks</div></div>
<h2><a class="anchor" id="usingflreconstruct_todo"></a>
To do </h2>
<p>Document more reconstruction steps:</p>
<ul>
<li>charged particle tracking module with extrapolation of vertex, impact points, curvature, track/calorimeter association...</li>
<li>gamma tracking</li>
<li>particle identification</li>
</ul>
<h2><a class="anchor" id="usingflreconstruct_scriptingflsimulate_sectionsandparameters"></a>
Supported sections and parameters in FLReconstruct scripts </h2>
<p>The FLReconstruct script contains up to five sections of type <code>flreconstruct::section</code> with the following names:</p>
<ul>
<li><code>flreconstruct</code> : this is the system/base section where to set general parameters such as:<ul>
<li><code>numberOfEvents</code> : the number of events to be processed from the input (integer, optional, default is: <code>0</code> which means <em>all</em> events will be processed),</li>
<li><code>experimentalSetupUrn</code> : the experimental setup tag (default is: <code>urn:snemo:demonstrator:setup:1.0</code>),</li>
</ul>
</li>
<li><p class="startli"><code>flreconstruct.variantService</code> : this is the <em>variants</em> section where the Bayeux <em>variant service</em> dedicated to the management of variant parameters and configurations is configured. In principle, this section inherits the configuration of the variant service used to generate simulated data.</p>
<p class="startli">Parameters of interest are:</p><ul>
<li><code>configUrn</code> : the configuration tag for the variant service associated to the simulation setup (string, optional). If not set, it is automatically resolved from the experiment setup tag.</li>
<li><code>config</code> : the path to the main configuration file for the variant service associated to the simulation setup (string/path, optional). If not set, it is automatically resolved from the <code>configUrn</code> tag.</li>
<li><code>profileUrn</code> : the configuration tag for the variant profile chosen by the user to perform the simulation (string, optional). If not set, it may be automatically resolved from the <code>configUrn</code> tag if the variant configuration has a registered default profile.</li>
<li><code>profile</code> : the path to the variant profile chosen by the user to perform the simulation (string/path,optional). If not set, it is automatically resolved from the <code>profileUrn</code> tag or from input metadata.</li>
<li><code>settings</code> : a list of explicit setting for variant parameters chosen by the user to perform the simulation (array of strings, optional). If not set, it is automatically resolved from the <code>profileUrn</code> tag or from input metadata.</li>
</ul>
</li>
<li><p class="startli"><code>flreconstruct.services</code> : this is the <em>services</em> section where explicit configuration for the embedded Bayeux/datatools <em>service manager</em> is defined (by tag or explicit configuration file).</p>
<p class="startli">Parameters of interest are:</p><ul>
<li><code>configUrn</code> : the configuration tag for the service manager associated to the data producer setup (string, optional). If not set, it is automatically resolved from the experimental setup tag.</li>
<li><code>config</code> : the path to the main configuration file for the service manager service associated to the reconstrcution setup (string/path, optional). If not set, it is automatically resolved from the <code>configUrn</code> tag.</li>
</ul>
</li>
<li><p class="startli"><code>flreconstruct.plugins</code> : this is the <em>plugins</em> section where explicit directives are defined to load Falaise plugin libraries which define various types (classes) of processing modules.</p>
<p class="startli">Parameters of interest are:</p><ul>
<li><code>plugins</code> : the list of plugins to be loaded.</li>
<li><code>PLUGIN_NAME.directory</code> : the directory from where the plugin dynamic library named <code>PLUGIN_NAME</code> should be loaded (default: "@falaise.plugins:", i.e. the standard location for the installation of Falaise's plugins).</li>
</ul>
</li>
<li><p class="startli"><code>flreconstruct.pipeline</code> : this is the <em>pipeline</em> section where general setup of the reconstruction pipeline is provided.</p>
<p class="startli">Parameters of interest are:</p><ul>
<li><code>configUrn</code> : the tag of a registered/official pipeline.</li>
<li><code>config</code> : the main configuration file describing the modules used along the pipeline. If not set, it is automatically resolved from the <code>configUrn</code> tag.</li>
<li><code>module</code> : the name of the top level pipeline module, chosen from the list of modules defined in the main configuration file (default: <code>"pipeline"</code>).</li>
</ul>
</li>
</ul>
<p>A sample configuration script showing the organisation of the above parameters is shown below. Note that many of the parameters are commented out as they are generally note needed except for advanced use or testing.</p>
<div class="fragment"><div class="line"># Author: F. Mauger &lt;mauger@lpccaen.in2p3.fr&gt;</div><div class="line"># Date:   2017-03-27</div><div class="line"># Format: datatools::multi_properties</div><div class="line"># Description: Sample configuration script for flreconstruct (Falaise 3.0.0)</div><div class="line"># Supports: SuperNEMO Demonstrator Reconstruction setup using version 1.0.0 of the pipeline</div><div class="line"></div><div class="line"></div><div class="line">#@description Sample SuperNEMO Demonstrator Reconstruction Pipeline</div><div class="line">#@key_label  &quot;name&quot;</div><div class="line">#@meta_label &quot;type&quot;</div><div class="line"></div><div class="line"></div><div class="line">####################################################</div><div class="line">[name=&quot;flreconstruct&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line">#@config Basic setup</div><div class="line"></div><div class="line"># #@description Reconstruction version (automatic: extracted from input metadata)</div><div class="line"># experimentalSetupUrn : string = &quot;urn:snemo:demonstrator:setup:1.0&quot;</div><div class="line"></div><div class="line"># #@description Number of events to reconstruct (default: 0 = no limit)</div><div class="line"># numberOfEvents : integer = 0</div><div class="line"></div><div class="line"></div><div class="line">###################################################################</div><div class="line">[name=&quot;flreconstruct.variantService&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line">#@config Variant setup</div><div class="line"></div><div class="line"># #@description Variant configuration URN (automatic: extracted from &#39;experimentalSetupUrn&#39;)</div><div class="line"># configUrn : string as path = &quot;urn:snemo:demonstrator:setup:1.0:variants&quot;</div><div class="line"></div><div class="line"># #@description Variant configuration (automatic: resolved from &#39;configUrn&#39;)</div><div class="line"># config : string as path = &quot;@falaise:config/snemo/demonstrator/setup/1.0/variants/repository.conf&quot;</div><div class="line"></div><div class="line"># #@description Input variant profile configuration file (automatic: default from &#39;configUrn&#39;)</div><div class="line"># profileUrn : string = &quot;urn:snemo:demonstrator:setup:1.0:variants:profiles:default&quot;</div><div class="line"></div><div class="line"># #@description Input variant profile configuration file (automatic: resolved from &#39;profileUrn&#39;)</div><div class="line"># profile : string as path = &quot;@falaise:config/snemo/demonstrator/geometry/4.0/variants/profiles/basic-1.0.0.profile&quot;</div><div class="line"></div><div class="line"></div><div class="line">#############################################################</div><div class="line">[name=&quot;flreconstruct.services&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line">#@config Services setup</div><div class="line"></div><div class="line"># #@description Service manager configuration URN (automatic: extracted from &#39;experimentalSetupUrn&#39;)</div><div class="line"># configUrn : string = &quot;urn:snemo:demonstrator:setup:1.0:services&quot;</div><div class="line"></div><div class="line"># #@description Service manager configuration file (automatic: resolved from &#39;configUrn&#39;)</div><div class="line"># config : string as path = &quot;@falaise:config/snemo/demonstrator/setup/1.0/services.conf&quot;</div><div class="line"></div><div class="line"></div><div class="line">############################################################</div><div class="line">[name=&quot;flreconstruct.plugins&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line">#@config Plugin managment</div><div class="line"></div><div class="line">#@description The list of plugins</div><div class="line">plugins : string[4] = &quot;Falaise_CAT&quot;                     \</div><div class="line">                      &quot;TrackFit&quot;                        \</div><div class="line">                      &quot;Falaise_TrackFit&quot;                \</div><div class="line">                      &quot;Falaise_ChargedParticleTracking&quot;</div><div class="line"></div><div class="line"># Adapt this path to the location of Falaise_ChargedParticleTracking if needed.</div><div class="line"># Default path for Falaise plugins is &quot;@falaise.plugins:&quot;</div><div class="line"># #@description The path from where to load the Falaise_ChargedParticleTracking plugin</div><div class="line"># Falaise_ChargedParticleTracking.directory : string = &quot;@falaise.plugins:&quot;</div><div class="line"></div><div class="line"></div><div class="line">#############################################################</div><div class="line">[name=&quot;flreconstruct.pipeline&quot; type=&quot;flreconstruct::section&quot;]</div><div class="line">#@config Pipeline modules configuration</div><div class="line"></div><div class="line">#@description Tag of the reconstruction (registered)</div><div class="line">configUrn : string = &quot;urn:snemo:demonstrator:reconstruction:1.0.0:pipeline&quot;</div><div class="line"></div><div class="line"># #@description File containing a list of modules for the pipeline (automatically resolved)</div><div class="line"># config : string as path = &quot;@falaise:config/snemo/demonstrator/reconstruction/pipeline/1.0.0/modules.defs&quot;</div><div class="line"></div><div class="line"># # Can also be set manually to a local file:</div><div class="line"># config : string as path = &quot;pipeline_modules.defs&quot;</div><div class="line"></div><div class="line"># #@description The name of the top module in the pipeline (default=&quot;pipeline&quot;)</div><div class="line"># module : string = &quot;pipeline&quot;</div><div class="line"></div><div class="line"></div><div class="line"># end</div></div><!-- fragment --><p>The majority of scripts will just use the <code>flreconstruct.plugins</code> and <code>flreconstruct.pipeline</code> sections to select from the set of plugins and pipelines approved by the Calibration and Reconstruction Working Group. Output results from these can be used in the preparation of analyses.</p>
<h2><a class="anchor" id="usingflreconstruct_scriptingflsimulate_inlinemodules"></a>
Inline modules </h2>
<p>In the case the <code>flreconstruct.pipeline</code> section does not define an explicit pipeline configuration by tag (<code>configUrn</code>) or configuration file path (<code>config</code>), it is possible to provide a list of additional sections which define reconstruction modules. This technique is named the <em>inline</em> pipeline mode. Such a section uses the following format:</p>
<div class="fragment"><div class="line">[name=&quot;ModuleName&quot; type=&quot;ModuleType&quot;]</div><div class="line"></div><div class="line">... module&#39;s configuration parameters ...</div></div><!-- fragment --><p>where <code>ModuleName</code> is the unique name of the module and <code>ModuleType</code> is the identifier of its registered class type (see below).</p>
<p>This mode should not be used for production runs. It is expected that only official registered pipeline setups are used in such a case, through the <code>configUrn</code> properties in the <code>flreconstruct.pipeline</code> section. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
